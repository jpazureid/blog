<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure Identity Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。</subtitle>
  <link href="https://jpazureid.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpazureid.github.io/blog/"/>
  <updated>2024-03-15T02:00:17.639Z</updated>
  <id>https://jpazureid.github.io/blog/</id>
  
  <author>
    <name>Azure Identity Support Japan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>RM64-FSZ 従来の管理者ロールの廃止に関するよくある質問</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/rm64-fsz-info/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/rm64-fsz-info/</id>
    <published>2024-03-15T06:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.639Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure ID チームの小出です。</p><p>2024/3/12 にかけて、RM64-FSZ の通知や「Action required: Transition from Azure classic administrator roles to RBAC roles 」の件名にて、従来の管理者ロールの廃止についてメール通知が行われ、この廃止に関する内容について多くのお問い合わせをいただいております。</p><p>そこで今回は、本廃止に関する概要と対応について、よくある質問形式でおまとめして紹介します。</p><div class="alert is-important"><p class="alert-title">重要</p><p></p><p>本情報は 2024/3/14 時点の情報を基に執筆しております。最新情報は Azure ポータル上の RM64-FSZ の通知や新たなアナウンスも合わせてご確認ください。本記事でも追加情報があり次第、順次追記いたします。</p></div><h2 id="廃止の概要と実施いただきたいこと"><a href="#廃止の概要と実施いただきたいこと" class="headerlink" title="廃止の概要と実施いただきたいこと"></a>廃止の概要と実施いただきたいこと</h2><p>この件名のメールは、 Azure クラシック リソースの廃止に伴い、2024/8/31 に Azure の「従来の管理者ロール」が廃止され、 RBAC への移行が必要となる点についてご案内しています。<br>また、 4/3 以降は Azure ポータルから新たに共同管理者（廃止予定のロール）を追加することができなくなる点を追加でご案内しています。</p><p>今回の通知内容（従来の管理者の廃止）に関して、お客様側に確認いただきたい点は「共同管理者やサービス管理者など、従来の管理者を利用しているユーザーがいるかどうか」という点です。<br>RBAC のアクセス制御画面より、「従来の管理者」タブを確認することで、現時点で従来の管理者ロールを保有しているユーザー一覧が表示されますので、まずは下記画面にて登録状況をご確認くださいませ。</p><p><img src="/blog/azure-active-directory/rm64-fsz-info/rm64-fsz-info1.png"></p><p>なお、もしこちらの画面にサービス管理者や共同管理者を持つユーザーが表示されている場合、 8/31 以降は利用ができなくなります。<br>サービス管理者や共同管理者は、 Azure RBAC の「所有者」と同等のアクセス権を保有していますので、<br>もし従来の管理者を利用している場合には、 8/31 の期日より前に余裕をもって適切なユーザーに RBAC の所有者割り当てを追加してください。<br>RBAC 割り当て手順につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/quickstart-assign-role-user-portal#grant-access">公開情報</a> にてご案内しておりますので、併せてご確認ください。</p><h2 id="よくある質問"><a href="#よくある質問" class="headerlink" title="よくある質問"></a>よくある質問</h2><p><strong>Q. 「従来の管理者」とは何ですか？</strong></p><p>A. <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/rbac-and-directory-admin-roles#classic-subscription-administrator-roles">こちら</a> に記載されている、アカウント管理者・サービス管理者・共同管理者の 3 つです。後述のクラシック リソースを管理するために使われていたロールです。<br>アカウント管理者とサービス管理者は、アカウントごと・サブスクリプションごとに 1 人登録されており、サブスクリプションのプロパティ画面から確認できます。</p><p><img src="/blog/azure-active-directory/rm64-fsz-info/rm64-fsz-info2.png"></p><p><strong>Q. 今回廃止対象となるロールはどれですか？</strong></p><p>A. サービス管理者と共同管理者については、通知内にて RBAC へ移行するよう案内されておりますため、この 2 つのロールについては対処が必要です。</p><p><strong>Q. 4/3 以降共同管理者を追加できなくなるとは具体的にどういうことですか？</strong></p><p>A. 共同管理者は、サブスクリプションごとに最大 200 名まで追加することができます。このため、RBAC の追加と同様に、「共同管理者の追加」ボタンから追加することができますが、廃止に先立ち、4/3 以降はこの画面から割り当てを追加することができなくなります。</p><p><img src="/blog/azure-active-directory/rm64-fsz-info/rm64-fsz-info3.png"></p><p><strong>Q. <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/classic-administrators">公開情報</a> には共同管理者に関する記載のみのように見えますが、サービス管理者についても対応が必要ですか？</strong></p><p>A. はい、本通知では、サービス管理者についても RBAC への移行が必要です。<br>廃止後もサブスクリプションへのアクセスができるよう、共同管理者と同様に「RBAC の所有者ロールを追加する」操作を実施してください。</p><p><strong>Q. 共同管理者については削除すればよいと分かりましたが、サービス管理者も削除する必要はありますか？</strong></p><p>A. サービス管理者単体では、8/31 以降サブスクリプションの管理ができなくなるため、上記の通り「RBAC の所有者ロールを割り当てる」操作を実施してください。削除については任意ですが、必要に応じて共同管理者と同様に削除することをご検討ください。</p><p>なお、共同管理者と同様に削除可能な動作を確認していますので、技術的にサービス管理者の削除は可能ですが、サブスクリプションが孤立（誰も操作できなくなる）状態にならないよう、すべての操作が可能な所有者ロールを持つユーザーがいる状態で適宜サービス管理者の削除を実施ください。手順の詳細は <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/classic-administrators">こちらの公開情報</a> も併せてご確認ください。</p><p><strong>Q. サービス管理者と共同管理者はどこから削除できますか？</strong></p><p>A. Azure サブスクリプションの [アクセス制御（IAM）] （RBAC を付与するときの画面）を開き、「従来の管理者」タブから確認できます。ユーザーが表示されている場合は、削除したいユーザーにチェックを入れて画面上部の「削除」をクリックします。</p><p><img src="/blog/azure-active-directory/rm64-fsz-info/rm64-fsz-info4.png"></p><p><strong>Q. サービス管理者を削除したら、プロパティ画面で「サービス管理者：利用できません」と表示されるようになりました。また、「従来の管理者」メニューにも表示されなくなりました。しかし、確認したところまだクラシック リソースを管理する必要があったので元に戻したいです。どうしたらいいですか？</strong></p><p>A. アカウント管理者に登録されているユーザーであれば、 4/3 まではサービス管理者を指定することができます。アカウント管理者でサインインのうえ、下記「サービス管理者の変更」ボタンからサービス管理者を再度指定してください。 4/3 以降は追加ができないため、ご注意ください。</p><p><img src="/blog/azure-active-directory/rm64-fsz-info/rm64-fsz-info5.png"></p><p><strong>Q. 所有者ロールは特権が高いので割り当てたくありません。どうすればいいですか。</strong></p><p>A. サブスクリプションに誰もアクセスできなくなってしまうことを防ぐため、すべての操作が可能な所有者ロールを数名割り当てることを強くお勧めします。それ以外のユーザーについては、必ずしも所有者ロールでなくても、ユーザーに実施させたい操作を元に必要なロールを割り当てれば問題ありません。</p><p>念のため、ロールを変更した後ユーザーが操作したい内容が問題なく実行できるか事前に確認のうえで RBAC への切り替えをご実施ください。詳細は<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/classic-administrators">こちらの公開情報</a> も併せてご確認ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは！ Azure ID チームの小出です。&lt;/p&gt;
&lt;p&gt;2024/3/12 にかけて、RM64-FSZ の通知や「Action required: Transition from Azure classic administrator roles to RBAC </summary>
      
    
    
    
    
    <category term="Role Management" scheme="https://jpazureid.github.io/blog/tags/Role-Management/"/>
    
  </entry>
  
  <entry>
    <title>MC705680 (2024/1/10 公開) の通知内容の説明</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/mc705680-20240110/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/mc705680-20240110/</id>
    <published>2024-03-11T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.451Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの金森です。</p><p>2024 年 1 月 10 日に、メッセージ センターにて [MC705680] として以下の情報公開が行われています。</p><blockquote><p>[!Note]<br>2024 年 3 月 3 日に When will this happen: の説明が更新されました。<br>当初は 2 月 15 日にクラウド側の変更が行われる予定でしたが、ご利用者様のクライアントへの修正適用の準備期間を踏まえて、変更予定を延長していました。<br>3 月 3 日の週からクラウド側の展開を開始し、4 月末までにはすべてのお客様のテナントに展開が完了する予定です。</p></blockquote><hr><p><strong>Action required: Security hardening of Windows Hello authentication with July 2023 Windows updates</strong><br>[Updated March 3, 2024]: Starting this week, the change described in this article will begin a gradual roll out. It will reach all customers by end of April. </p><p>Windows updates released on July 11, 2023 introduced a phased approach to address a vulnerability in the Microsoft Entra ID Windows Hello authentication stack <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-36871">CVE-2023-36871</a> that could enable an attacker to create long lived authentication artifact from a low privileged process on Entra ID joined machines. This would enable the attacker to move the artifact indefinitely onto other Entra ID joined machines.<br>To address this vulnerability, Microsoft has introduced protections starting with the July 11, 2023 security updates. We strongly recommend that you update your organization’s devices immediately with Windows updates release in July 2023 or later.<br>Microsoft plans to fully address this CVE by not accepting Windows Hello authentication requests from machines running Windows security updates released in June 2023 or before. This security hardening will start February 15th, 2024 and will affect authentication/Single Sign On (SSO) on Windows devices that have not been updated with updates released in July 2023 or later.</p><p>[When will this happen:]<br><del>This security hardening will start on February 15th, 2024.</del><br><span style="color: red; ">Server-side changes for this security hardening are beginning to roll out starting with the week of March 3, 2024. The new measure is expected to affect 10% of customers by the end of the first week of March, and should reach all customers by the end of April.</p><p>This security hardening was originally scheduled to start on February, 2024, but was postponed to allow more time for organizations to install the necessary updates for this change.</span></p><p>[How this will affect your organization:]<br>This security hardening will impact Windows Hello authentication/Single Sign On (SSO).</p><p>[What you need to do to prepare:]<br>We strongly recommend that you update immediately your organization’s devices with Windows security updates release in July 2023 or later. Your organization will be at risk of business disruption, and IT administrators are encouraged to take action and install the necessary updates as soon as possible.</p><p>[Additional information:]<br>If you have Active Directory Federation Services (ADFS) in your environment, please see <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-36871">CVE-2023-36871 - Security Update Guide - Microsoft - Azure Active Directory Security Feature Bypass Vulnerability</a> to protect your on premises/Enterprise authentication scenarios as well.</p><hr><p>サマライズすると以下の主旨となります。</p><ul><li>Windows Hello for Business (WHfB) のセキュリティの脆弱性が確認されている</li><li>この脆弱性に対して、<strong>2023 年 7 月の月例のセキュリティ修正にて、すでに Windows に対しては修正の提供済みであり、修正を適用することで脆弱性のリスクは解消される</strong></li><li>上記の対処はクライアント視点でのアプローチであるものの、この脆弱性リスクに対して完全に対応できるよう、認証の要求先/トークンの発行を行う Microsoft Entra ID (ME-ID = Azure AD) 側でも対処を実施する</li><li><strong>2024 年 3 月 3 日</strong> (<span style="color: red; ">こちら 2 月 15 日から延長しています</span>) から、”2023 年 7 月の月例修正を適用していない” クライアントからの、WHfB によるトークン発行要求を受け入れない対処を実施する</li><li>AD FS を利用している環境では、AD FS サーバーに対しても修正の適用と設定の追加を行う必要がある</li></ul><p>おそらく多くの方がすでに 2023 年 7 月の月例修正を適用済みの環境でご利用いただいているものと思いますが、この修正を適用済みの場合すでにリスクは解消されており、それ以上クライアントにて何らかの対処を行う必要はないのでご安心ください。<br>メッセージ センターの通知文章より不安を感じられた方もいらっしゃるかもしれませんが、QA 形式で詳細をおまとめいたしますので、不安の解消の一助となりましたら幸いです。</p><p><strong>Q.</strong> MC705680 の通知内容の動作変化が生じるのはいつからでしょうか。<br><strong>A.</strong> 2024 年 3 月 3 日から展開が開始され 4 月末にかけてすべてのテナントで展開が行われます。</p><p><strong>Q.</strong> 詳細な動作変更対象の前提情報を教えてください。<br><strong>A.</strong> Microsoft Entra 参加 (旧名 Azure AD Join) もしくは Microsoft Entra ハイブリッド参加 (旧名 Hybrid Azure AD Join) 構成の Windows 10 / 11 クライアントにて、Windows Hello for Business (WHfB) を構成しており、Windows に WHfB の方法 (PIN や生体認証) でログオンしている環境が対象です。<br>以下の環境は考慮の対象外となります。</p><ul><li>WHfB ではなく Windows Hello の構成</li><li>WHfB は構成済みであるが、Windows へのログオンを PIN や生体認証ではなくパスワードで実行している</li></ul><p><strong>Q.</strong> どのような動作変化が生じるでしょうか。<br><strong>A.</strong> 2023 年 7 月 11 日の月例修正が適用されていない場合、Windows ログオン時に WHfB の方法 (PIN や生態認証) でログオンすると [Windows ログオンに伴う PRT (Primary Refresh Token) の取得もしくは更新] が行えなくなります。<br>なお、Windows へのログオン自体が行えなくなる、ということは無く、ログオンとデスクトップの表示は変わらず行えます (PRT の取得 / 更新が行えなくなる、という影響のみとなります)。</p><p>この結果、デスクトップ上で PRT の利用が行えなくなり、PRT を用いた SSO (ブラウザやアプリ利用時に、ユーザー名/パスワードの入力を必要とせずサインインが完了する) が行えなくなり、合わせて以下のような状況が生じる可能性があります。</p><ul><li>SSO が行われなくなり、Microsoft Entra ID (ME-ID = Azure AD) のユーザー認証を対話的に求める認証画面が表示される</li><li>(条件付きアクセスにてデバイス ベースのアクセス制御を行っている場合) ME-ID へのサインインがブロックされる</li></ul><p>2023 年 7 月 11 日の月例修正が適用済みの Windows 10 / 11 クライアントでは、上記の動作が生じることなく、これまで通り PRT の取得 / 更新と利用が可能です。</p><p><strong>Q.</strong> 具体的に適用しておくべき修正を教えてください。<br><strong>A.</strong> 以下の技術情報の [セキュリティ更新プログラム] の項目にて公開しておりますので、ご参照ください。</p><p><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-36871">Azure Active Directory のセキュリティ機能のバイパスの脆弱性</a><br>※ [よく寄せられる質問] の項目には “7 月 12 日以降にリリースされた Windows 更新プログラム” と記載がありますが、[セキュリティ更新プログラム] の項目にある対象修正は 7 月 11 日にリリースされており、こちらの修正が本問題を修正した KB となります。</p><p>なお、月例修正は累積型であるため、もし [2023 年 7 月の修正は適用していないが、2024 年 1 月の月例修正は適用済みである] 場合、すでに必要な更新は適用済みのクライアントとなり、改めて後から 2023 年 7 月の修正を適用する必要はありません。<br>現在のクライアントの OS バージョン (ファイル名を指定して実行、より winver を実行した画面から確認可能) と、上記技術情報のセキュリティ更新プログラムの一覧を比較し、より新しい OS バージョンとなっている場合は追加で行うべき対処はありません。</p><p><strong>Q.</strong> 2023 年 7 月の修正が適用されていない状態のまま、本動作変更を避ける方法はありますか。<br><strong>A.</strong> <strong>いいえ、セキュリティの脆弱性に対するアップデートであり、セキュリティ修正を適用しない状態のまま (脆弱性のリスクを維持したまま) でこれまでの運用を継続する方法はございません。</strong><br>なお、本脆弱性は Windows に WHfB でログオンするご利用シナリオが対象となり、Windows にパスワードでログオンするご利用シナリオは考慮の対象外となります。</p><p><strong>Q.</strong> WHfB は利用していませんが、AD FS サーバーを運用上利用している場合はどうすれば良いのでしょうか。<br><strong>A.</strong> 前述の脆弱性の技術情報の [よく寄せられる質問] の項目にて公開しておりますので、ご参照ください。</p><p>上記内容が皆様の参考となりますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの金森です。&lt;/p&gt;
&lt;p&gt;2024 年 1 月 10 日に、メッセージ センターにて [MC705680] として以下の情報公開が行われています。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[!Note]</summary>
      
    
    
    
    
    <category term="Microsoft Entra" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Entra/"/>
    
    <category term="Windows Hello for Business" scheme="https://jpazureid.github.io/blog/tags/Windows-Hello-for-Business/"/>
    
    <category term="Device" scheme="https://jpazureid.github.io/blog/tags/Device/"/>
    
  </entry>
  
  <entry>
    <title>ワークロード ID を利用した Azure PowerShell モジュールにおける認証のご紹介</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/credentials-for-psscripts/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/credentials-for-psscripts/</id>
    <published>2024-03-07T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.243Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの栗井です。</p><p>Microsoft Azure の各種リソース操作や情報取得を行う方法として、多くのお客様に、各種 PowerShell モジュール (Az PowerShell, Microsoft Graph PowerShell SDK、Azure CLI etc…) をご利用いただいています！</p><p>よくある活用例の 1 つとして、自動実行を目的としたスクリプト ファイルの作成が挙げられます。ここで課題となるのが、認証用のコマンドにどのようにして資格情報を渡すかという点です。いずれの PowerShell モジュールも、最初に認証コマンドを実行しアクセス トークンの取得が必要です。例えば Microsoft Graph PowerShell SDK の認証用コマンド “Connect-MgGraph” では、引数無しで実行すると、以下のようにユーザー認証画面が表示されます。しかし自動実行を想定したスクリプトの場合、ユーザーによるサインイン操作が発生することは不都合です。</p><p><img src="/blog/azure-active-directory/credentials-for-psscripts/popup.png"> </p><p>こんなシナリオの解決策としては、ワークロード ID の活用が最適です！</p><h2 id="ワークロード-ID-ってなに"><a href="#ワークロード-ID-ってなに" class="headerlink" title="ワークロード ID ってなに ?"></a>ワークロード ID ってなに ?</h2><p>ワークロード ID は、ソフトウェア (スクリプト、アプリケーション、サービス、スクリプト、コンテナーなど) に割り当てる ID です。ユーザーに払い出す人間用の ID ではなく、システムやソフトウェア用に払い出す ID とお考えください。Microsoft Entra では、ワークロード ID はアプリケーション (サービス プリンシパル) やマネージド ID を表します。</p><h3 id="アプリケーション-サービス-プリンシパル-オブジェクト"><a href="#アプリケーション-サービス-プリンシパル-オブジェクト" class="headerlink" title="アプリケーション (サービス プリンシパル) オブジェクト"></a>アプリケーション (サービス プリンシパル) オブジェクト</h3><p>アプリケーション (サービス プリンシパル) オブジェクトは、Azure における「アプリケーションを表すアカウント」のような存在です。アプリケーション (サービス プリンシパル) オブジェクトは、アプリケーションとしての ID (Client ID) に加えて資格情報 (クライアント シークレット文字列、もしくは証明書) を保有でき、これらの資格情報を利用して Microsoft Entra ID に認証します。アプリケーション (サービス プリンシパル) オブジェクトは、Azure に接続できる環境であればどこからでも利用することが可能です。</p><h3 id="マネージド-ID"><a href="#マネージド-ID" class="headerlink" title="マネージド ID"></a>マネージド ID</h3><p>マネージド ID もアプリケーション (サービス プリンシパル) オブジェクトに非常に似ていますが、「”Azure リソース専用” のアプリケーション アカウント」とお考えください。アプリケーション (サービス プリンシパル) オブジェクトとの大きな差異としては以下の 2 点が挙げられます。</p><ul><li>マネージド ID は Azure 上のリソース (Azure VM や WebApp など) でのみ利用が可能</li><li>利用者がマネージド ID の資格情報を管理する必要がない</li></ul><p>マネージド ID では、Azure 内部のエンドポイントで Azure リソースに紐づいた ID として Microsoft Entra ID の認証処理を行います。利用者は、Azure 上のリソース (Azure VM や WebApp など) を作成すれば、この ID をすぐに利用でき、資格情報の管理 (有効期限に応じた更新、資格情報漏洩の対策など) が不要という大きなメリットがあります。</p><p>マネージド ID の利用をサポートする Azure リソースについては、以下の公開情報をご参照ください。<br><a href="https://learn.microsoft.com/ja-jp/entra/identity/managed-identities-azure-resources/managed-identities-status">マネージド ID を使用して他のサービスにアクセスできる Azure サービス (learn.microsoft.com)</a></p><h2 id="アプリケーション-サービス-プリンシパル-オブジェクトのシークレット-証明書とマネージド-ID-のどれを使えばいい？"><a href="#アプリケーション-サービス-プリンシパル-オブジェクトのシークレット-証明書とマネージド-ID-のどれを使えばいい？" class="headerlink" title="アプリケーション (サービス プリンシパル) オブジェクトのシークレット/証明書とマネージド ID のどれを使えばいい？"></a>アプリケーション (サービス プリンシパル) オブジェクトのシークレット/証明書とマネージド ID のどれを使えばいい？</h2><p>それでは、実際に PowerShell スクリプトを実装する際には、以下のうちどの認証方法を選べばいいのでしょうか？</p><ol><li>アプリケーション (サービス プリンシパル) - クライアント シークレットによる認証</li><li>アプリケーション (サービス プリンシパル) - 証明書による認証</li><li>マネージド ID </li></ol><p>マネージド ID が利用可能なシナリオ (= コマンド実行元がマネージド ID に対応した Azure リソース) である場合は、マネージド ID のご利用が最もおすすめです。</p><p>上述のとおり、マネージド ID では資格情報の管理が不要という大きなメリットがあります。そして、管理者側で予めマネージド ID を有効化した Azure リソース上でのみ認証が可能であるため、外部のシステムによる ID の不正利用ができないというセキュリティ面での利点もあります。</p><p>マネージド ID が利用できないシナリオでは、次点でアプリケーション (サービス プリンシパル) の資格情報として証明書を利用することがおすすめです。証明書の利用が難しい場合には、クライアント シークレットを利用した方法を検討します。クライアント シークレットを利用する場合、資格情報の取り扱いに十分ご注意ください。マネージド ID ではなくアプリケーション (サービス プリンシパル) を利用する場合、必要に応じて、後述の「ワークロード ID 用の条件付きアクセス」もぜひご活用ください。</p><h2 id="アプリケーション-サービス-プリンシパル-およびマネージド-ID-を使った認証コマンド"><a href="#アプリケーション-サービス-プリンシパル-およびマネージド-ID-を使った認証コマンド" class="headerlink" title="アプリケーション (サービス プリンシパル) およびマネージド ID を使った認証コマンド"></a>アプリケーション (サービス プリンシパル) およびマネージド ID を使った認証コマンド</h2><p>以下ではまず、もっともお勧めするマネージド ID を利用した方法についてお知らせします。続いて、アプリケーション (サービス プリンシパル) を利用した認証方法についてもおまとめします。</p><h3 id="マネージド-ID-の場合"><a href="#マネージド-ID-の場合" class="headerlink" title="マネージド ID の場合"></a>マネージド ID の場合</h3><p>ここでは以下のシナリオを、一例として紹介します。</p><ul><li>Microsoft Graph PowerShell SDK の認証用コマンド “Connect-MgGraph” を自動で実行したい。</li><li>実行元は Azure VM (Windows) 上の PowerShell である。</li></ul><p>Azure VM はマネージド ID に対応した Azure リソースです。かつ、Connect-MgGraph コマンドもマネージド ID に対応しています。そのため、Azure VM 上で Microsoft Graph PowerShell SDK を利用するシナリオではマネージド ID を利用した認証が可能です。マネージド ID には「システム割り当て マネージド ID」と「ユーザー割り当て マネージド ID」の 2 種類がありますが、ここでは「システム割り当て マネージド ID」の利用例を紹介します。これら二つの違いについては、<a href="https://learn.microsoft.com/ja-jp/entra/identity/managed-identities-azure-resources/overview">Azure リソースのマネージド ID とは (learn.microsoft.com)</a> の公開情報をご参照ください。</p><h4 id="マネージド-ID-の有効化"><a href="#マネージド-ID-の有効化" class="headerlink" title="マネージド ID の有効化"></a>マネージド ID の有効化</h4><p>まずは、PowerShell コマンド実行元の Azure VM で「システム割り当て マネージド ID」を有効化します。</p><ol><li>Azure ポータルで、該当の Azure VM リソースを開きます</li><li>[セキュリティ] &gt; [ID] の設定画面に進みます</li><li>[システム割り当て済み] タブの [状態] を “オン” にして、[保存] を押下します。</li></ol><h4 id="マネージド-ID-を利用した認証"><a href="#マネージド-ID-を利用した認証" class="headerlink" title="マネージド ID を利用した認証"></a>マネージド ID を利用した認証</h4><p>「システム割り当て マネージド ID」を有効化した Azure VM 上で、PowrShell を起動し、以下のようにコマンドを実行します。コマンドの引数である <code>-Identity</code> がマネージド ID を利用するという意味のオプションです。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Identity</span></span><br></pre></td></tr></table></figure><p>認証に成功すると、”Welcome To Microsoft Graph!” のメッセージが表示されます。サインインの詳細は、Microsoft Entra ID のサインイン ログから確認できます。特に資格情報を渡さずとも認証が完了しますので、あっという間の出来事ですが、マネージド ID を利用して安全に認証が完了していますのでご安心ください。</p><h3 id="アプリケーション-サービス-プリンシパル-を利用した認証の場合"><a href="#アプリケーション-サービス-プリンシパル-を利用した認証の場合" class="headerlink" title="アプリケーション (サービス プリンシパル) を利用した認証の場合"></a>アプリケーション (サービス プリンシパル) を利用した認証の場合</h3><p>この場合は以下のようなシナリオが該当します。</p><ul><li>Microsoft Graph PowerShell SDK の認証用コマンド “Connect-MgGraph” を自動で実行したい。</li><li>実行元は Azure 上のリソース (Azure MV) ではなく、オンプレミスや外部のデータセンターやクラウド サービスである。</li></ul><h4 id="アプリケーション-サービス-プリンシパル-の作成"><a href="#アプリケーション-サービス-プリンシパル-の作成" class="headerlink" title="アプリケーション (サービス プリンシパル) の作成"></a>アプリケーション (サービス プリンシパル) の作成</h4><p>まずは Microsoft Entra ID にアプリケーション (サービス プリンシパル) を新規作成します。</p><ol><li><p><a href="https://portal.azure.com/">Azure ポータル</a> もしくは <a href="https://entra.microsoft.com/">Microsoft Entra 管理センター</a> にアクセスします。</p></li><li><p>以下の画面に進みます。</p><ul><li>Azure ポータル: Microsoft Entra ID &gt; アプリの登録</li><li>Microsoft Entra 管理センター: ID &gt; アプリケーション &gt; アプリの登録</li></ul></li><li><p>[+ 新規登録] からアプリを新規登録します。</p><ul><li>[名前] に任意の名称を設定します。</li><li>[サポートされているアカウントの種類] は “この組織ディレクトリのみに含まれるアカウント” を選択します。</li><li>[リダイレクト URI] は空欄のまま進みます。</li></ul></li><li><p>登録されたアプリの [概要] 欄から、下記の 2 つの項目を控えます。</p><ul><li>アプリケーション (クライアント) ID</li><li>ディレクトリ (テナント) ID</li></ul></li></ol><h4 id="アプリケーション-サービス-プリンシパル-を利用した認証-証明書"><a href="#アプリケーション-サービス-プリンシパル-を利用した認証-証明書" class="headerlink" title="アプリケーション (サービス プリンシパル) を利用した認証 - 証明書"></a>アプリケーション (サービス プリンシパル) を利用した認証 - 証明書</h4><p>アプリケーション (サービス プリンシパル) の証明書認証では、証明書に含まれる非対称キー (秘密鍵/公開鍵) ベースの認証処理を行います。証明書は証明機関 (CA) 等で発行することがおすすめですが、自己署名証明書の利用も可能です。証明書の Subject 名などはどのようなものでも構いません。</p><h5 id="証明書の準備"><a href="#証明書の準備" class="headerlink" title="証明書の準備"></a>証明書の準備</h5><p>証明機関 (CA) で証明書のファイル (秘密鍵あり / 秘密鍵なし) を取得ください。Windows 端末上で自己署名証明書を発行する場合の例については、<a href="https://learn.microsoft.com/ja-jp/entra/identity-platform/howto-create-self-signed-certificate">自己署名公開証明書を作成してアプリケーションを認証する (learn.microsoft.com)</a> の公開情報をご参照ください。PowerShell を実行する Windows 端末で、[個人 (/My)] の証明書ストアに秘密鍵を含む証明書をインポートします。証明書の拇印をお手元にお控えください。</p><p>Microsoft Entra ID では、以下の手順で秘密鍵を含まない証明書をアップロードします。</p><ol><li>[アプリの登録] から該当のサービス プリンシパルを選択し、[証明書とシークレット] を開きます。</li><li>[証明書] タブの [+ 証明書のアップロード] を選択します。</li><li>秘密鍵を含まない証明書ファイル (.cer、.pem、.crt) をアップロードし、[追加] を押下します。</li></ol><h5 id="証明書を利用した認証"><a href="#証明書を利用した認証" class="headerlink" title="証明書を利用した認証"></a>証明書を利用した認証</h5><p>証明書を使って、Connect-MgGraph を実行します。上の手順で控えたアプリケーション (クライアント) ID とディレクトリ (テナント) ID、証明書の拇印をここで使用します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-ClientId</span> <span class="string">&quot;クライアント ID&quot;</span> <span class="literal">-TenantId</span> <span class="string">&quot;テナント ID&quot;</span> <span class="literal">-CertificateThumbprint</span> <span class="string">&quot;証明書の拇印&quot;</span></span><br></pre></td></tr></table></figure><p>認証に成功すると、”Welcome To Microsoft Graph!” のメッセージが表示されます。サインインの詳細は、Microsoft Entra ID のサインイン ログから確認できます。この例では証明書の拇印を指定しまましたが、モジュールやコマンドによっては証明書の指定方法が異なる場合もあります。</p><h4 id="アプリケーション-サービス-プリンシパル-を利用した認証-クライアント-シークレット"><a href="#アプリケーション-サービス-プリンシパル-を利用した認証-クライアント-シークレット" class="headerlink" title="アプリケーション (サービス プリンシパル) を利用した認証 - クライアント シークレット"></a>アプリケーション (サービス プリンシパル) を利用した認証 - クライアント シークレット</h4><p>何らかの理由で、証明書の利用ができない場合は、クライアント シークレットを用いた認証も可能です。この場合、Key Vault など別の仕組みを用いて極力クライアント シークレットをアプリケーション内に埋め込まないようにすることをお勧めします。できる限り、上記のマネージド ID か証明書を用いた方法をご選択ください。</p><h5 id="クライアント-シークレット文字列の作成"><a href="#クライアント-シークレット文字列の作成" class="headerlink" title="クライアント シークレット文字列の作成"></a>クライアント シークレット文字列の作成</h5><p>クライアント シークレット文字列を新規作成します。</p><ol><li><p>[アプリの登録] から該当のサービス プリンシパルを選択し、[証明書とシークレット] を開きます。</p></li><li><p>[クライアント シークレット] タブを開き [+ 新しいクライアント シークレット] を選択します。</p></li><li><p>任意の説明 (空欄でも構いません) を入力、有効期限を指定のうえ [+ 追加] を押下します。</p></li><li><p>新しいシークレットが発行されます。[値] の項目に表示される文字列が、クライアント シークレットの値です。この文字列をコピーして控えます。</p><p> <img src="/blog/azure-active-directory/credentials-for-psscripts/secret-visible.png"></p></li></ol><div class="alert is-info"><p class="alert-title">Note</p><p> 一度この画面を離れると、シークレット文字列を再表示することはできません。次回以降はマスクされた値のみが表示されるので、ご注意ください。</p><p><img src="/blog/azure-active-directory/credentials-for-psscripts/secret-hidden.png"> </p></div><h5 id="クライアント-シークレットを利用した認証"><a href="#クライアント-シークレットを利用した認証" class="headerlink" title="クライアント シークレットを利用した認証"></a>クライアント シークレットを利用した認証</h5><p>クライアント シークレットを使って、Connect-MgGraph を実行します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$Client_Id</span> = <span class="string">&quot;クライアント ID&quot;</span></span><br><span class="line"><span class="variable">$Client_Secret</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="literal">-String</span> <span class="string">&quot;クライアントシークレットの値&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="variable">$ClientSecretCredential</span> = <span class="built_in">New-Object</span> <span class="literal">-TypeName</span> System.Management.Automation.PSCredential <span class="literal">-ArgumentList</span> <span class="variable">$Client_Id</span>, <span class="variable">$Client_Secret</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-TenantId</span> <span class="string">&quot;テナント ID&quot;</span> <span class="literal">-ClientSecretCredential</span> <span class="variable">$ClientSecretCredential</span></span><br></pre></td></tr></table></figure><p>認証に成功すると、”Welcome To Microsoft Graph!” のメッセージが表示されます。サインインの詳細は、Microsoft Entra ID のサインイン ログから確認できます。</p><h2 id="よりセキュリティを高めるための-Tips"><a href="#よりセキュリティを高めるための-Tips" class="headerlink" title="よりセキュリティを高めるための Tips"></a>よりセキュリティを高めるための Tips</h2><p>アプリケーション (サービス プリンシパル) を利用した認証 (シークレットおよび証明書) のセキュリティ性をより高めたい場合は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/workload-identity">ワークロード ID 用の条件付きアクセス (learn.microsoft.com)</a> の活用をおすすめします。”条件付きアクセス” は Microsoft Entra ID の提供するアクセス制御の機能です。アクセス先のリソースや認証時の条件 (IP アドレス、リスクスコア 等) に応じて、アクセスの許可および拒否、条件付き許可 (例: 多要素認証の実行など) を制御することができます。</p><p>元々はユーザー認証のみを対象に提供していた機能ですが、Workload Identities Premium ライセンス (有償) を購入いただくことで、アプリケーション (サービス プリンシパル) の認証も制御可能となります。この機能を「ワークロード ID 用の条件付きアクセス」と呼びます。</p><p>※ マネージド ID による認証は対象外です。</p><p>ワークロード ID 用の条件付きアクセスでは、「IP アドレス ベースの場所情報」ならびに「リスク スコア」に応じて、アクセスの可否 (許可 or ブロック) を構成できます。設定方法は上記の公開情報をご参照ください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>アプリケーション (サービス プリンシパル) による認証を利用する IP アドレス範囲が予め分かっている場合に、その他の IP アドレスからのアクセスをブロックとするポリシーを作成します。これにより、指定した場所以外からのアクセスをブロックでき、不正アクセスのリスクを低減いただけます。</p></div><h2 id="アプリケーション-サービス-プリンシパル-およびマネージド-ID-での認証に対応した-PowerShell-モジュール-一部"><a href="#アプリケーション-サービス-プリンシパル-およびマネージド-ID-での認証に対応した-PowerShell-モジュール-一部" class="headerlink" title="アプリケーション (サービス プリンシパル) およびマネージド ID での認証に対応した PowerShell モジュール (一部)"></a>アプリケーション (サービス プリンシパル) およびマネージド ID での認証に対応した PowerShell モジュール (一部)</h2><h3 id="Microsoft-Graph-PowerShell-SDK-モジュール"><a href="#Microsoft-Graph-PowerShell-SDK-モジュール" class="headerlink" title="Microsoft Graph PowerShell SDK モジュール"></a>Microsoft Graph PowerShell SDK モジュール</h3><p>Microsoft Graph PowerShell SDK v2.0 (2023/7/5 以降のリリース) の認証用コマンド “Connect-MgGraph” は、アプリケーション (サービス プリンシパル) とマネージド ID の両方に対応しています。</p><p>※ 旧バージョンの場合は利用可能な認証オプションが限られます</p><ul><li>参考情報: <a href="https://learn.microsoft.com/ja-jp/powershell/microsoftgraph/authentication-commands?view=graph-powershell-1.0#app-only-access">Authentication module cmdlets in Microsoft Graph PowerShell - 項目 “App-only access” (learn.microsoft.com)</a></li><li>参考情報: <a href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-graph-powershell-v2.0/">Microsoft Graph PowerShell v2.0 でサポートされた認証方法と変更点 (jpazureid.github.io)</a></li><li>参考情報: <a href="https://learn.microsoft.com/ja-jp/powershell/module/microsoft.graph.authentication/connect-mggraph?view=graph-powershell-1.0">Connect-MgGraph (learn.microsoft.com)</a></li></ul><h3 id="Az-PowerShell-モジュール"><a href="#Az-PowerShell-モジュール" class="headerlink" title="Az PowerShell モジュール"></a>Az PowerShell モジュール</h3><p>Az PowerShell モジュールの認証用コマンド “Connect-AzAccount” は、アプリケーション (サービス プリンシパル) およびマネージド ID の両方に対応しています。</p><ul><li>参考情報: <a href="https://learn.microsoft.com/ja-jp/powershell/module/az.accounts/connect-azaccount">Connect-AzAccount (learn.microsoft.com)</a></li></ul><h3 id="Azure-CLI"><a href="#Azure-CLI" class="headerlink" title="Azure CLI"></a>Azure CLI</h3><p>Azure CLI の認証用コマンド “az login” も、アプリケーション (サービス プリンシパル) およびマネージド ID の両方に対応しています。</p><ul><li>参考情報: <a href="https://learn.microsoft.com/ja-jp/cli/azure/azure-cli-sp-tutorial-2">パスワードベースの認証で Azure サービス プリンシパルを使う (learn.microsoft.com)</a></li><li>参考情報: <a href="https://learn.microsoft.com/ja-jp/cli/azure/azure-cli-sp-tutorial-3">証明書ベースの認証を使用して Azure サービス プリンシパルを使用する (learn.microsoft.com)</a></li><li>参考情報:  <a href="https://learn.microsoft.com/ja-jp/cli/azure/authenticate-azure-cli-managed-identity">Azure CLI でマネージド ID 使用したサインイン (learn.microsoft.com)</a></li></ul><p>以上の情報がご参考になりましたら幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの栗井です。&lt;/p&gt;
&lt;p&gt;Microsoft Azure の各種リソース操作や情報取得を行う方法として、多くのお客様に、各種 PowerShell モジュール (Az PowerShell, Micro</summary>
      
    
    
    
    
    <category term="Conditional Access" scheme="https://jpazureid.github.io/blog/tags/Conditional-Access/"/>
    
    <category term="Microsoft Entra" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Entra/"/>
    
    <category term="Managed ID" scheme="https://jpazureid.github.io/blog/tags/Managed-ID/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra ライセンスの使用状況分析機能のご紹介</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/introducing-microsoft-entra-license-utilization-insights/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/introducing-microsoft-entra-license-utilization-insights/</id>
    <published>2024-02-25T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.431Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 高田 です。</p><p>本記事は、2024 年 2 月 20 日に米国の Microsoft Entra Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/introducing-microsoft-entra-license-utilization-insights/ba-p/3796393">Introducing Microsoft Entra License Utilization Insights</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>現在、80 万を超えるお客様が、エンドユーザーの生産性を向上させながらセキュリティを確保し、絶えず変化する脅威に対応するため Microsoft Entra を利用しています。お客様からは、Entra の使用状況についてより透明性を高めたいという要望を頻繁に頂戴しており、特にライセンスに関する要望が多く寄せられています。本日、Microsoft Entra ライセンス利用ポータルのパブリック プレビューを発表できることを嬉しく思います。この新機能は、Premium 機能の現在の利用状況を把握することで、お客様が Entra ID Premium ライセンスを最適化できるようにするものです。</p><p>この投稿では、Entra ID Premium ライセンスを最大限に活用するために、この Entra ID ライセンス利用の概要を説明いたします。</p><p>Entra ID ライセンス利用ポータルでは、Entra ID P1 および P2 ライセンスの数と、ライセンスの種類に対応する主要機能の利用状況を確認できます。パブリック プレビューでは条件付きアクセスとリスクベースの条件付きアクセスの使用状況を確認いただけますが、一般提供時には、他の SKU (ライセンス) や対応する機能の使用状況も含まれるように拡張される予定です。この機能により、ライセンス数と、ライセンスで利用できる機能の利用状況をより良く把握できるようになります。また、テナントで発生する可能性のある使用過多の問題 (ライセンス違反) に対処するのにも役立ちます。</p><h2 id="パブリック-プレビューを試す"><a href="#パブリック-プレビューを試す" class="headerlink" title="パブリック プレビューを試す"></a>パブリック プレビューを試す</h2><p>ライセンスの使用状況と分析情報のポータルは [使用状況と分析情報] ブレード配下にあります。</p><p><img src="/blog/azure-active-directory/introducing-microsoft-entra-license-utilization-insights/pic1.png" alt="図 1. &quot;使用状況と分析情報&quot; ブレードの下にあるライセンスの使用状況と分析情報のポータル"></p><p>このポータルでは、Entra ID Premium P1 および P2 ライセンス (該当する場合) に対応する機能について情報を提示します。これらの知見を活用することで、ユーザーを保護し管理するとともに、ライセンス条項を確実に遵守することができます。以下は、Entra ポータルで表示される機能の使用状況のスクリーンショットです:</p><p><img src="/blog/azure-active-directory/introducing-microsoft-entra-license-utilization-insights/pic2.png" alt="図 2: ライセンスの利用状況ポータルにおける Entra ID Premium P1 機能の利用状況"></p><p><img src="/blog/azure-active-directory/introducing-microsoft-entra-license-utilization-insights/pic3.png" alt="図 3: ライセンスの利用状況ポータルにおける Entra ID Premium P2 機能の利用状況"></p><h2 id="今後"><a href="#今後" class="headerlink" title="今後"></a>今後</h2><p>Entra の利用状況をよりよく把握できるようこの機能を継続的に改善していく所存です。この新しい機能についてのご意見をぜひお聞かせください。</p><p>Shobhit Sahay</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 高田 です。&lt;/p&gt;
&lt;p&gt;本記事は、2024 年 2 月 20 日に米国の Microsoft Entra Blog で公開された &lt;a href=&quot;https://techcommunity.microsof</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>条件付きアクセスで高度な証明書ベース認証 (CBA) の設定オプションがパブリック プレビューになりました</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/Introducing-More-Granular-Certificate-Based-Authentication-Configuration/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/Introducing-More-Granular-Certificate-Based-Authentication-Configuration/</id>
    <published>2024-02-22T03:00:00.000Z</published>
    <updated>2024-03-15T02:00:16.983Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 中村 です。 </p><p>本記事は、2024 年 1 月 30 日に米国の Microsoft Entra Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/introducing-more-granular-certificate-based-authentication/ba-p/2365668">Introducing More Granular Certificate-Based Authentication Configuration in Conditional Access</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>条件付きアクセスによる高度な証明書ベース認証 (CBA) の新しいオプションのパブリック プレビューを発表できることを嬉しく思います。このオプションは、証明書の発行者やポリシーのオブジェクト識別子 (OID) のプロパティに基づいて、特定のリソースへのアクセスを許可する機能を提供します。</p><p>弊社のお客様、特に厳格に規制された業界や政府機関のお客様は、CBA の設定により柔軟性が必要であると要望されていました。すべての Entra ID 連携アプリケーションに同じ証明書を使用することは、必ずしも十分ではありません。リソースによっては、特定の発行者が発行した証明書によるアクセスが必要な場合もありますし、特定の OID のポリシーに基づくアクセスが必要なリソースもあります。</p><p>例として、Contoso という企業では、従業員にスマート カードを使用して 3 種類の多要素証明書を従業員に発行しているとします。これらの証明書は、機密、秘密、トップシークレットのような異なるセキュリティ クリアランス レベルに対応しています。Contoso 社は、適切な多要素証明書を持つユーザーのみが、対応する分類のデータにアクセスできるようにする必要があります。</p><p><img src="/blog/azure-active-directory/Introducing-More-Granular-Certificate-Based-Authentication-Configuration/Introducing-More-Granular-Certificate-Based-Authentication-Configuration1.png" alt="図 1: 認証強度 - 高度な CBA オプション"></p><p>条件付きアクセスの認証強度の機能により、お客様は証明書発行者や OID のポリシーに基づいてアクセスを許可する高度な CBA オプションを使用して、カスタムの認証強度ポリシーを作成できるようになりました。パートナーの Entra ID テナントから多要素認証 (MFA)  が信頼されている外部ユーザーの場合、これらのプロパティに基づいてアクセスを制限することもできます。 </p><p>これにより、<a href="https://jpazureid.github.io/blog/azure-active-directory/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication/">12 月に共有した最新の更新</a> に加えて、CBA に柔軟性が追加されました。私たちは、すべてのお客様に対してフィッシング耐性のある認証機能をより向上させ、米国政府のお客様が「<a href="https://www.whitehouse.gov/briefing-room/presidential-actions/2021/05/12/executive-order-on-improving-the-nations-cybersecurity/">国家のサイバーセキュリティの向上に関する大統領令 14028</a>」を満たすことができるよう、引き続きサポートしていきます。</p><p>この新機能の詳細については、<a href="https://learn.microsoft.com/en-us/entra/identity/authentication/concept-authentication-strength-advanced-options">認証強度の詳細オプション</a> をご確認ください。</p><p>Alex Weinert</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 中村 です。 &lt;/p&gt;
&lt;p&gt;本記事は、2024 年 1 月 30 日に米国の Microsoft Entra Blog で公開された &lt;a href=&quot;https://techcommunity.microso</summary>
      
    
    
    
    
    <category term="Conditional Access" scheme="https://jpazureid.github.io/blog/tags/Conditional-Access/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra の 2023 年の機能トップ 50</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entras-top-50-features-of-2023/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/microsoft-entras-top-50-features-of-2023/</id>
    <published>2024-02-16T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.519Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 五十嵐 です。</p><p>本記事は、2024 年 1 月 19 日に米国の Microsoft Entra (Azure AD) Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/microsoft-entra-s-top-50-features-of-2023/ba-p/3796392">Microsoft Entra’s Top 50 Features of 2023</a> の抄訳です。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>2024 年の幕開けとして、昨年 1 年間に Microsoft Entra で提供された主な機能を振り返りたいと思います。弊社は、マルチクラウドの ID およびネットワーク アクセス製品により、あらゆる種類の ID を検証し、あらゆるリソースへのアクセスを保護、管理、統制するために、何千ものお客様にサービスを提供いたしました。Microsoft Entra の最新の進歩の波は、Security Service Edge (SSE)、人工知能 (AI) にまで広がり、分散型 ID、マルチクラウド、人間以外の ID などの他の重要な分野におけるイノベーションを加速しつつ、<strong>100 以上の機能を提供しました</strong>。以下に、お客様からのフィードバックや市場のニーズに基づき実現した上位 50 の機能をご紹介します。包括的なリストについては、<a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/whats-new">リリース ノート</a> をご参照ください。これらの最新の ID イノベーションを採用することで、デジタル資産の保護を強化し、セキュリティへの投資からより多くの効果を得ることができます。</p><ol><li><strong>AI 時代における安全なアクセス</strong> - Microsoft Ignite 2023 で、Microsoft <a href="https://www.microsoft.com/ja-jp/security/business/ai-machine-learning/microsoft-security-copilot">Security Copilot</a> が Microsoft Entra（<a href="https://jpazureid.github.io/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/">プライベート プレビュー</a>）に登場し、一般的なタスクの自動化、トラブルシューティングの迅速化、複雑なポリシーの解釈、ワークフローの設計を支援することを発表しました。 この画期的な機能は、強力で一貫性のある <strong>ID セキュリティ</strong> を維持するための 1 つの要素に過ぎません。Microsoft Entra の幅広いソリューションは、マルチクラウドやハイブリッド環境の従業員、第一線で働く従業員、お客様、パートナー、そしてアプリ、デバイス、ワークロードを保護します。</li></ol><p><img src="/blog/azure-active-directory/microsoft-entras-top-50-features-of-2023/microsoft-entras-top-50-features-of-2023-1.jpeg" alt="Microsoft Entra 管理センターにて、Microsoft Security Copilot が、その条件付きアクセス ポリシーは何をするためのものなのか、なぜ多要素認証 (MFA) が要求されたのかなどを、簡単な会話形式で説明してくれます。"></p><ol start="2"><li>企業や政府機関のお客様をサポートする <strong>物理的な FIDO2 セキュリティ キーに代わる、フィッシングに強い</strong> <a href="https://jpazureid.github.io/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/">パスキー</a> のサポートを予定しています。</li><li>リスク シグナル、ライセンス、使用状況に基づいてテナントを保護する <a href="https://www.microsoft.com/en-us/security/blog/2023/11/06/automatic-conditional-access-policies-in-microsoft-entra-streamline-identity-protection/">Microsoft Entra 条件付きアクセス ポリシーの自動ロールアウト</a> (<a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/managed-policies">Microsoft マネージド ポリシー</a>) により、<strong>既定で安全が確保されます</strong>。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/public-preview-token-protection-for-sign-in-sessions/">サインイン セッションに対するトークン保護の条件付きアクセスの強制 (パブリック プレビュー)</a> により、<strong>トークンの盗難やリプレイ攻撃に対処</strong> します。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/conditional-access-for-protected-actions/">保護されたアクションのための条件付きアクセス</a> により、組織は、条件付きアクセス ポリシーの変更、アプリケーションへの資格情報の追加、フェデレーション信頼の設定変更など、<strong>重要な管理操作を保護</strong> することができます。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/conditional-access-overview-and-templates/">条件付きアクセスの概要ダッシュボード</a> により、条件付きアクセスの状態とテンプレートが包括的に表示され、Microsoft の推奨事項に沿った新しいポリシーの展開が容易になります。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/ca-authentication-strength-ga/">条件付きアクセスの認証強度</a> は、ユーザーのサインイン リスク レベルやアクセス先のリソースの機密性に基づいて認証方法の要件を適用することを可能にします。<strong>規制の厳しい業界</strong> や厳格なコンプライアンス要件を持つ組織にとって <strong>特に有用です</strong>。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/public-preview-strictly-enforce-location-policies-with-contiunuous-access-evaluation/">場所に基づくポリシーの厳密な適用 (パブリック プレビュー)</a> により、IP アドレスの場所を使用したポリシーに違反したトークンを無効化し、<strong>トークンのリプレイ攻撃をほぼリアルタイムで防止</strong> することでゼロ トラスト アクセス制御を実現します。</li><li>新しい <a href="https://jpazureid.github.io/blog/azure-active-directory/what-s-new-with-microsoft-entra-id-protection/">Microsoft Entra ID Protection のダッシュボード (パブリック プレビュー)</a> は、ID の管理者や IT 担当者がセキュリティの状態をよりよく把握し、ID の侵害に対して効率的に対応するのに役立ちます。</li><li>新しい Microsoft Entra ID Protection の検出機能: <a href="https://jpazureid.github.io/blog/azure-active-directory/what-s-new-with-microsoft-entra-id-protection/#%E6%96%B0%E3%81%97%E3%81%84%E9%AB%98%E5%BA%A6%E3%81%AA%E6%A4%9C%E5%87%BA%E6%A9%9F%E8%83%BD">検証済み脅威アクター IP と中間者攻撃の検出</a> により、悪意のある攻撃者やアクティビティから組織を保護します。</li><li>Microsoft Entra ID Protection の <a href="https://jpazureid.github.io/blog/azure-active-directory/what-s-new-with-microsoft-entra-id-protection/#%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%BF%E3%82%A4%E3%83%A0%E3%81%AA-Azure-AD-%E8%84%85%E5%A8%81%E3%82%A4%E3%83%B3%E3%83%86%E3%83%AA%E3%82%B8%E3%82%A7%E3%83%B3%E3%82%B9">リアルタイムな脅威インテリジェンス</a> の検出により、リスク ベースの条件付きアクセス ポリシーを適用して ID を保護することができます。</li><li>マルチクラウドのインフラにおける ID の権限管理 - <strong>マルチクラウドのインフラにおける ID</strong> の権限を管理し、最小特権の原則を確実にすることで、ID のセキュリティ体制を改善します。</li></ol><p><img src="/blog/azure-active-directory/microsoft-entras-top-50-features-of-2023/microsoft-entras-top-50-features-of-2023-2.png" alt="マルチクラウドのインフラにおける ID の権限を管理"></p><ol start="13"><li>Microsoft Entra ID Protection の活用 - <strong>ハイブリッド環境におけるユーザー リスクを効果的に管理する</strong> ために、<a href="https://jpazureid.github.io/blog/azure-active-directory/Remediate-User-Risks-in-Microsoft-Entra-ID-Protection-Through-On-premises-Password-Changes/">オンプレミスのパスワード変更によりユーザー リスクを修復できます (パブリックプレビュー)</a>。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/what-s-new-with-microsoft-entra-id-protection/#%E4%B8%80%E8%88%AC%E6%8F%90%E4%BE%9B-Microsoft-Entra-ID-Protection-%E3%81%A8-Microsoft-365-Defender-%E3%81%A8%E3%81%AE%E7%B5%B1%E5%90%88">Microsoft Entra ID Protection を Microsoft 365 Defender と統合</a> することで、インシデントを効率的かつ効果的に調査し、<strong>攻撃の全体像を把握する</strong> と共に、ID の侵害に対して迅速に対処できるようになります。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/ga-system-preferred-multifactor-authentication/">システム優先 MFA の機能</a> により、管理者が設定したポリシーで有効化している方法のうち、ユーザーが登録済みの MFA の方法の中から最も安全な方法を選んでサインインするよう促します。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-certificate-based-authentication-cba-on-mobile-now/">モバイル デバイスでの証明書ベース認証 (CBA)</a> を使用して、ユーザーのモバイル端末に証明書を展開しなくても、モバイル端末に対してフィッシング耐性のある多要素認証 (MFA) を要求できるようになります。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/">証明書ベース認証 (CBA) の新機能と機能強化</a> により、政府機関が大統領令 14028 の要件に準拠できるようになり、Active Directory フェデレーション サービスからの移行を支援します。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/introducing-a-new-way-to-verify-your-workplace-on-linkedIn-with-microsoft-entra-verified-id/">Microsoft Entra Verified ID を使用した LinkedIn 上の職場の検証</a> - オープン スタンダードに基づく Verifiable Credentials を通じて、<strong>分散型 ID</strong> の利用を検討ください。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/modernizing-authentication-management/">統合された認証方法</a> - 多要素認証 (MFA) とセルフサービス パスワード リセット (SSPR) に使用される認証方法を、FIDO2 セキュリティ キーや証明書ベースの認証 (CBA) のようなパスワードレス認証の方法と併せて 1 つのポリシーで管理できます。</li><li>Microsoft Entra ワークロード ID の <a href="https://jpazureid.github.io/blog/azure-active-directory/new-app-health-recommendations-in-microsoft-entra-workload-identities/">App Health 推奨機能</a> を使用して、<strong>人間以外の ID を保護します</strong>。</li><li><a href="https://techcommunity.microsoft.com/t5/security-compliance-and-identity/introducing-ad-fs-application-migration-your-path-to-simplicity/ba-p/3980232">AD FS アプリケーションの移行</a> - クラウドベースの ID サービス、セキュリティの強化、ユーザー エクスペリエンスの向上により、<strong>ID に関わる資産を刷新</strong> ください。</li><li>FIDO2 セキュリティ キーを使用して、<a href="https://jpazureid.github.io/blog/azure-active-directory/advancing-modern-strong-authentication/#iOS-%E3%81%8A%E3%82%88%E3%81%B3-macOS-%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%83%BC%E3%81%A7%E3%81%AE-FIDO2-%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%AE%E4%B8%80%E8%88%AC%E6%8F%90%E4%BE%9B%E9%96%8B%E5%A7%8B">iOS および macOS Web ブラウザー</a> で Microsoft Entra ID 連携アプリケーションにサインインできます。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/enterprise-sso-ga/">Apple デバイス向けの Microsoft Enterprise SSO</a> を使用して、すべてのアプリケーションで macOS、iOS、および iPadOS 上の Microsoft Entra ID アカウントのシングル サインオン (SSO) を構成できます。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/coming-soon-platform-SSO-for-macOS/">macOS 向けのプラットフォーム SSO (パブリック プレビュー)</a> を使用して、フィッシングに強い認証方法または従来のパスワードのいずれかを設定できます。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/Windows-Local-Administrator-Password-Solution-with-Microsoft-Entra-ID-now-Generally-Available!/">Microsoft Entra ID を使用した Windows ローカル管理者パスワード ソリューション</a> を使用して、<strong>ローカル管理者アカウントを保護</strong> できます。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/">カスタム クレーム プロバイダー</a> を使用して認証フローをカスタマイズし、外部システムから認証クレームを取得できます。</li><li><a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/microsoft-entra-external-id-public-preview-developer-centric/ba-p/3823766">Microsoft Entra External ID (パブリック プレビュー)</a> - <strong>外部 ID</strong> に対してより安全な関係を確立し、人間中心なユーザー体験を実現すると共に、安全なアプリケーションの開発を加速します。</li></ol><p><img src="/blog/azure-active-directory/microsoft-entras-top-50-features-of-2023/microsoft-entras-top-50-features-of-2023-3.png" alt="顧客やパートナーのアプリケーションをパーソナライズし、安全なアクセスを支援します。"></p><ol start="28"><li><a href="https://jpazureid.github.io/blog/azure-active-directory/graph-activity-log-in-preview/">Microsoft Graph アクティビティ ログ</a> を使用すると、サインイン ログのトークン要求から、Microsoft Graph アクティビティ ログの API 要求アクティビティ (読み取り、書き込み、および削除) 、監査ログに出る最終的なリソース変更まで、テナント内のアクティビティの全体像を調査できるようになります。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/introducing-restricted-management-au-in-microsoft-entra-id/">制限付き管理の管理単位</a> : Microsoft Entra ID テナント内の特定のユーザー、セキュリティ グループ、またはデバイスを指定し、テナントレベルの管理者による変更から保護できるようになります。</li><li>Microsoft Entra ID の <a href="https://jpazureid.github.io/blog/azure-active-directory/ipv6-coming-to-azuread/">IPv6 サポート</a> により、IPv4、IPv6、またはデュアル スタックのエンドポイントから Entra サービスにアクセスできます。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/#%E3%82%88%E3%82%8A%E5%BC%B7%E5%9B%BA%E3%81%AA%E6%A8%A9%E9%99%90%E7%AE%A1%E7%90%86%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E6%A9%9F%E8%83%BD%E3%81%AE%E7%B5%B1%E5%90%88">Microsoft Entra Permissions Management - Microsoft Defender for Cloud (MDC) との統合 (パブリック プレビュー)</a>: ID とアクセス許可に関する分析情報を、他のクラウド セキュリティ情報と統合し、単一のインターフェイスで表示します。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/#%E3%82%88%E3%82%8A%E5%BC%B7%E5%9B%BA%E3%81%AA%E6%A8%A9%E9%99%90%E7%AE%A1%E7%90%86%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E6%A9%9F%E8%83%BD%E3%81%AE%E7%B5%B1%E5%90%88">Microsoft Entra Permissions Management - ServiceNow との統合</a>: ServiceNow のお客様は、ServiceNow ポータルを介してマルチクラウド環境 (Azure、AWS、Google Cloud) に対し、期限付きのオンデマンド許可を要求できます。</li><li>使用している <a href="https://jpazureid.github.io/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/#Security-Service-Edge-%E3%81%A7%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%B8%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%82%92%E4%BF%9D%E8%AD%B7">ID プロバイダーのソリューション</a> に関係なく、すべての ID とそのアクセス許可を一元管理できます (パブリック プレビュー)。</li><li>Microsoft Entraでネットワーク アクセスを保護 - 2023 年 7 月に 2 つの新製品を発表しました: <a href="https://www.microsoft.com/ja-jp/security/business/identity-access/microsoft-entra-internet-access?rtc=1">Microsoft Entra Internet Access (パブリック プレビュー)</a> と <a href="https://www.microsoft.com/ja-jp/security/business/identity-access/microsoft-entra-private-access">Microsoft Entra Private Access (パブリック プレビュー)</a> です。ID ソリューションとネットワーク アクセス ソリューションが連携することで、企業はアプリケーションごとにどのツールがより効果的かを決定したり、ID 部門が作成したポリシーとネットワーク部門が作成したポリシーをどのように橋渡しするかを決定したりするのに時間を費やす必要がなくなります。統合された柔軟性のある制御を適用し、ネットワーク アクセスのセキュリティを簡素化することで、ID 中心の Security Service Edge (SSE) ソリューションで優れたユーザー エクスペリエンスをどこでも提供することができます。</li></ol><p><img src="/blog/azure-active-directory/microsoft-entras-top-50-features-of-2023/microsoft-entras-top-50-features-of-2023-4.png" alt="ID 中心のセキュア Web ゲートウェイ (SWG) により、インターネット、SaaS、Microsoft 365 のすべてのアプリケーションとリソースへのセキュアなアクセスを実現"></p><ol start="35"><li><a href="https://devblogs.microsoft.com/identity/build-ciam-dev-center/">Identity Platform Developer Center</a>: 開発者が ID の概念について理解し、Microsoft Entra External ID の機能を学び、新しいプラットフォームを使用して素晴らしい消費者向けアプリケーションを構築するための最適な方法を学ぶために必要な <strong>すべてのものをワンストップで</strong> 提供します。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/company-branding-ga/">強化された会社のブランド機能</a> - 既定のサインイン ページだけでなく、特定のブラウザー言語をターゲットにしたページもカスタマイズできます。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/xtap-new-feature/">クロステナント アクセス設定の新機能</a> - テナントを跨いだコラボレーション シナリオを保護し、パートナーのエンドユーザー体験を向上させます。</li><li>テナント間のアクセスを保護する <a href="https://jpazureid.github.io/blog/azure-active-directory/how-tenant-restrictions-v2-can-be-used-to-prevent-data/">テナント制限 v2</a> を使用して、<strong>データの流出を防止</strong> します。</li><li>ID Governance にライフサイクル ワークフローが登場 - 2023 年 6 月 7 日に <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/microsoft-entra-id-governance-is-generally-available/ba-p/2466932">Microsoft Entra ID Governance</a> が <strong>一般利用可能</strong> になり、最新の機能の 1 つが追加されました。<strong>ライフサイクル ワークフロー (LCW)</strong> です。<strong>新しいライフサイクル ワークフロー</strong> では、<strong>より詳細なワークフローの実行監査</strong> が可能になり、いつでも <a href="https://entra.microsoft.com/#view/Microsoft_AAD_LifecycleManagement/CommonMenuBlade/~/auditlogs">ライフサイクル ワークフローの監査ログ</a> や <a href="https://entra.microsoft.com/#view/Microsoft_AAD_ERM/DashboardBlade/~/Audit%20logs">Entra Identity Governance の監査ログ</a> に移動することができるうようになりました。これにより、ワークフロー実行情報やその他のワークフローの管理アクティビティに詳細にアクセス可能となります。</li></ol><p><img src="/blog/azure-active-directory/microsoft-entras-top-50-features-of-2023/microsoft-entras-top-50-features-of-2023-5.png" alt="新入社員がすぐに生産性を発揮できるようにワークフローを設計 - 退社時にはアクセスを削除"></p><ol start="40"><li><strong>機械学習</strong> をベースとしたレビュー担当者向けの <a href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-id-governance-introduces-two-new-features-in-access-reviews/">推奨事項</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/new-microsoft-entra-id-governance-dashboard-experience-rolling/">Microsoft Entra ID Governance の新しいダッシュボード</a> により、現在の ID ガバナンスの状態を一目で把握できるようになり、ID Governance の各種機能にすぐにアクセスしたり、コンプライアンスのレポートへも素早くアクセスできたりします。</li><li>機密リソースへのアクセスを承認する前に、<a href="https://jpazureid.github.io/blog/azure-active-directory/identity-governance-with-verified-id/">Verified ID を必要とする</a> ようにできます。</li><li>ゼロ トラストでのアクセス コントロール - <a href="https://jpazureid.github.io/blog/azure-active-directory/pim-for-group-ga/">グループ向けの PIM</a> を使用して、必要な時に必要な時間だけ (Just-In-Time) 特権ロールへのアクセス付与を行えます。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/pim-for-group-ga/#%E6%9D%A1%E4%BB%B6%E4%BB%98%E3%81%8D%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E8%AA%8D%E8%A8%BC%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F-PIM-%E3%81%AE%E7%AE%A1%E7%90%86">条件付きアクセスと PIM の統合</a> により、アクティブ化にセキュリティ要件を適用します。</li><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/app-provisioning/inbound-provisioning-api-concepts">API 駆動型プロビジョニング (パブリック プレビュー)</a> - 従業員やパートナーの生産性を向上させ、<strong>堅牢な ID ガバナンス</strong> を通じてコンプライアンスや規制要件への対応を支援します。</li><li><strong>オンプレミス</strong> <a href="https://jpazureid.github.io/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/">アプリケーション</a> のプロビジョニングとガバナンスを <strong>自動化</strong> します。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/entitlement-management-ga/">組織固有のプロセスとビジネス ロジック</a> でアクセス ライフサイクルを拡張します。</li><li>ユーザーが自身でアクセス要求を行う代わりに、アクセス パッケージへの <a href="https://jpazureid.github.io/blog/azure-active-directory/entitlement-management-ga/">アクセスを自動的に割り当てます</a>。</li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/entitlement-management-ga/#3-%E3%82%A8%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%88%E3%83%AB%E3%83%A1%E3%83%B3%E3%83%88%E7%AE%A1%E7%90%86%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B-Verified-ID">エンタイトルメント管理における Verified ID チェックの設定</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/entitlement-management-ga/#4-%E6%9D%A1%E4%BB%B6%E4%BB%98%E3%81%8D%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%82%A8%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%88%E3%83%AB%E3%83%A1%E3%83%B3%E3%83%88%E7%AE%A1%E7%90%86%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88">条件付きアクセスにおけるエンタイトルメント管理のサポート</a></li></ol><h2 id="ID-セキュリティの道のりは絶え間なく続く"><a href="#ID-セキュリティの道のりは絶え間なく続く" class="headerlink" title="ID セキュリティの道のりは絶え間なく続く"></a>ID セキュリティの道のりは絶え間なく続く</h2><p>ID セキュリティ市場は絶えず発展していますが、これは悪意のあるアクターやハッカーによる脅威やリスク、AI の進歩も同様です。こうした変化に対応するため、組織は ID セキュリティに対して積極的かつ包括的なアプローチを取り、信頼できるベンダーと協力して最適なソリューションを提供する必要があります。2023 年が終わっても、ソリューションに対する需要は依然として高く、弊社からは 2024 年に何を計画しているか今後徐々に明らかにしたいと考えています。</p><p>よろしくお願いいたします。</p><p>Shobhit Sahay</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 五十嵐 です。&lt;/p&gt;
&lt;p&gt;本記事は、2024 年 1 月 19 日に米国の Microsoft Entra (Azure AD) Blog で公開された &lt;a href=&quot;https://techcommun</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
    <category term="Microsoft Entra" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Entra/"/>
    
  </entry>
  
  <entry>
    <title>インタラクティブ マップを使用した Entra サインイン ログの可視化手法</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/</id>
    <published>2024-02-14T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.703Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 山下 です。</p><p>本記事は、2024 年 1 月 16 日に米国の Microsoft Entra (Azure AD) Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/visualize-entra-sign-in-logs-using-an-interactive-map/ba-p/4013853">Visualize Entra Sign-in Logs using an Interactive Map - Microsoft Community Hub</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>Microsoft Sentinel には、Microsoft および Azure サービス、サードパーティのソースやカスタム ログまで、豊富なデータ コネクタが存在します。このデータは、分析してこそ価値をもたらすものです。プロアクティブおよびリアクティブな調査をしていく中で、さまざまなフォーマットでデータを可視化することで、何らかの異常やパターン、貴重な洞察などを得ることができます。</p><p>Microsoft Entra のサインインログのような地理的な関連情報を含むデータを扱う場合、データを最大限に活用するためには、適切なツールを通してデータを視覚化することが重要です。そこで、Sentinel と Log Analytics ワークスペースのインタラクティブ マップが活躍します。このブログ記事の執筆時点では、Sentinel や Log Analytics ワークスペースの Logs セクションで直接インタラクティブ マップを使用することはできません。代わりに、Azure Data Explorer のウェブ アプリまたは <a href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/tools/kusto-explorer">Kusto Explorerデスクトップ アプリ</a> を使用する必要があります。この記事では、すべての例で Azure Data Explorer を使用した方法をご紹介します。必要なセットアップは、数分しかかからず、簡単なものとなっております。</p><h2 id="セットアップと構成"><a href="#セットアップと構成" class="headerlink" title="セットアップと構成"></a>セットアップと構成</h2><p>最初のステップでは、<a href="https://dataexplorer.azure.com/">Azure Data Explorer</a> ウェブ アプリにアクセスし、画面左上の Add をクリックし、Connection を選択します。</p><p><img src="/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/01.png"></p><p>ここで、接続を求めるウィンドウが表示されます。Sentinel のインスタンス (実際は Log Analytics ワークスペース) に接続するためには、以下の情報が必要になります:</p><ul><li>サブスクリプション ID</li><li>リソース グループ名 - Log Analytics ワークスペースがあるリソース グループ</li><li>Log Analytics ワークスペース名</li></ul><p>これらの情報は、Sentinel のメニューの［Settings］をクリックし、［Workspace settings］をクリックすると表示されます。</p><p><img src="/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/02.png"></p><p>[Workspace settings] をクリックすると、以下のように必要な情報が画面に表示されます。これは、Sentinel を使用せずに Log Analytics ワークスペースに接続している場合も同様です。Log Analytics ワークスペースのページに移動すると、以下のページが開きます。</p><p><img src="/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/03.png"></p><p>接続 URI は以下のような形式である必要があります。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://ade.loganalytics.io/subscriptions/&lt;subscription-id&gt;/resourcegroups/&lt;resource-group-name&gt;/providers/microsoft.operationalinsights/workspaces/&lt;workspace-name&gt;</span><br></pre></td></tr></table></figure><p>接続 URI を適切な値で書き変えたら、それを Azure Data Explorer に追加します。表示名も入力し、[Add] をクリックします。接続 URI に指定している Log Analytics ワークスペースが、ウィンドウの下部に表示されているテナントの値と一致していることを確認ください。Log Analytics ワークスペースが Azure Data Explorer にサインインしたテナントとは異なるテナントにある場合は、この画面でテナントを切り替えください。</p><p><img src="/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/04.png"></p><p>接続が確立すると、左メニューの [Connections] に表示されるようになります。</p><p><img src="/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/05.png"></p><p>テーブルをクエリするには、ワークスペースを選択し、Sentinel の Logs の画面で通常行うようにクエリを入力ください。</p><p><img src="/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/06.png"></p><h2 id="インタラクティブ-マップの使用"><a href="#インタラクティブ-マップの使用" class="headerlink" title="インタラクティブ マップの使用"></a>インタラクティブ マップの使用</h2><p>インタラクティブ マップを使用するには、経度と緯度のデータが必要が必要になります。国名、州名、都市名に基づくマッピングには対応していません。経度と緯度のフォーマットは 10 進数である必要があります。つまり、41.40338 と 2.17403 の組み合わせは機能しますが、41°24’12.2”N と 2°10’26.5”E の形式では機能しません。Sentinel のほとんどのテーブルには、すでに正しいフォーマットの地理データが含まれています。</p><p>インタラクティブ マップを生成するには、”scatterchart with (kind=map) “の後に <strong>render</strong> 演算子を使用する必要があります。地理空間データの可視化に関連する引数についてのドキュメントは <a href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/geospatial-visualizations">こちら</a> です。ルールの 1 つとして、クエリ出力の最初の 2 列は経度と緯度の値でなければなりません。経度と緯度の特定の列は、クエリを実行した後に手動で選択することもできますが、列の順序を適切に設定することで、余分な作業を省略することができます。</p><p>各ロケーションから Entra のサインイン数を取得し、インタラクティブ マップ上に可視化させたデータを表示するには以下のクエリを利用ください。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SigninLogs</span><br><span class="line">| whereTimeGenerated &gt;ago(7d)</span><br><span class="line">| whereisnotempty(LocationDetails.geoCoordinates)</span><br><span class="line">| extend Latitude =toreal(LocationDetails.geoCoordinates[&quot;latitude&quot;])</span><br><span class="line">| extend Longitude =toreal(LocationDetails.geoCoordinates[&quot;longitude&quot;])</span><br><span class="line">| summarize Count =count()byLongitude,Latitude</span><br><span class="line">| project Longitude,Latitude,Count</span><br><span class="line">| render scatterchart with(kind=map)</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/07.png"></p><p>インタラクティブ マップは、拡大するなど自由に動かすことができます。オブジェクトをクリックすると、クエリの出力に基づいた値が表示されます。上記のクエリの例では、その場所からのサインイン数が計算されているため、オブジェクトをクリックするとサインイン数が表示されます。</p><p><img src="/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/08.png"></p><p>Azure Data Explorer ページでクエリを実行すると、結果の右側にメニューが表示されます。ここでは、クエリの結果を可視化する際の設定を変更することができます。</p><p><img src="/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/09.png"></p><p>円のサイズをサインイン数 (またはクエリ出力に存在する可能性のある他の数値) に比例させるように設定することも可能です。これを行うには、<strong>Size</strong> のセクションで、まず非表示のトグルを切り替えてサイズの設定を有効にし、円のサイズを決める列名を選択します。</p><p>以下が <strong>Size</strong> のセクションを設定した例になります。円の大きさが変化したことがお分かりいただけると思います。</p><p><img src="/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/10.png"></p><p><img src="/blog/azure-active-directory/visualize-entra-sign-in-logs-using-an-interactive-map/11.png"></p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>地理的なデータを可視化することで、他の方法では得られないような知見を得ることが可能です。Azure Data Explorer で接続をセットアップすれば、Entra ID やサインイン ログなど Sentinel のログを検索してインタラクティブな地図上に可視化が可能になるため、調査がより効果的になります。</p><p>ご自身のデータを実効力のある知見に変換する方法や、データの可視化の詳細については <a href="https://learn.microsoft.com/en-us/azure/data-explorer/viz-overview">こちら</a> をご覧ください。</p><p>Timur Engin<br><a href="https://www.linkedin.com/in/timurengin/">LinkedIn</a>  <a href="https://twitter.com/timurengin_">Twitter</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 山下 です。&lt;/p&gt;
&lt;p&gt;本記事は、2024 年 1 月 16 日に米国の Microsoft Entra (Azure AD) Blog で公開された &lt;a href=&quot;https://techcommuni</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>監査ログを使用した特権ロール割り当ての管理</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/easily-manage-privileged-role-assignments-with-auditlogs/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/easily-manage-privileged-role-assignments-with-auditlogs/</id>
    <published>2024-02-11T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.263Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure ID チームの小出です。</p><p>本記事は、2024 年 1 月 8 日に公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/easily-manage-privileged-role-assignments-in-microsoft-entra-id/ba-p/4013854">Easily Manage Privileged Role Assignments in Microsoft Entra ID Using Audit Logs</a> の記事を日本語に分かりやすくおまとめしなおした記事となります。ご不明点などございましたら、お気軽にサポートまでお問い合わせをいただけますと幸いです。</p><hr><p>Microsoft Entra ID をご利用いただくなかで、必ずどのお客様も利用いただくのが「Microsoft Entra ロール (Azure AD ロール)」です。例えば、どのテナントにも「グローバル管理者」ロールを持つユーザーがおり、テナント内のすべての構成に変更を加えることができます。他にも、「ユーザー管理者」ロールや「ヘルプデスク管理者」ロールなど様々なロールが用意されています。</p><p>管理者がユーザー A に対して「xx の操作をユーザー A にも実施させたいな」と考えた時には、その操作に対応するロールをユーザー A に付与することで管理権限を委任することができます。既定で用意された組み込みロール以外にも、カスタム ロールを自身で作成してユーザーやグループに割り当てることも可能です。また、不要になったロールを削除したり、適切ではないロールの割り当てを見直して削除したりすることも可能です。</p><p>一方で、このように管理権限を委任するときには、最小権限の原則に従い「委任したい操作内容を含む、最小特権のロールを付与する」よう注意を払う必要があります。</p><p>特権ロールを持つユーザーに、「本当にそのロール必要です？」と確認すると、ほとんどの場合は「はい、必要です！」と答えると思います。例えば、グローバル管理者ロールを保持しているユーザー A が、他のユーザーのパスワードをリセットする業務を行っている場合、確かにグローバル管理者ロールであればパスワードのリセットが可能なので、ユーザー A はそのロールを取り上げられては困ると主張すると思います。</p><p>しかし、パスワードをリセットする業務にグローバル管理者ロールの権限は強すぎます。より低い権限を持つロールが利用できるにもかかわらず、このようにユーザーは無意識のうちに特定のタスクを実行するために高い権限が必要だと考えてしまうのです。例えばこのシナリオの場合、確かにグローバル管理者ロールを使えば他のユーザーのパスワードをリセットできますが、このユーザーが誰のパスワードをリセットする予定なのかをヒアリングし、<a href="https://learn.microsoft.com/ja-jp/entra/identity/role-based-access-control/privileged-roles-permissions?tabs=admin-center#who-can-reset-passwords">Microsoft Entra ID の特権を持つロールとアクセス許可 (プレビュー)</a> の表を確認すれば、「ユーザー管理者」や「ヘルプデスク管理者」などより小さい権限を持つロールに置き換えることができるかもしれません。</p><p>このように、管理者ロールを持つユーザーの活動が注意深く監視および監査されないと、本来必要でないロールを割り当て続けてしまうことになります。ロール割り当ての定期的なチェックと新しい役割割り当てに関するアラートの発報は、特権ロールの割り当てを追跡し管理するにあたり非常に重要です。</p><h2 id="特権とは"><a href="#特権とは" class="headerlink" title="特権とは"></a>特権とは</h2><p>Microsoft Entra ID における特権とは、ディレクトリ上のリソースの管理を何らかの主体に委任し、資格情報や認証/認可のポリシーの変更、制限付きのデータへのアクセスを行えるようにするアクセス許可のことを指します。Microsoft Entra ロールには、それぞれロールごとに、このアクセス許可の内容が定義されています。ロールを割り当てられたユーザーには、このアクセス許可が付与され、様々な管理操作が可能となります。</p><p>まずは、割り当てられているロールにどのような管理権限があるのかを確認することが重要です。すべての組み込みロールに定義されている権限は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/role-based-access-control/permissions-reference">こちら</a> で確認できます。 </p><p>また、 Azure ポータル上でロールを検索し、「説明」メニューを開くことでもアクセス許可一覧を確認できます。この方法であれば、カスタム ロールに定義されているアクセス許可も確認できます。</p><p><img src="/blog/azure-active-directory/easily-manage-privileged-role-assignments-with-auditlogs/easily-manage-privileged-role-assignments-with-auditlogs1.png"></p><p>例えば、特権認証管理者ロールと認証管理者ロールは、名前が似ていますが異なるアクセス許可がいくつかあります。特権認証管理者の方が高い権限を持っており、具体的な権限の違いは <a href="https://learn.microsoft.com/ja-jp/entra/identity/role-based-access-control/privileged-roles-permissions?tabs=admin-center#compare-authentication-roles">こちら</a> にて確認できます。</p><p>同様のロール間に違いがあるもう 1 つの例は、エンドユーザーの管理を担うロールです。具体的には、パスワードのリセットができるロールや、機密性の高い属性を編集できるロールなどについてです。これらのロールの違いとニュアンスの詳細は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/role-based-access-control/privileged-roles-permissions?tabs=admin-center#who-can-reset-passwords">ここ</a> に概説されています。</p><h2 id="アクティビティの監査"><a href="#アクティビティの監査" class="headerlink" title="アクティビティの監査"></a>アクティビティの監査</h2><p>ユーザーに本当にロールが必要かどうかを判断するには、ユーザーのアクティビティを監視し、業務を遂行できる最小権限のロールを見つけることが重要です。そのためには Entra ID の監査ログをご利用いただけます。Entra ID の監査ログは、Log Analytics ワークスペースに送信するか、Sentinel のインスタンスに連携することができます。管理者アカウントによって実行された各種イベントを取得する方法としては  2 つあります。1 つ目は、Sentinel の IdentityInfo テーブルを使用する方法です。IdentityInfo テーブルは、User and Entity Behavior Analytics（UEBA）を有効にすることで、Sentinel でのみ使用できます。Sentinel で UEBA を使用していおらず、Logs Analytics ワークスペースを参照している場合は、後述の Log Analytics を利用する場合の項目をご確認ください。</p><h2 id="Microsoft-Sentinel-を利用する方法"><a href="#Microsoft-Sentinel-を利用する方法" class="headerlink" title="Microsoft Sentinel を利用する方法"></a>Microsoft Sentinel を利用する方法</h2><p>Entra ID の監査ログを Microsoft Sentinel に取り込むには、Microsoft Entra ID データコネクタを有効にし、以下のように監査ログの設定にチェックを入れる必要があります。</p><p><img src="/blog/azure-active-directory/easily-manage-privileged-role-assignments-with-auditlogs/easily-manage-privileged-role-assignments-with-auditlogs2.png"></p><p>IdentityInfo テーブルに、UEBA によって収集されたユーザー情報が格納されます。そのため、ユーザーが割り当てられた Entra ID ロールもここに含まれます。これにより、特権ロールが割り当てられたアカウントの一覧を簡単に取得できます。</p><p>以下のクエリを実行すると、アカウントが実行したアクティビティと、そのアカウントに割り当てられたロールの一意のリストが得られます: </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AuditLogs</span><br><span class="line">| where TimeGenerated &gt; ago(90d)</span><br><span class="line">| extend ActorName = iif(</span><br><span class="line">    isnotempty(tostring(InitiatedBy[&quot;user&quot;])),</span><br><span class="line">    tostring(InitiatedBy[&quot;user&quot;][&quot;userPrincipalName&quot;]),</span><br><span class="line">    tostring(InitiatedBy[&quot;app&quot;][&quot;displayName&quot;])</span><br><span class="line">)</span><br><span class="line">| extend ActorID = iif(</span><br><span class="line">    isnotempty(tostring(InitiatedBy[&quot;user&quot;])),</span><br><span class="line">    tostring(InitiatedBy[&quot;user&quot;][&quot;id&quot;]),</span><br><span class="line">    tostring(InitiatedBy[&quot;app&quot;][&quot;id&quot;])</span><br><span class="line">)</span><br><span class="line">| where isnotempty(ActorName)</span><br><span class="line">| join kind=inner (IdentityInfo</span><br><span class="line">    | where TimeGenerated &gt; ago(7d)</span><br><span class="line">    | where strlen(tostring(AssignedRoles)) &gt; 2</span><br><span class="line">    | summarize arg_max(TimeGenerated, *) by AccountUPN</span><br><span class="line">    | project AccountObjectId, AssignedRoles)</span><br><span class="line">    on $left.ActorID == $right.AccountObjectId</span><br><span class="line">| summarize Operations = make_set(OperationName) by ActorName, ActorID, Identity, tostring(AssignedRoles)</span><br><span class="line">| extend OperationsCount = array_length(Operations)</span><br><span class="line">| project ActorName, AssignedRoles, Operations, OperationsCount, ActorID, Identity</span><br><span class="line">| sort by OperationsCount desc</span><br></pre></td></tr></table></figure><p>このクエリを使用すると、Entra ID でタスクを実行したすべてのアカウントの結果が返されますので、着目したい特権操作以外の情報も大量に含まれている可能性があります。特定の Entra ID ロールに絞ってフィルタリングするには、以下のクエリを実行します。例として 3 つのロールの結果を出すようにしていますが、追加で複数のロールを含めていただいて構いません。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">let PrivilegedRoles = dynamic([&quot;Global Administrator&quot;,</span><br><span class="line">                               &quot;Security Administrator&quot;,</span><br><span class="line">                               &quot;Compliance Administrator&quot;</span><br><span class="line">                              ]);</span><br><span class="line">AuditLogs</span><br><span class="line">| where TimeGenerated &gt; ago(90d)</span><br><span class="line">| extend ActorName = iif(</span><br><span class="line">    isnotempty(tostring(InitiatedBy[&quot;user&quot;])),</span><br><span class="line">    tostring(InitiatedBy[&quot;user&quot;][&quot;userPrincipalName&quot;]),</span><br><span class="line">    tostring(InitiatedBy[&quot;app&quot;][&quot;displayName&quot;])</span><br><span class="line">)</span><br><span class="line">| extend ActorID = iif(</span><br><span class="line">    isnotempty(tostring(InitiatedBy[&quot;user&quot;])),</span><br><span class="line">    tostring(InitiatedBy[&quot;user&quot;][&quot;id&quot;]),</span><br><span class="line">    tostring(InitiatedBy[&quot;app&quot;][&quot;id&quot;])</span><br><span class="line">)</span><br><span class="line">| where isnotempty(ActorName)</span><br><span class="line">| join kind=inner (IdentityInfo</span><br><span class="line">    | where TimeGenerated &gt; ago(7d)</span><br><span class="line">    | where strlen(tostring(AssignedRoles)) &gt; 2</span><br><span class="line">    | summarize arg_max(TimeGenerated, *) by AccountUPN</span><br><span class="line">    | project AccountObjectId, AssignedRoles)</span><br><span class="line">    on $left.ActorID == $right.AccountObjectId</span><br><span class="line">| where AssignedRoles has_any (PrivilegedRoles)</span><br><span class="line">| summarize Operations = make_set(OperationName) by ActorName, ActorID, Identity, tostring(AssignedRoles)</span><br><span class="line">| extend OperationsCount = array_length(Operations)</span><br><span class="line">| project ActorName, AssignedRoles, Operations, OperationsCount, ActorID, Identity</span><br><span class="line">| sort by OperationsCount desc</span><br></pre></td></tr></table></figure><p>クエリを実行すると、その結果から、Entra ID テナントで実行されたアクティビティと、それらのアカウントにどのようなロールが割り当てられているかがわかります。以下の例では、上 2 つの結果には何の問題もありません。しかし、3 行目を見ると、グローバル管理者ロールを持つユーザーが、サービス プリンシパルを作成したことがわかります。</p><p>サービス プリンシパルを作成する場合、グローバル管理者ロールよりも低い権限で実施できます。したがって、このユーザーにはより低い権限のロールを付与すべきです。付与可能なロールを確認するには、Entra ID で特定のタスクを実行するために必要な最も権限の低いロールが記載されている <a href="https://learn.microsoft.com/ja-jp/entra/identity/role-based-access-control/delegate-by-task">このリスト</a> を確認ください。</p><p><img src="/blog/azure-active-directory/easily-manage-privileged-role-assignments-with-auditlogs/easily-manage-privileged-role-assignments-with-auditlogs3.png"></p><h2 id="Log-Analytics-を利用する方法"><a href="#Log-Analytics-を利用する方法" class="headerlink" title="Log Analytics を利用する方法"></a>Log Analytics を利用する方法</h2><p><img src="/blog/azure-active-directory/easily-manage-privileged-role-assignments-with-auditlogs/easily-manage-privileged-role-assignments-with-auditlogs4.png"></p><p>Entra ID の監査ログを Log Analytics ワークスペースに取り込むには、<a href="https://learn.microsoft.com/ja-jp/entra/identity/monitoring-health/howto-integrate-activity-logs-with-azure-monitor-logs">こちら</a> の手順を参照ください。</p><p>付与されたロールを含むテーブルはないため、クエリにユーザーの一覧を追加してフィルタリングする必要があります。特定の Entra ID ロールが割り当てられているユーザーの一覧を取得するには、いくつかの方法があります。</p><p>簡単な方法は、Entra ID にアクセスし、[ロールと管理者] のブレードを選択することです。そこからロールを選択し、ロールが割り当てられた ID をすべてエクスポートしておきます。特権ユーザーの UPN を取得しておくことが重要です。これはユーザーが持つロールと一緒に、これらの UPN をクエリに追加する必要があるためです。クエリ自体にいくつかロールの例を示していいます。ユーザーが複数のロールを持つ場合は、すべてのロールをクエリに追加ください。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">datatable(UserPrincipalName:string, Roles:dynamic) [</span><br><span class="line">    &quot;admin@contoso.com&quot;, dynamic([&quot;Global Administrator&quot;]),</span><br><span class="line">    &quot;admin2@contoso.com&quot;, dynamic([&quot;Global Administrator&quot;, &quot;Security Administrator&quot;]),</span><br><span class="line">    &quot;admin3@contoso.com&quot;, dynamic([&quot;Compliance Administrator&quot;])</span><br><span class="line">]</span><br><span class="line">| join kind=inner (AuditLogs</span><br><span class="line">    | where TimeGenerated &gt; ago(90d)</span><br><span class="line">    | extend ActorName = iif(</span><br><span class="line">        isnotempty(tostring(InitiatedBy[&quot;user&quot;])),</span><br><span class="line">        tostring(InitiatedBy[&quot;user&quot;][&quot;userPrincipalName&quot;]),</span><br><span class="line">        tostring(InitiatedBy[&quot;app&quot;][&quot;displayName&quot;])</span><br><span class="line">    )</span><br><span class="line">    | extend ActorID = iif( </span><br><span class="line">        isnotempty(tostring(InitiatedBy[&quot;user&quot;])),</span><br><span class="line">        tostring(InitiatedBy[&quot;user&quot;][&quot;id&quot;]),</span><br><span class="line">        tostring(InitiatedBy[&quot;app&quot;][&quot;id&quot;])</span><br><span class="line">    )</span><br><span class="line">    | where isnotempty(ActorName) ) on $left.UserPrincipalName == $right.ActorName</span><br><span class="line">| summarize Operations = make_set(OperationName) by ActorName, ActorID, tostring(Roles)</span><br><span class="line">| extend OperationsCount = array_length(Operations)</span><br><span class="line">| project ActorName, Operations, OperationsCount, Roles, ActorID</span><br><span class="line">| sort by OperationsCount desc</span><br></pre></td></tr></table></figure><p>クエリを実行すると、フィルタリングしたユーザーによって Entra ID テナントで実行されたアクティビティ情報が得られます。以下の例では、上 2 つの結果に問題があるということがわかります。どちらもグローバル管理者ロールを持っていますが、これらの操作にはグローバル管理者ロールは必要なく、グローバル管理者以外のロールでも実施できます。したがって、これらのユーザーにはより低い権限のロールを付与しなおすべきです。どのロールを付与できるかは、<a href="https://learn.microsoft.com/ja-jp/entra/identity/role-based-access-control/delegate-by-task">このリスト</a> を確認し、Entra ID で特定のタスクを実行するために必要な最も権限の低いロールを確認ください。</p><p><img src="/blog/azure-active-directory/easily-manage-privileged-role-assignments-with-auditlogs/easily-manage-privileged-role-assignments-with-auditlogs5.png"></p><p>上記例の 1 行目に関して、このユーザーがそれでもグローバル管理者ロールを必要とする場合、グローバル管理者にはセキュリティ管理者ロールよりも多くの権限が含まれているため、セキュリティ管理者ロールは冗長になります。セキュリティ管理者ロールを外しても問題ありません。</p><h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>必要のない権限を持つアカウントをそのままにしておくと、攻撃の対象範囲を必要以上に大きくしておくことになります。Entra ID 監査ログを取り込むことで、不要で過剰なロールを持つユーザーを特定し、適切な代替ロールに割り当て直すことが可能です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは！ Azure ID チームの小出です。&lt;/p&gt;
&lt;p&gt;本記事は、2024 年 1 月 8 日に公開された &lt;a href=&quot;https://techcommunity.microsoft.com/t5/microsoft-entra-blog/easily-ma</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>一度 Microsoft Entra ハイブリッド参加を正しく構成完了したにも関わらず [保留中] と表示される</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/hybrid-pending-device/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/hybrid-pending-device/</id>
    <published>2024-02-10T23:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.395Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 名取 です。</p><p>弊社サポートでは、”一度 Microsoft Entra ハイブリッド参加を正しく構成完了したにも関わらず [保留中] と表示される” というご申告を頂戴することがあります。この事象については下記公開情報で解説されています。</p><p><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/active-directory/pending-devices/">Microsoft Entra ID の保留中のデバイス</a></p><p>上記公開情報をより分かりやすくするため、本ブログを用意しました。</p><h2 id="本ブログで取り扱うデバイス状態"><a href="#本ブログで取り扱うデバイス状態" class="headerlink" title="本ブログで取り扱うデバイス状態"></a>本ブログで取り扱うデバイス状態</h2><p>まず、本ブログにて取り扱うデバイス状態についてご説明します。デバイス状態を確認することができるコマンド [dsregcmd /status] の結果が、下図のように表記されている状態が対象です。</p><p><img src="/blog/azure-active-directory/hybrid-pending-device/command.png"></p><p>AzureADJoined : YES<br>DomainJoined : YES<br>DeviceAuthStatus : FAILED. Device is either disabled or deleted.</p><p>また、Microsoft Entra ID 上では登録済み欄が [保留中] となっている状態を表します。</p><p><img src="/blog/azure-active-directory/hybrid-pending-device/Microsoft_Entra.png"></p><h2 id="登録済み-欄の日付が-保留中-に戻ることはありません"><a href="#登録済み-欄の日付が-保留中-に戻ることはありません" class="headerlink" title="[登録済み] 欄の日付が [保留中] に戻ることはありません"></a>[登録済み] 欄の日付が [保留中] に戻ることはありません</h2><p>お客様によっては、前述の登録済み欄が「日付から保留中に変化した」と誤解される方がいます。しかしながら、登録済み欄は、[保留中] から [日付] に変化することはあっても、[日付] から [保留中] に変化することはありません。</p><h2 id="この状態が発生する仕組み"><a href="#この状態が発生する仕組み" class="headerlink" title="この状態が発生する仕組み"></a>この状態が発生する仕組み</h2><p>では、何故 Microsoft Entra ハイブリッド参加を正しく構成したにもかかわらず、その後上図のようなデバイス状態となるのでしょうか。それは、一度 Microsoft Entra ハイブリッド参加が構成完了したあとに、Microsoft Entra ID 上から対象のデバイス オブジェクトが何らか削除されたからです。Microsoft Entra ID 上から対象のデバイス オブジェクトが削除された後に、再度 Microsoft Entra Connect によってデバイス情報が同期されると、Microsoft Entra ID の視点では “新たにデバイス オブジェクトが同期された” ことになるため、登録済み欄が [保留中] のデバイス オブジェクトが作成されます。そのため、Microsoft Entra ID 上に対象デバイスが新規に作成されますが、実際の対象デバイス上ではすでに Microsoft Entra ハイブリッド参加の構成が完了しているため、参加処理を改めて開始する動作は発生しません。</p><p>つまり、デバイス側は自身を参加済みと認識しており、Microsoft Entra ID 側は参加ステップの開始状態 (デバイスからの参加処理待ち) という状態になるため、登録済み欄は [日付] へ変更することなく、[保留中] のまま残り続けます。</p><h2 id="この事象が発生するシナリオ"><a href="#この事象が発生するシナリオ" class="headerlink" title="この事象が発生するシナリオ"></a>この事象が発生するシナリオ</h2><p>本事象に該当するデバイス オブジェクトの削除が発生する主なシナリオには下記の 2 つがあります。</p><ul><li><p>1 つ目のシナリオ: 管理者ロールを持つユーザーが、Azure ポータルやコマンドなどで、Microsoft  Entra ID 上から該当デバイスを削除した場合</p><p>  <img src="/blog/azure-active-directory/hybrid-pending-device/device.png"></p></li><li><p>2 つ目のシナリオ: オンプレミス AD 上で該当のコンピューターアカウントが Microsoft Entra Connect の同期対象外 OU に移動された後に、Microsoft Entra Connect の同期が行われた場合</p><p>  <img src="/blog/azure-active-directory/hybrid-pending-device/users_and_computers.png"></p></li></ul><h2 id="本事象の解消方法"><a href="#本事象の解消方法" class="headerlink" title="本事象の解消方法"></a>本事象の解消方法</h2><p>一度 Microsoft Entra ハイブリッド参加を正しく構成完了したにも関わらず [保留中] と表示される状態になった場合は、対象デバイスの Microsoft Entra ハイブリッド参加の構成を解除し、その後再構成することで解消します。再構成の手順は下記の弊社ブログをご参照ください。</p><p><a href="/blog/azure-active-directory/microsoft-entra-hybrid-joined-re-registration-simplified/">Microsoft Entra ハイブリッド参加を再構成する (簡易版)</a></p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>以上、”一度 Microsoft Entra ハイブリッド参加を正しく構成完了したにも関わらず [保留中] と表示される” 事象について解説いたしました。上記内容が皆様の参考となりますと幸いです。ご不明な点等がありましたら、ぜひ弊社サポート サービスをご利用ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 名取 です。&lt;/p&gt;
&lt;p&gt;弊社サポートでは、”一度 Microsoft Entra ハイブリッド参加を正しく構成完了したにも関わらず [保留中] と表示される” というご申告を頂戴することがあります。この事象に</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Troubleshooting" scheme="https://jpazureid.github.io/blog/tags/Troubleshooting/"/>
    
    <category term="Hybrid Azure AD Join" scheme="https://jpazureid.github.io/blog/tags/Hybrid-Azure-AD-Join/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Graph PowerShell SDK への移行について 6_ロール割り当て</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement6/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement6/</id>
    <published>2024-01-21T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.131Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、 Azure Identity サポート チームの小出です。</p><p>この記事は、MSOnline / AzureAD モジュール廃止について、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement1/">1. 概要編</a>、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement2/">2. 移行導入編</a>、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement3/">3. インストール・接続編</a> の続きとして連載しています。<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement4/">4. ではユーザーに関する操作</a> を、 <a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement5/">5. ではグループに関する操作</a> についておまとめしましたので、今回の 6. では、Microsoft Entra (Azure AD) ロールの管理について情報をまとめました。</p><p>まだ Microsoft Graph PowerShell SDK モジュールをインストールしていない場合や、Connect-MgGraph コマンドを使用した接続方法が分からない場合などは、本シリーズの 2. と 3. をご確認ください。</p><p>なお、下記にはいくつか簡易的なスクリプトの案内などもございますが、こちらのカスタマイズに関するお問い合わせは承っておりません。あくまでもサンプルとなりますので参考として利用いただき、カスタマイズにつきましてはお客様自身で実施くださいますようお願い申し上げます。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>ロールの管理については、Microsoft Entra Premium P2 もしくは Microsoft Entra ID Governance ライセンスをお持ちかどうかで、推奨される Graph API が変わります。この記事をご覧になる前に、まずは Azure ポータルにサインインし、Microsoft Entra ID を開いた下記画面の表示をご確認ください。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-1.png"></p><p>上記画面の表示内容によって、下記のように本記事をご利用ください。ライセンスによって推奨する項目が違う理由は、Microsoft Entra ID P2 以上をお持ちの場合、PIM の機能を活用できるためです。P2 ライセンスをお持ちでも Free や P1 ライセンスで提供されている API を利用することは可能ですが、これらの API では PIM で提供される「資格のある割り当て」および「期限付きの割り当て」といった情報を取得できません。このため、P2 ライセンスをお持ちのお客様には、機能をフル活用するために PIM 用の API を利用したロール管理をお勧めします。</p><table><thead><tr><th>表示されているライセンス名</th><th>確認いただきたい本記事の章と関連する Graph API ドキュメントへのリンク</th></tr></thead><tbody><tr><td>Microsoft Entra ID Free</td><td><a href="https://learn.microsoft.com/ja-JP/entra/identity/role-based-access-control/custom-assign-graph">ロール管理用 API を利用したロール管理</a></td></tr><tr><td>Microsoft Entra ID P1</td><td><a href="https://learn.microsoft.com/ja-JP/entra/identity/role-based-access-control/custom-assign-graph">ロール管理用 API を利用したロール管理</a></td></tr><tr><td>Microsoft Entra ID P2</td><td><a href="https://learn.microsoft.com/ja-jp/graph/api/resources/privilegedidentitymanagementv3-overview?view=graph-rest-1.0">PIM 用 API を利用したロール管理</a></td></tr></tbody></table><h2 id="ロール管理用-API-を利用したロール管理"><a href="#ロール管理用-API-を利用したロール管理" class="headerlink" title="ロール管理用 API を利用したロール管理"></a>ロール管理用 API を利用したロール管理</h2><p>以下に、よくあるロール管理コマンドについて紹介いたします。API の詳細について確認されたい場合は、 <a href="https://learn.microsoft.com/ja-jp/graph/api/resources/rolemanagement?view=graph-rest-1.0">roleManagement リソースの種類 - Microsoft Graph v1.0</a> の公開情報の配下に、各 API の詳細について記載がありますのでそちらをご覧ください。</p><h3 id="1-1-Microsoft-Entra-ID-ロールの-roledefinitionID-と名前の一覧を取得したい"><a href="#1-1-Microsoft-Entra-ID-ロールの-roledefinitionID-と名前の一覧を取得したい" class="headerlink" title="1-1. Microsoft Entra ID ロールの roledefinitionID と名前の一覧を取得したい"></a>1-1. Microsoft Entra ID ロールの roledefinitionID と名前の一覧を取得したい</h3><p>Get-MgRoleManagementDirectoryRoleDefinition コマンドを実行することで、ロール定義の表示名、 ID、テンプレート ID (roledefinitionid)、説明などが表示されます。このコマンドで取得できる TemplateID はどのテナントも同じ共通した値となります。ただし、カスタム ロールはそのテナントに固有のロールとなりますため、ID やテンプレート ID は各テナントで独自の値となります。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-2.png"></p><h3 id="2-1-グローバル管理者ロールを持っているユーザーを取得したい"><a href="#2-1-グローバル管理者ロールを持っているユーザーを取得したい" class="headerlink" title="2-1. グローバル管理者ロールを持っているユーザーを取得したい"></a>2-1. グローバル管理者ロールを持っているユーザーを取得したい</h3><p>以下のコマンドを利用すると、グローバル管理者 (テンプレート ID: 62e90394-69f5-4237-9190-012177145e10) ロールを持つユーザーを一覧することができます。この 62e9 から始まる ID が、グローバル管理者ロールを示しています。この 62e9 から始まる ID は、どのテナントでも共通するテンプレート ID です。そのため、下記コマンドをそのまま実行すれば、下記のようにグローバル管理者ロールを持っているユーザーを取得可能です。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-All</span> <span class="literal">-Filter</span> <span class="string">&quot;roleDefinitionId eq &#x27;62e90394-69f5-4237-9190-012177145e10&#x27;&quot;</span> <span class="literal">-ExpandProperty</span> <span class="string">&quot;principal&quot;</span></span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-3.png"></p><p>なお、この例の場合、PrincipalID にユーザーの ObjectID が表示されておりますが、一見誰にロールが割り当てられているかが分かりにくいと思います。上記コマンドでは ExpandProperty オプションを利用して、 principal の中身 (ロールが割り当てられているユーザーなどの情報が格納されている) を取得していますので、中身を展開するようにコマンドを記載すれば、オブジェクト ID ではない値を表示することが可能です。例えば以下では、グローバル管理者ロールを持つユーザーの UserPrincipalName のみ取得するようなコマンドにしています。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">(<span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-Filter</span> <span class="string">&quot;roleDefinitionId eq &#x27;62e90394-69f5-4237-9190-012177145e10&#x27;&quot;</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> <span class="string">&quot;principal&quot;</span>).principal.additionalproperties.userPrincipalName</span><br></pre></td></tr></table></figure><p>上記を実行すると、以下のような結果が返され、誰にロールがあるのかすぐに判断いただけます。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-4.png"></p><h3 id="2-2-何かしらのロールを持っているユーザーを取得したい"><a href="#2-2-何かしらのロールを持っているユーザーを取得したい" class="headerlink" title="2-2. 何かしらのロールを持っているユーザーを取得したい"></a>2-2. 何かしらのロールを持っているユーザーを取得したい</h3><p>以下のように実行することで何かしらのロールを持っているユーザーを取得できます。まずすべてのロール割り当てを取得し、上記例と同様に UPN のみを取得します。パイプ（|）の左側だけですと、1 人のユーザーが 2 つ以上のロールを保持している場合に、同じ UPN が 2 回以上結果に含まれてしまいます。そのため、Sort-Object にてUPN 一覧を並び替え、重複を排除するために Get-Unique を利用しています。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">(<span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal).principal.additionalproperties.userPrincipalName | <span class="built_in">Sort-Object</span> | <span class="built_in">Get-Unique</span></span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-5.png"></p><h3 id="2-3-特定のカスタム-ロールを持っているユーザーを取得したい"><a href="#2-3-特定のカスタム-ロールを持っているユーザーを取得したい" class="headerlink" title="2-3. 特定のカスタム ロールを持っているユーザーを取得したい"></a>2-3. 特定のカスタム ロールを持っているユーザーを取得したい</h3><p>まずはカスタム ロール一覧から、特定のカスタム ロールの ID 取得します。その後、2-1 と同様に ID を指定して実行します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-MgRoleManagementDirectoryRoleDefinition</span> | <span class="built_in">where</span> &#123;<span class="variable">$_</span>.isBuiltIn <span class="operator">-eq</span> <span class="variable">$false</span>&#125;</span><br><span class="line">(<span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-Filter</span> <span class="string">&quot;roleDefinitionId eq &#x27;6be2f6bb-cfc4-48df-8beb-51a538ec1cdf&#x27;&quot;</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> <span class="string">&quot;principal&quot;</span>).principal.additionalproperties.userPrincipalName</span><br></pre></td></tr></table></figure><p>もし、特定のカスタム ロールではなく、カスタム ロールのいずれかを持っているユーザーを一括して抽出したい場合は、下記が便利です。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">in</span> <span class="variable">$customrole</span>)&#123;(<span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span>  <span class="literal">-ExpandProperty</span> <span class="string">&quot;principal&quot;</span> <span class="literal">-All</span> | <span class="built_in">where</span> &#123;<span class="variable">$_</span>.roleDefinitionId <span class="operator">-eq</span> <span class="variable">$a</span>&#125;).principal.additionalproperties.userPrincipalName&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-何かしらのロールを持っているゲスト-ユーザーを取得したい"><a href="#2-4-何かしらのロールを持っているゲスト-ユーザーを取得したい" class="headerlink" title="2-4. 何かしらのロールを持っているゲスト ユーザーを取得したい"></a>2-4. 何かしらのロールを持っているゲスト ユーザーを取得したい</h3><p>2-2 のコマンドと似ていますが、違いは「ゲスト ユーザーのみ」に絞り込む点です。2-2 のコマンドを実行すると、何かしらのロールを保持しているユーザーの UPN 一覧を取得できます。ゲスト ユーザーの場合、UPN には #EXT# という値が含まれる特徴があるので、こちらをキーワードにゲスト ユーザーを抽出します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">(<span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal).principal.additionalproperties.userPrincipalName | <span class="built_in">Sort-Object</span> | <span class="built_in">Get-Unique</span> | <span class="built_in">where-object</span> &#123;<span class="variable">$_</span> <span class="operator">-like</span> <span class="string">&quot;*#EXT#*&quot;</span>&#125;</span><br></pre></td></tr></table></figure><h3 id="3-新しいロール割り当ての作成"><a href="#3-新しいロール割り当ての作成" class="headerlink" title="3. 新しいロール割り当ての作成"></a>3. 新しいロール割り当ての作成</h3><p>PrincipalID に取得したいユーザーの ObjectID を指定します。 Roledefinitionid には、付与したいロールのテンプレート ID を指定します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$params</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    <span class="string">&quot;@odata.type&quot;</span> = <span class="string">&quot;#microsoft.graph.unifiedRoleAssignment&quot;</span></span><br><span class="line">    roleDefinitionId = <span class="string">&quot;62e90394-69f5-4237-9190-012177145e10&quot;</span></span><br><span class="line">    principalId = <span class="string">&quot;0b3cc095-ad6f-40cc-982f-7c71a2cf9bc7&quot;</span></span><br><span class="line">    directoryScopeId = <span class="string">&quot;/&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-6.png"></p><h3 id="4-既存のロール割り当ての削除"><a href="#4-既存のロール割り当ての削除" class="headerlink" title="4. 既存のロール割り当ての削除"></a>4. 既存のロール割り当ての削除</h3><p>上記 2-1 のように、Get-MgRoleManagementDirectoryRoleAssignment コマンドを取得して、削除したいロール割り当ての ID を取得します。この ID はテナントごと、割り当てごとに異なるため、事前に割り当て一覧を取得して ID を確認する必要があります。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-7.png"></p><p>そのうえで、下記のようにコマンドを実行し、ロールの割り当てを削除します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Remove-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-UnifiedRoleAssignmentId</span> oz6hWDLGrkae4JwNQ81_Peq74fvkTYBMiWoJNnv0Wyk<span class="literal">-1</span></span><br></pre></td></tr></table></figure><h3 id="5-新しいカスタム-ロールの作成"><a href="#5-新しいカスタム-ロールの作成" class="headerlink" title="5. 新しいカスタム ロールの作成"></a>5. 新しいカスタム ロールの作成</h3><p><a href="https://learn.microsoft.com/ja-jp/graph/api/rbacapplication-post-roledefinitions?view=graph-rest-1.0&tabs=http">roleDefinitions を作成する - Microsoft Graph v1.0</a> の手順を用いて、ロールの定義を作成します。カスタム ロールの名前を displayName、説明を description に記載し、実際に許可したいアクセス権を rolePermissions 内に記載します。</p> <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$params</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    description = <span class="string">&quot;Update basic properties of application registrations&quot;</span></span><br><span class="line">    displayName = <span class="string">&quot;Application Registration Support Administrator&quot;</span></span><br><span class="line">    rolePermissions = <span class="selector-tag">@</span>(</span><br><span class="line">        <span class="selector-tag">@</span>&#123;</span><br><span class="line">            allowedResourceActions = <span class="selector-tag">@</span>(</span><br><span class="line">                <span class="string">&quot;microsoft.directory/applications/basic/read&quot;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    isEnabled = <span class="variable">$true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-MgRoleManagementDirectoryRoleDefinition</span> <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure><h2 id="ロール管理用-API-を利用したサンプル-スクリプト"><a href="#ロール管理用-API-を利用したサンプル-スクリプト" class="headerlink" title="ロール管理用 API を利用したサンプル スクリプト"></a>ロール管理用 API を利用したサンプル スクリプト</h2><p>上記コマンドを利用したサンプル スクリプトを以下に案内します。改めまして、スクリプトの代理作成やカスタマイズ、スクリプト自体のデバッグなどの支援は弊社サポートでは承っておりませんので、あらかじめご了承ください。下記のようなお問い合わせであればご支援可能ですので、その際は事前に切り分けや動作確認などを実施のうえ、一問一答形式にてお問い合わせを発行ください。</p><ul><li>スクリプトの中で「ユーザーを取得する」コマンドとして Get-MgUser が記載されているが、これをゲストのみにしたい場合はどうしたらいいか (Get-Mguser のフィルターの使い方など、Graph API クエリもしくはコマンドの記載方法についての一問一答のご質問)。</li><li>スクリプトを実行するとエラーになってしまう。切り分けとしてコマンド単体でも実行したが同じエラーになった (スクリプトではなく、コマンドの動作に関するトラブル シューティング)。</li></ul><p>Graph PowerShell コマンドで取得した内容を CSV に出力させたいというご要望がよくございますので、今回は結果を CSV に出力するサンプルを以下に紹介いたします。以下ではオブジェクトに対するロール割り当てを取得し、割り当てられているオブジェクトの表示名、ID、ロールの名前を CSV に出力します。また、後半部分では、下記公開情報にて案内のある「特権としてみなされるロールに対し割り当てを持っているユーザーについて、その数を確認し、多すぎる場合には削減する」旨の推奨メッセージを出しています。</p><p><a href="https://learn.microsoft.com/ja-jp/entra/identity/role-based-access-control/privileged-roles-permissions?tabs=ms-powershell">Microsoft Entra ID の特権を持つロールとアクセス許可 (プレビュー) - Microsoft Entra ID</a></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 全特権ロールの割り当て一覧を取得して、ロール名と併せて CSV に出力する。</span></span><br><span class="line"><span class="variable">$data</span> = <span class="selector-tag">@</span>()</span><br><span class="line"><span class="variable">$data</span> += <span class="string">&quot;asignee,asignee-objectid,rolename&quot;</span></span><br><span class="line"><span class="variable">$result</span> = <span class="built_in">Get-MgBetaRoleManagementDirectoryRoleAssignment</span> <span class="literal">-ExpandProperty</span> <span class="string">&quot;Principal&quot;</span> <span class="literal">-Filter</span> <span class="string">&quot;roleDefinition/isPrivileged eq true&quot;</span> <span class="literal">-All</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$n</span> <span class="keyword">in</span> <span class="variable">$result</span>) &#123;</span><br><span class="line">    <span class="variable">$displayname</span> = <span class="variable">$n</span>.principal.additionalProperties.displayName</span><br><span class="line">    <span class="variable">$objectID</span> = <span class="variable">$n</span>.principalID</span><br><span class="line">    <span class="variable">$rolename</span> = (<span class="built_in">Get-MgRoleManagementDirectoryRoleDefinition</span> <span class="literal">-UnifiedRoleDefinitionId</span> <span class="variable">$n</span>.RoleDefinitionId).displayname</span><br><span class="line"></span><br><span class="line">    <span class="variable">$data</span> += <span class="variable">$displayname</span> + <span class="string">&quot;,&quot;</span> + <span class="variable">$objectID</span> + <span class="string">&quot;,&quot;</span> + <span class="variable">$rolename</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$outfile</span> = <span class="string">&quot;C:\Work\roleassginment.csv&quot;</span></span><br><span class="line"><span class="variable">$data</span> | <span class="built_in">Out-File</span> <span class="variable">$outfile</span> <span class="literal">-encoding</span> <span class="string">&quot;utf8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 特権ロール扱いのロールについて、それぞれ割り当てが 10 以上なら画面に削減するよう表示する。</span></span><br><span class="line"><span class="variable">$privadmins</span> = <span class="built_in">Get-MgBetaRoleManagementDirectoryRoleDefinition</span> <span class="literal">-Filter</span> <span class="string">&quot;isPrivileged eq true&quot;</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$priv</span> <span class="keyword">in</span> <span class="variable">$privadmins</span>) &#123;</span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$priv</span>.id</span><br><span class="line">    <span class="variable">$count</span> = ( <span class="built_in">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="literal">-All</span> | <span class="built_in">where</span> &#123;<span class="variable">$_</span>.roledefinitionid <span class="operator">-eq</span> <span class="variable">$id</span>&#125;).count</span><br><span class="line">    <span class="keyword">If</span>(<span class="variable">$count</span> <span class="operator">-ge</span> <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="variable">$role_displayname</span> = <span class="variable">$priv</span>.displayname</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;<span class="variable">$role_displayname</span> の管理者数が多すぎます。推奨は 10 人以下（グローバル管理者は 5 人以下）です。現在の数は <span class="variable">$count</span> です。先に出力した CSV を利用して、ロールが割り当てられているユーザーを確認し、削減を検討してください。&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CSV 結果</strong></p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-8.png"></p><p><strong>表示メッセージの例</strong></p><p>User Administrator の管理者数が多すぎます。推奨は 10 人以下（グローバル管理者は 5 人以下）です。現在の数は 11 です。先に出力した CSV を利用して、ロールが割り当てられているユーザーを確認し、削減を検討してください。</p><h2 id="PIM-用-API-を利用したロール管理"><a href="#PIM-用-API-を利用したロール管理" class="headerlink" title="PIM 用 API を利用したロール管理"></a>PIM 用 API を利用したロール管理</h2><p>PIM を利用したよくあるロール管理コマンドについて以下に紹介いたします。API の詳細について確認されたい場合は、<a href="https://learn.microsoft.com/ja-jp/graph/api/resources/privilegedidentitymanagementv3-overview?view=graph-rest-1.0">特権 ID 管理 (PIM) API を使用してMicrosoft Entraロールの割り当てを管理する - Microsoft Graph v1.0</a> の公開情報の配下に、各 API の詳細について記載がありますのでそちらをご覧ください。</p><p>アクティブな割り当て (Active Assignments) に関する操作と、資格のある割り当て (Eligible Assignments) で API やコマンドが異なるため、コマンドを探す際にはまず、「今操作したい割り当ての種類はどちらか？」を明確にして、該当する情報を探していくようにすると便利です。</p><h3 id="1-1-PIM-でアクティブもしくは資格のある割り当てを問わずグローバル管理者ロールを持っているユーザーを取得したい"><a href="#1-1-PIM-でアクティブもしくは資格のある割り当てを問わずグローバル管理者ロールを持っているユーザーを取得したい" class="headerlink" title="1-1. PIM でアクティブもしくは資格のある割り当てを問わずグローバル管理者ロールを持っているユーザーを取得したい"></a>1-1. PIM でアクティブもしくは資格のある割り当てを問わずグローバル管理者ロールを持っているユーザーを取得したい</h3><p>資格のある割り当てとアクティブな割り当てでコマンドが異なるため、2 つコマンドを実行する必要がありますが、下記にて取得可能です。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 資格のある割り当てを持っているグローバル管理者を取得する。</span></span><br><span class="line">(<span class="built_in">Get-MgRoleManagementDirectoryRoleEligibilityScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-Filter</span> <span class="string">&quot;RoleDefinitionId eq &#x27;62e90394-69f5-4237-9190-012177145e10&#x27;&quot;</span> <span class="literal">-ExpandProperty</span> Principal).principal.AdditionalProperties.userPrincipalName</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># アクティブな割り当てを持っているグローバル管理者を取得する。</span></span><br><span class="line">(<span class="built_in">Get-MgRoleManagementDirectoryRoleAssignmentScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-Filter</span> <span class="string">&quot;RoleDefinitionId eq &#x27;62e90394-69f5-4237-9190-012177145e10&#x27;&quot;</span> <span class="literal">-ExpandProperty</span> Principal).principal.AdditionalProperties.userPrincipalName</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-9.png"></p><h3 id="1-2-PIM-で何かしらのロールを持っているユーザーを全員取得したい"><a href="#1-2-PIM-で何かしらのロールを持っているユーザーを全員取得したい" class="headerlink" title="1-2. PIM で何かしらのロールを持っているユーザーを全員取得したい"></a>1-2. PIM で何かしらのロールを持っているユーザーを全員取得したい</h3><p>1-1 に記載されているコマンドを活用して取得できます。1-1 のコマンドでは -filter オプションの後ろで「グローバル管理者のテンプレート ID を持っている」という条件を記載しておりましたので、この部分を削除すれば何かしらのロールを持っているユーザーを全員取得できます。見やすいようにロールの名前とユーザーの UPN を取得するような構成にしました。</p><p>アプリケーションにロールを割り当てている場合、アクティブな割り当てを取得するコマンドを利用すると UPN 部分が空白として表示されます (アプリケーションは UPN を持たないため)。userPrincipalName の代わりに displayName を使用すると、アプリおよびユーザーともに表示名があるため空白なく情報を取得することができます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 何かしらの資格のある割り当てを持っているユーザーを取得する。</span></span><br><span class="line"><span class="variable">$a</span> = <span class="built_in">Get-MgRoleManagementDirectoryRoleEligibilityScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$b</span> <span class="keyword">in</span> <span class="variable">$a</span>) &#123;</span><br><span class="line">    <span class="variable">$obj</span> = <span class="built_in">New-Object</span> PSCustomObject</span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$b</span>.principal.AdditionalProperties.userPrincipalName</span><br><span class="line">    <span class="variable">$role</span> = (<span class="built_in">Get-MgRoleManagementDirectoryRoleDefinition</span> <span class="literal">-UnifiedRoleDefinitionId</span> <span class="variable">$b</span>.RoledefinitionID).displayname</span><br><span class="line">    <span class="variable">$obj</span> | <span class="built_in">Add-Member</span> <span class="literal">-NotePropertyMembers</span> <span class="selector-tag">@</span>&#123;</span><br><span class="line">        username = <span class="variable">$user</span></span><br><span class="line">        rolename = <span class="variable">$role</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$obj</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 何かしらのアクティブな割り当てを持っているユーザーを取得する。</span></span><br><span class="line"><span class="variable">$a</span> = <span class="built_in">Get-MgRoleManagementDirectoryRoleAssignmentScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$b</span> <span class="keyword">in</span> <span class="variable">$a</span>) &#123;</span><br><span class="line">    <span class="variable">$obj</span> = <span class="built_in">New-Object</span> PSCustomObject</span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$b</span>.principal.AdditionalProperties.userPrincipalName</span><br><span class="line">    <span class="variable">$role</span> = (<span class="built_in">Get-MgRoleManagementDirectoryRoleDefinition</span> <span class="literal">-UnifiedRoleDefinitionId</span> <span class="variable">$b</span>.RoledefinitionID).displayname</span><br><span class="line">    <span class="variable">$obj</span> | <span class="built_in">Add-Member</span> <span class="literal">-NotePropertyMembers</span> <span class="selector-tag">@</span>&#123;</span><br><span class="line">        username = <span class="variable">$user</span></span><br><span class="line">        rolename = <span class="variable">$role</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$obj</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-10.png"></p><h3 id="1-3-PIM-で資格のある割り当てを持っているユーザーのみ取得したい"><a href="#1-3-PIM-で資格のある割り当てを持っているユーザーのみ取得したい" class="headerlink" title="1-3. PIM で資格のある割り当てを持っているユーザーのみ取得したい"></a>1-3. PIM で資格のある割り当てを持っているユーザーのみ取得したい</h3><p>何らかの資格のある割り当てをもっているユーザー一覧のみ取得したい場合は、下記を利用できます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$user</span> = (<span class="built_in">Get-MgRoleManagementDirectoryRoleEligibilityScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal).Principal.AdditionalProperties.userPrincipalName</span><br><span class="line"><span class="variable">$user</span> | <span class="built_in">sort-object</span> | <span class="built_in">Get-Unique</span></span><br></pre></td></tr></table></figure><h3 id="1-4-PIM-でもうすぐ割り当てが終了を迎えるユーザーのみを取得したい"><a href="#1-4-PIM-でもうすぐ割り当てが終了を迎えるユーザーのみを取得したい" class="headerlink" title="1-4. PIM でもうすぐ割り当てが終了を迎えるユーザーのみを取得したい"></a>1-4. PIM でもうすぐ割り当てが終了を迎えるユーザーのみを取得したい</h3><p>EndDatetime に指定されている日付をベースに、もうすぐ割り当てが終了を迎えるユーザーとロールの情報を取得することができます。資格のある割り当てとアクティブな割り当てでコマンドが異なりますが、実行方法は同じです。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 資格のある割り当て</span></span><br><span class="line"><span class="variable">$a</span> = <span class="built_in">Get-MgRoleManagementDirectoryRoleEligibilityScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal | <span class="built_in">Where</span> &#123;<span class="variable">$_</span>.EndDateTime <span class="operator">-ne</span> <span class="variable">$null</span> <span class="operator">-and</span> <span class="variable">$_</span>.EndDateTime <span class="operator">-lt</span> <span class="string">&quot;2024/1/30 0:00:00&quot;</span>&#125;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$b</span> <span class="keyword">in</span> <span class="variable">$a</span>) &#123;</span><br><span class="line">    <span class="variable">$obj</span> = <span class="built_in">New-Object</span> PSCustomObject</span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$b</span>.principal.AdditionalProperties.userPrincipalName</span><br><span class="line">    <span class="variable">$role</span> = (<span class="built_in">Get-MgRoleManagementDirectoryRoleDefinition</span> <span class="literal">-UnifiedRoleDefinitionId</span> <span class="variable">$b</span>.RoledefinitionID).displayname</span><br><span class="line">    <span class="variable">$obj</span> | <span class="built_in">Add-Member</span> <span class="literal">-NotePropertyMembers</span> <span class="selector-tag">@</span>&#123;</span><br><span class="line">        username = <span class="variable">$user</span></span><br><span class="line">        rolename = <span class="variable">$role</span></span><br><span class="line">        endDatetime = <span class="variable">$b</span>.enddatetime</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$obj</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># アクティブな割り当て</span></span><br><span class="line"><span class="variable">$a</span> = <span class="built_in">Get-MgRoleManagementDirectoryRoleAssignmentScheduleInstance</span> <span class="literal">-All</span> <span class="literal">-ExpandProperty</span> Principal | <span class="built_in">Where</span> &#123;<span class="variable">$_</span>.EndDateTime <span class="operator">-ne</span> <span class="variable">$null</span> <span class="operator">-and</span> <span class="variable">$_</span>.EndDateTime <span class="operator">-lt</span> <span class="string">&quot;2024/1/30 0:00:00&quot;</span>&#125;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$b</span> <span class="keyword">in</span> <span class="variable">$a</span>) &#123;</span><br><span class="line">    <span class="variable">$obj</span> = <span class="built_in">New-Object</span> PSCustomObject</span><br><span class="line">    <span class="variable">$user</span>=<span class="variable">$b</span>.principal.AdditionalProperties.userPrincipalName</span><br><span class="line">    <span class="variable">$role</span>= (<span class="built_in">Get-MgRoleManagementDirectoryRoleDefinition</span> <span class="literal">-UnifiedRoleDefinitionId</span> <span class="variable">$b</span>.RoledefinitionID).displayname</span><br><span class="line">    <span class="variable">$obj</span> | <span class="built_in">Add-Member</span> <span class="literal">-NotePropertyMembers</span> <span class="selector-tag">@</span>&#123;</span><br><span class="line">        username = <span class="variable">$user</span></span><br><span class="line">        rolename = <span class="variable">$role</span></span><br><span class="line">        endDatetime = <span class="variable">$b</span>.enddatetime</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$obj</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-11.png"></p><h3 id="2-PIM-で資格のある割り当てをユーザーに割り当てる-期限付き"><a href="#2-PIM-で資格のある割り当てをユーザーに割り当てる-期限付き" class="headerlink" title="2. PIM で資格のある割り当てをユーザーに割り当てる (期限付き)"></a>2. PIM で資格のある割り当てをユーザーに割り当てる (期限付き)</h3><p>以下のように実行して割り当てます。PrincipalID には割り当てるユーザーなどの ObjectID を指定し、割り当てたいロールのテンプレート ID を roleDefinitionId に指定します。期限付きにしたい場合は、expiration 内の enddatetime に終了したい日付を記載します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$params</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    action = <span class="string">&quot;adminAssign&quot;</span></span><br><span class="line">    justification = <span class="string">&quot;Assign Groups Admin to IT Helpdesk group&quot;</span></span><br><span class="line">    roleDefinitionId = <span class="string">&quot;fdd7a751-b60b-444a-984c-02652fe8fa1c&quot;</span></span><br><span class="line">    directoryScopeId = <span class="string">&quot;/&quot;</span></span><br><span class="line">    principalId = <span class="string">&quot;717d0ac2-c100-466c-aa19-c1ca506dbf77&quot;</span></span><br><span class="line">    scheduleInfo = <span class="selector-tag">@</span>&#123;</span><br><span class="line">        startDateTime = [<span class="type">System.DateTime</span>]::Parse(<span class="string">&quot;2023-12-10T00:00:00Z&quot;</span>)</span><br><span class="line">        expiration = <span class="selector-tag">@</span>&#123;</span><br><span class="line">            <span class="built_in">type</span> = <span class="string">&quot;afterDateTime&quot;</span></span><br><span class="line">            endDatetime = <span class="string">&quot;2023-12-18T00:00:00Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-MgRoleManagementDirectoryRoleEligibilityScheduleRequest</span> <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure><h3 id="3-PIM-でアクティブな割り当てをユーザーに割り当てる-期限付き"><a href="#3-PIM-でアクティブな割り当てをユーザーに割り当てる-期限付き" class="headerlink" title="3. PIM でアクティブな割り当てをユーザーに割り当てる (期限付き)"></a>3. PIM でアクティブな割り当てをユーザーに割り当てる (期限付き)</h3><p>以下のように実行して割り当てることができます。PrincipalID には割り当てるユーザーなどの ObjectID を指定し、割り当てたいロールのテンプレート ID を roleDefinitionId に指定します。期限付きにしたい場合は、expiration 内 enddatetime に終了したい日付を記載します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$params</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    action = <span class="string">&quot;adminAssign&quot;</span></span><br><span class="line">    justification = <span class="string">&quot;Assign Groups Admin to IT Helpdesk group&quot;</span></span><br><span class="line">    roleDefinitionId = <span class="string">&quot;fdd7a751-b60b-444a-984c-02652fe8fa1c&quot;</span></span><br><span class="line">    directoryScopeId = <span class="string">&quot;/&quot;</span></span><br><span class="line">    principalId = <span class="string">&quot;717d0ac2-c100-466c-aa19-c1ca506dbf77&quot;</span></span><br><span class="line">    scheduleInfo = <span class="selector-tag">@</span>&#123;</span><br><span class="line">        startDateTime = [<span class="type">System.DateTime</span>]::Parse(<span class="string">&quot;2023-12-10T00:00:00Z&quot;</span>)</span><br><span class="line">        expiration = <span class="selector-tag">@</span>&#123;</span><br><span class="line">            <span class="built_in">type</span> = <span class="string">&quot;afterDateTime&quot;</span></span><br><span class="line">            endDatetime = <span class="string">&quot;2023-12-18T00:00:00Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-MgRoleManagementDirectoryRoleAssignmentScheduleRequest</span> <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-12.png"></p><h3 id="4-PIM-でユーザーが自身でロールのアクティブ化を行う"><a href="#4-PIM-でユーザーが自身でロールのアクティブ化を行う" class="headerlink" title="4. PIM でユーザーが自身でロールのアクティブ化を行う"></a>4. PIM でユーザーが自身でロールのアクティブ化を行う</h3><p>下記公開情報の例 5. に記載のように PowerShell コマンドを実行すればユーザーが自身でロールのアクティブ化を行うことが可能です。</p><p><a href="https://learn.microsoft.com/ja-jp/graph/tutorial-assign-azureadroles?tabs=powershell#request-3">Microsoft Graph で Privileged Identity Management (PIM) API を使用して Azure AD ロールを割り当てる</a></p><p>下記 principalID にはアクティブ化を行うユーザー自身の ID を指定し、roleDefinitionID には、アクティブ化するロールのテンプレート ID を指定ください。また、理由については justification の項目を利用いただけます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scopes</span> RoleAssignmentSchedule.ReadWrite.Directory</span><br><span class="line"><span class="variable">$params</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    action = <span class="string">&quot;SelfActivate&quot;</span></span><br><span class="line">    principalId = <span class="string">&quot;3796e4df-bf11-4b99-9be7-c65c63dfe9a6&quot;</span></span><br><span class="line">    roleDefinitionId = <span class="string">&quot;a9ea8996-122f-4c74-9520-8edcd192826c&quot;</span></span><br><span class="line">    directoryScopeId = <span class="string">&quot;/&quot;</span></span><br><span class="line">    justification = <span class="string">&quot;Need to invalidate all app refresh tokens for Contoso users.&quot;</span></span><br><span class="line">    scheduleInfo = <span class="selector-tag">@</span>&#123;</span><br><span class="line">        startDateTime = [<span class="type">System.DateTime</span>]::Parse(<span class="string">&quot;2023-12-14T00:12:00.000Z&quot;</span>)</span><br><span class="line">        expiration = <span class="selector-tag">@</span>&#123;</span><br><span class="line">            <span class="built_in">type</span> = <span class="string">&quot;AfterDuration&quot;</span></span><br><span class="line">            duration = <span class="string">&quot;PT5H&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ticketInfo = <span class="selector-tag">@</span>&#123;</span><br><span class="line">        ticketNumber = <span class="string">&quot;CONTOSO:Security-012345&quot;</span></span><br><span class="line">        ticketSystem = <span class="string">&quot;Contoso ICM&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-MgRoleManagementDirectoryRoleAssignmentScheduleRequest</span> <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure><h3 id="5-PIM-の申請を承認する"><a href="#5-PIM-の申請を承認する" class="headerlink" title="5. PIM の申請を承認する"></a>5. PIM の申請を承認する</h3><p>下記のように実行することで、アクティブ化要求を PowerShell から承認することが可能です。reviewResult にて Approve と記載し、justification には承認する理由を記載してコマンドを実行してください。</p><p>なお、このコマンドは beta バージョンのコマンドが利用されておりますので、予告なくコマンドの動作に変更が加わることがございます。運用環境での利用は推奨しておりませんが、利用の際はご留意ください。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scope</span> RoleAssignmentSchedule.ReadWrite.Directory,PrivilegedAccess.ReadWrite.AzureAD</span><br><span class="line"></span><br><span class="line"><span class="built_in">Import-Module</span> Microsoft.Graph.Identity.Governance</span><br><span class="line"><span class="built_in">Import-Module</span> Microsoft.Graph.Beta.Identity.Governance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 現在承認待ちの有効化の要求を取得する。</span></span><br><span class="line"><span class="variable">$pendingApprovalRequest</span> = <span class="built_in">Get-MgRoleManagementDirectoryRoleAssignmentScheduleRequest</span> <span class="literal">-Filter</span> <span class="string">&quot;(status eq &#x27;PendingApproval&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 現在承認待ちの有効化の要求を一覧する。</span></span><br><span class="line"><span class="variable">$pendingApprovalRequest</span> | <span class="built_in">Format-List</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$roleApproval</span> = <span class="built_in">Get-MgBetaRoleManagementDirectoryRoleAssignmentApproval</span> <span class="literal">-ApprovalId</span> <span class="variable">$pendingApprovalRequest</span>.ApprovalId</span><br><span class="line"></span><br><span class="line"><span class="comment"># 承認する旨と、その理由についてここで指定する。</span></span><br><span class="line"><span class="variable">$params</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    reviewResult = <span class="string">&quot;Approve&quot;</span></span><br><span class="line">    justification = <span class="string">&quot;I approve this request&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 承認処理を行う。</span></span><br><span class="line"><span class="built_in">Update-MgBetaRoleManagementDirectoryRoleAssignmentApprovalStep</span> <span class="literal">-ApprovalId</span> <span class="variable">$roleApproval</span>.Id <span class="literal">-ApprovalStepId</span> <span class="variable">$roleApproval</span>.Steps.Id <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure><h2 id="PIM-用の-API-を利用したロール管理のサンプル-スクリプト"><a href="#PIM-用の-API-を利用したロール管理のサンプル-スクリプト" class="headerlink" title="PIM 用の API を利用したロール管理のサンプル スクリプト"></a>PIM 用の API を利用したロール管理のサンプル スクリプト</h2><p>上記コマンドを利用したサンプル スクリプトを以下に案内いたします。改めまして恐れ入りますが、スクリプトの代理作成やカスタマイズ、スクリプト自体のデバッグなどの支援は弊社サポートでは承っておりませんのでご了承ください。今回は、PIM に関するお問い合わせでよくご質問をいただく、Entra ロールと Azure ロールの PIM 設定を一括で変更するスクリプトをそれぞれ記載します。</p><h3 id="Microsoft-Entra-ロール"><a href="#Microsoft-Entra-ロール" class="headerlink" title="Microsoft Entra ロール"></a>Microsoft Entra ロール</h3><p>割り当ての最大期間は「資格のある割り当て」が 1 年、「アクティブな割り当て」が半年になっていますが、以下の例ではこれらを 2 年にするよう全ロールのポリシーを一括で更新します。ポータル上では 2 年の表示がされないため、下記のように - になりますが正しく動作します。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-13.png"></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Azure AD に接続する。</span></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scopes</span> RoleManagement.ReadWrite.Directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># Azure AD ロール用のポリシーをすべて取得する。</span></span><br><span class="line"><span class="variable">$PolicyList</span>=<span class="built_in">Get-MgPolicyRoleManagementPolicy</span> <span class="literal">-Filter</span> <span class="string">&quot;scopeId eq &#x27;/&#x27; and scopeType eq &#x27;DirectoryRole&#x27;&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># どのようなポリシーの更新を行いたいか指定します。  </span></span><br><span class="line"><span class="comment"># 資格のある割り当てのポリシーを更新し、割り当ての最大期間を 2 年（730 日）にする。</span></span><br><span class="line"><span class="variable">$params1</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    <span class="string">&quot;@odata.type&quot;</span> = <span class="string">&quot;#microsoft.graph.unifiedRoleManagementPolicyExpirationRule&quot;</span></span><br><span class="line">    id = <span class="string">&quot;Expiration_Admin_Eligibility&quot;</span></span><br><span class="line">    isExpirationRequired = <span class="string">&quot;false&quot;</span></span><br><span class="line">    maximumDuration = <span class="string">&quot;P730D&quot;</span></span><br><span class="line">    target = <span class="selector-tag">@</span>&#123;</span><br><span class="line">        <span class="string">&quot;@odata.type&quot;</span> = <span class="string">&quot;microsoft.graph.unifiedRoleManagementPolicyRuleTarget&quot;</span></span><br><span class="line">        caller = <span class="string">&quot;Admin&quot;</span></span><br><span class="line">        operations = <span class="selector-tag">@</span>(</span><br><span class="line">            <span class="string">&quot;All&quot;</span></span><br><span class="line">        )</span><br><span class="line">        level = <span class="string">&quot;Eligibility&quot;</span></span><br><span class="line">        inheritableSettings = <span class="selector-tag">@</span>()</span><br><span class="line">        enforcedSettings = <span class="selector-tag">@</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># アクティブな割り当てのポリシーを更新し、割り当ての最大期間を 2年（730 日）にする。</span></span><br><span class="line"><span class="variable">$params2</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    <span class="string">&quot;@odata.type&quot;</span> = <span class="string">&quot;#microsoft.graph.unifiedRoleManagementPolicyExpirationRule&quot;</span></span><br><span class="line">    id = <span class="string">&quot;Expiration_Admin_Assignment&quot;</span></span><br><span class="line">    isExpirationRequired = <span class="string">&quot;false&quot;</span></span><br><span class="line">    maximumDuration = <span class="string">&quot;P730D&quot;</span></span><br><span class="line">    target = <span class="selector-tag">@</span>&#123;</span><br><span class="line">        <span class="string">&quot;@odata.type&quot;</span> = <span class="string">&quot;microsoft.graph.unifiedRoleManagementPolicyRuleTarget&quot;</span></span><br><span class="line">        caller = <span class="string">&quot;Admin&quot;</span></span><br><span class="line">        operations = <span class="selector-tag">@</span>(</span><br><span class="line">            <span class="string">&quot;All&quot;</span></span><br><span class="line">        )</span><br><span class="line">        level = <span class="string">&quot;Assignment&quot;</span></span><br><span class="line">        inheritableSettings = <span class="selector-tag">@</span>()</span><br><span class="line">        enforcedSettings = <span class="selector-tag">@</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Foreach</span> (<span class="variable">$policy</span> <span class="keyword">in</span> <span class="variable">$policylist</span>) &#123;</span><br><span class="line">    <span class="comment"># 資格のある割り当てのポリシー更新</span></span><br><span class="line">    <span class="built_in">Update-MgPolicyRoleManagementPolicyRule</span> <span class="literal">-UnifiedRoleManagementPolicyId</span> <span class="variable">$policy</span>.Id <span class="literal">-UnifiedRoleManagementPolicyRuleId</span> Expiration_Admin_Eligibility <span class="literal">-BodyParameter</span> <span class="variable">$params1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># アクティブな割り当てのポリシー更新</span></span><br><span class="line">    <span class="built_in">Update-MgPolicyRoleManagementPolicyRule</span> <span class="literal">-UnifiedRoleManagementPolicyId</span> <span class="variable">$policy</span>.Id <span class="literal">-UnifiedRoleManagementPolicyRuleId</span> Expiration_Admin_Assignment <span class="literal">-BodyParameter</span> <span class="variable">$params2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Azure-ロール"><a href="#Azure-ロール" class="headerlink" title="Azure ロール"></a>Azure ロール</h2><p>下記ハイライト部分をすべて “いいえ” にするスクリプトです。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement6/azuread-module-retirement6-14.png"></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># サブスクリプション ID とテナント ID を指定する。</span></span><br><span class="line"><span class="variable">$subscriptionId</span> = <span class="string">&quot;2ef5f4f0-e4ef-42b0-85fb-d0f5c05ee8f3&quot;</span></span><br><span class="line"><span class="variable">$tenantId</span> = <span class="string">&quot;9a6678e4-6449-45a6-81d8-97c1b4c50edd&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Azure AD へ接続する。</span></span><br><span class="line"><span class="built_in">Connect-AzAccount</span> <span class="literal">-Tenant</span> <span class="variable">$tenantId</span> <span class="literal">-Subscription</span> <span class="variable">$subscriptionId</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Azure ロール一覧の名前を取得する。</span></span><br><span class="line"><span class="variable">$Roles</span>=(<span class="built_in">Get-AzRoleDefinition</span>).name</span><br><span class="line"></span><br><span class="line"><span class="comment"># スコープを指定する。</span></span><br><span class="line"><span class="variable">$scope</span> =<span class="string">&quot;/providers/Microsoft.Subscription/subscriptions/<span class="variable">$subscriptionId</span>/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#スコープを指定 (リソース グループのスコープの場合) する。</span></span><br><span class="line"><span class="comment">#$resourceGroup = &quot;testnet0717-RG&quot;</span></span><br><span class="line"><span class="comment">#$scope = &quot;/providers/Microsoft.Subscription/subscriptions/$subscriptionId/resourceGroups/$resourceGroup&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 実際に変更したい設定を記載する。</span></span><br><span class="line"><span class="comment"># 資格のある割り当てのみ永続を許可したい場合。</span></span><br><span class="line"><span class="variable">$payload</span> = <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;rules&quot;: [</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                &quot;isExpirationRequired&quot;: false,</span></span><br><span class="line"><span class="string">                &quot;maximumDuration&quot;: &quot;P365D&quot;,</span></span><br><span class="line"><span class="string">                &quot;id&quot;: &quot;Expiration_Admin_Eligibility&quot;,</span></span><br><span class="line"><span class="string">                &quot;ruleType&quot;: &quot;RoleManagementPolicyExpirationRule&quot;,</span></span><br><span class="line"><span class="string">                &quot;target&quot;: &#123;</span></span><br><span class="line"><span class="string">                    &quot;caller&quot;: &quot;Admin&quot;,</span></span><br><span class="line"><span class="string">                    &quot;operations&quot;: [</span></span><br><span class="line"><span class="string">                        &quot;All&quot;</span></span><br><span class="line"><span class="string">                    ],</span></span><br><span class="line"><span class="string">                    &quot;level&quot;: &quot;Eligibility&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        ]&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 資格のある割り当て・アクティブな割り当ての双方を永続拒否したい（必ず期限を指定する）場合。</span></span><br><span class="line"><span class="variable">$payload</span> = <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;rules&quot;: [</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                &quot;isExpirationRequired&quot;: true,</span></span><br><span class="line"><span class="string">                &quot;maximumDuration&quot;: &quot;P365D&quot;,</span></span><br><span class="line"><span class="string">                &quot;id&quot;: &quot;Expiration_Admin_Eligibility&quot;,</span></span><br><span class="line"><span class="string">                &quot;ruleType&quot;: &quot;RoleManagementPolicyExpirationRule&quot;,</span></span><br><span class="line"><span class="string">                &quot;target&quot;: &#123;</span></span><br><span class="line"><span class="string">                    &quot;caller&quot;: &quot;Admin&quot;,</span></span><br><span class="line"><span class="string">                    &quot;operations&quot;: [</span></span><br><span class="line"><span class="string">                        &quot;All&quot;</span></span><br><span class="line"><span class="string">                    ],</span></span><br><span class="line"><span class="string">                    &quot;level&quot;: &quot;Eligibility&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                &quot;isExpirationRequired&quot;: true,</span></span><br><span class="line"><span class="string">                &quot;maximumDuration&quot;: &quot;P180D&quot;,</span></span><br><span class="line"><span class="string">                &quot;id&quot;: &quot;Expiration_Admin_Assignment&quot;,</span></span><br><span class="line"><span class="string">                &quot;ruleType&quot;: &quot;RoleManagementPolicyExpirationRule&quot;,</span></span><br><span class="line"><span class="string">                &quot;target&quot;: &#123;</span></span><br><span class="line"><span class="string">                    &quot;caller&quot;: &quot;Admin&quot;,</span></span><br><span class="line"><span class="string">                    &quot;operations&quot;: [</span></span><br><span class="line"><span class="string">                        &quot;All&quot;</span></span><br><span class="line"><span class="string">                    ],</span></span><br><span class="line"><span class="string">                    &quot;level&quot;: &quot;Assignment&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 設定変更の処理を行う。</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$rolename</span> <span class="keyword">in</span> <span class="variable">$roles</span>)&#123;</span><br><span class="line">    <span class="variable">$roleId</span> = (<span class="built_in">Get-AzRoleDefinition</span> | <span class="built_in">where</span> &#123;<span class="variable">$_</span>.Name <span class="operator">-eq</span> <span class="variable">$roleName</span>&#125;).Id</span><br><span class="line">    <span class="variable">$roleDefinitionId</span> = <span class="string">&quot;/subscriptions/<span class="variable">$subscriptionId</span>/providers/Microsoft.Authorization/roleDefinitions/<span class="variable">$roleId</span>&quot;</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="built_in">Invoke-AzRestMethod</span> <span class="literal">-Method</span> GET <span class="literal">-Path</span> <span class="string">&quot;<span class="variable">$scope</span>/providers/Microsoft.Authorization/roleManagementPolicyAssignments?api-version=2020-10-01&quot;</span></span><br><span class="line">    <span class="variable">$properties</span> = (<span class="variable">$result</span>.Content | <span class="built_in">ConvertFrom-Json</span>).value.properties</span><br><span class="line">    <span class="variable">$roleProperty</span> = <span class="variable">$properties</span> | <span class="built_in">where</span> &#123;<span class="variable">$_</span>.roleDefinitionId <span class="operator">-eq</span> <span class="variable">$roleDefinitionId</span>&#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment"># PolicyID が必要になるので控える。</span></span><br><span class="line">    <span class="variable">$policyId</span> = <span class="variable">$roleProperty</span>.policyId</span><br><span class="line">     </span><br><span class="line">    <span class="comment"># PolicyID を組み込んだ URL を指定する。</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="built_in">Invoke-AzRestMethod</span> <span class="literal">-Method</span> GET <span class="literal">-Path</span> <span class="variable">$policyId</span><span class="string">&quot;?api-version=2020-10-01&quot;</span></span><br><span class="line">    <span class="variable">$rules</span> = (<span class="variable">$result</span>.Content | <span class="built_in">ConvertFrom-Json</span>).properties.rules</span><br><span class="line">      </span><br><span class="line">    <span class="variable">$result</span> = <span class="built_in">Invoke-AzRestMethod</span> <span class="literal">-Method</span> PATCH <span class="literal">-Path</span> <span class="variable">$policyId</span><span class="string">&quot;?api-version=2020-10-01&quot;</span> <span class="literal">-Payload</span> <span class="variable">$payload</span></span><br><span class="line">    <span class="variable">$newResult</span> = <span class="built_in">Invoke-AzRestMethod</span> <span class="literal">-Method</span> GET <span class="literal">-Path</span> <span class="variable">$policyId</span><span class="string">&quot;?api-version=2020-10-01&quot;</span></span><br><span class="line">    <span class="variable">$newRules</span> = (<span class="variable">$result</span>.Content | <span class="built_in">ConvertFrom-Json</span>).properties.rules</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、 Azure Identity サポート チームの小出です。&lt;/p&gt;
&lt;p&gt;この記事は、MSOnline / AzureAD モジュール廃止について、&lt;a href=&quot;https://jpazureid.github.io/blog/azure-active-d</summary>
      
    
    
    
    
    <category term="Microsoft Graph PowerShell SDK" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Graph-PowerShell-SDK/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra Permissions Management の新機能の紹介</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/introducing-new-features-of-microsoft-entra-permissions-management/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/introducing-new-features-of-microsoft-entra-permissions-management/</id>
    <published>2024-01-20T01:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.431Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 張替 です。</p><p>本記事は、2023 年 12 月 14 日に米国の <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/introducing-new-features-of-microsoft-entra-permissions/ba-p/2466925">Azure Active Directory Identity Blog で公開された Introducing New Features of Microsoft Entra Permissions Management - Microsoft Community Hub</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>Microsoft Entra Permissions Management は、組織のマルチクラウド基盤におけるあらゆる ID の権限管理を支援する Cloud Infrastructure Entitlement Management (CIEM) ソリューションです。Permissions Management を使用することで、ID とその権限を継続的に評価、管理、監視し、過去のアクティビティに基づいてアクセス許可の範囲を適切に管理することができます。</p><p>本日、Ignite での発表について詳細をお知らせすると共に、Permissions Management の新機能と API を紹介いたします。全体的な権限管理のエクスペリエンスにつながればうれしく思います。</p><h2 id="ServiceNow-アプリ内で-Permissions-Management-を利用-一般利用可能"><a href="#ServiceNow-アプリ内で-Permissions-Management-を利用-一般利用可能" class="headerlink" title="ServiceNow アプリ内で Permissions Management を利用 (一般利用可能)"></a>ServiceNow アプリ内で Permissions Management を利用 (一般利用可能)</h2><p>ユーザーは、ServiceNow ポータルからマルチ クラウド環境 (Microsoft Azure、Amazon Web Services (AWS)、Google Cloud Platform (GCP)) に対して、期限付きのオンデマンドのアクセス許可を要求できるようになりました。この統合により、ServiceNow の既存の承認ワークフローにアクセス許可の要求が追加され、組織のゼロ トラスト体制を強化することができ、マルチ クラウド環境で最小特権の原則を実施することが可能になります。詳細については、<a href="https://learn.microsoft.com/ja-jp/entra/permissions-management/how-to-configure-servicenow-application">こちら</a> をご覧ください。</p><p><img src="/blog/azure-active-directory/introducing-new-features-of-microsoft-entra-permissions-management/introducing-new-features-of-microsoft-entra-permissions-management1.png"></p><h2 id="Microsoft-Defender-for-Cloudとの統合-パブリック-プレビュー"><a href="#Microsoft-Defender-for-Cloudとの統合-パブリック-プレビュー" class="headerlink" title="Microsoft Defender for Cloudとの統合 (パブリック プレビュー)"></a>Microsoft Defender for Cloudとの統合 (パブリック プレビュー)</h2><p>当社は、クラウド ネイティブ アプリケーション保護プログラム (CNAPP) の取り組みを強化しており、そのために Microsoft Defender for Cloud を通じて基本的な権限管理に関する情報を提供しています。この統合により、クラウド環境における過剰なアクセス許可や設定ミスにより発生する可能性のあるセキュリティ侵害が防止されます。これにより、組織はクラウド リソースに最小特権の原則を導入すると共に、Azure、AWS、GCP 全体でアクセス許可に関するリスクを解決するための推奨事項を得ることが可能となります。詳細については、<a href="https://learn.microsoft.com/ja-jp/entra/permissions-management/permissions-management-for-defender-for-cloud">こちら</a> をご覧ください。</p><h2 id="Okta-と-AWS-IAM-Identity-Center-のサポート-パブリック-プレビュー"><a href="#Okta-と-AWS-IAM-Identity-Center-のサポート-パブリック-プレビュー" class="headerlink" title="Okta と AWS IAM Identity Center のサポート (パブリック プレビュー)"></a>Okta と AWS IAM Identity Center のサポート (パブリック プレビュー)</h2><p>Permissions Management をご利用のお客様は、Okta および AWS IAM Identity Center 上の ID を検出できるようになりました。これにより、お客様は、使用している ID プロバイダーやソリューションに関係なく、すべての ID とそのアクセス許可を一元的に把握できるようになります。お客様はけ数回クリックで Okta と AWS IAM Identity Center を構成いただけます。</p><p><img src="/blog/azure-active-directory/introducing-new-features-of-microsoft-entra-permissions-management/introducing-new-features-of-microsoft-entra-permissions-management2.png"></p><h2 id="アクセス許可の分析レポート-パブリック-プレビュー"><a href="#アクセス許可の分析レポート-パブリック-プレビュー" class="headerlink" title="アクセス許可の分析レポート (パブリック プレビュー)"></a>アクセス許可の分析レポート (パブリック プレビュー)</h2><p>このレポートでは、Permissions Management における ID とリソース全体の詳細を一覧で確認できます。このレポートは、Permissions Management ページで直接表示するか、Excel 形式でダウンロードするか、PDF としてエクスポートすることも可能です。当該レポートは Microsoft Azure、AWS、GCP を含むサポートされているすべてのクラウド環境で利用可能です。 詳しくは<a href="https://learn.microsoft.com/ja-jp/entra/permissions-management/product-permissions-analytics-reports#download-the-permissions-analytics-report-in-pdf-format">こちら</a> をご覧ください。</p><p><img src="/blog/azure-active-directory/introducing-new-features-of-microsoft-entra-permissions-management/introducing-new-features-of-microsoft-entra-permissions-management3.png"></p><h2 id="新しい-API"><a href="#新しい-API" class="headerlink" title="新しい API"></a>新しい API</h2><p>パブリック プレビューとして複数の Microsoft Graph API が Permissions Management に導入され、お客様からのフィードバックに基づく主要なユースケースに対応しました。これらの新しい API により、組織は、オンボード済みの AWS アカウント、Azure サブスクリプション、および GCP プロジェクトの情報を棚卸でき、アクセス許可に関する分析情報を SIEM ツールのダッシュボードに組み込んだり、既存のチケット管理システムでアクセスのレビューを行ったりできるようになります。さらに、Permission on Demand API を用いることで、自動化ソリューションや IT サービス管理 (ITSM) ソリューションとの統合により、必要に応じてユーザー ID またはワークロード ID の権限を柔軟に昇格させることが可能となります。詳細については、<a href="https://learn.microsoft.com/en-us/graph/api/resources/permissions-management-api-overview?view=graph-rest-beta">こちら</a> をご覧ください。</p><p>いつものように、皆様のご意見、ご感想、ご提案をお待ちしております！<a href="https://feedback.azure.com/d365community">Microsoft Entra (Azure AD) フォーラム</a> で共有するか、以下にコメントを残してください。皆様のご意見をお待ちしております。</p><p>Joseph Dadzie, Partner Director of Product Management<br>Linkedin: <a href="https://www.linkedin.com/in/joedadzie/">@joedadzie</a><br>Twitter: <a href="https://twitter.com/joe_dadzie">@joe_dadzie</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 張替 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 12 月 14 日に米国の &lt;a href=&quot;https://techcommunity.microsoft.com/t5/microsoft-entra-bl</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>サイバーセキュリティの向上 - フィッシングに強い認証に対する最新の機能強化</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication/</id>
    <published>2024-01-20T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.027Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 張替 です。</p><p>本記事は、2023 年 12 月 15 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/advancing-cybersecurity-the-latest-enhancement-in-phishing/ba-p/2365681">Advancing Cybersecurity: The Latest enhancement in Phishing-Resistant Authentication - Microsoft Community Hub</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>本日は、フィッシング耐性のある認証に向けた、いくつかの新たな機能強化をご紹介したいと思います！この機能強化は、国家のサイバー セキュリティの改善に関する大統領令 14028 (<a href="https://www.whitehouse.gov/briefing-room/presidential-actions/2021/05/12/executive-order-on-improving-the-nations-cybersecurity/">Executive Order on Improving the Nation’s Cybersecurity | The White House</a>) に準拠するために不可欠であるだけでなく、デジタル ID を利用するすべての組織とユーザーの安全を確保するうえでますます重要となっています。</p><p>全文を読むお時間のない方は以下のまとめをどうぞ。</p><ul><li>Microsoft Authenticator がフィッシングに強いパスキーのサポートを発表</li><li>Microsoft Authenticator はすべてのプラットフォームで FIPS 140-3 に準拠</li><li>PIV/CAC 認証向けの構成オプションの増加</li><li>iOS および MacOS アプリケーションでの FIDO2 サポート</li><li>マネージド ポリシーにて “Secure by design, Secure by default” を支援</li></ul><p>詳細は以下をご覧ください！</p><h2 id="Microsoft-Authenticator-がフィッシング耐性のある認証方式に！"><a href="#Microsoft-Authenticator-がフィッシング耐性のある認証方式に！" class="headerlink" title="Microsoft Authenticator がフィッシング耐性のある認証方式に！"></a>Microsoft Authenticator がフィッシング耐性のある認証方式に！</h2><p>Ignite 2023 で発表 (<a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/ba-p/2747279">Identity at Microsoft Ignite: Securing access in the era of AI - Microsoft Community Hub</a>) されたように、2024 年前半には、Microsoft Entra ID のユーザーは、デバイスに紐づくパスキーを Microsoft Authenticator アプリを用いて登録して、サインインに利用できるようになります。これは、費用対効果が高く、フィッシングに強い資格情報で、Authenticator アプリがあれば誰でも利用できる仕組みです！パスキーは FIDO 標準に関連した最新のセキュリティ機能であり、Authenticator との統合により、Authenticator が提供する革新的なセキュリティ機能や高度な機能を活用することができます。</p><p><img src="/blog/azure-active-directory/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication1.png" alt="図 1: Microsoft Authenticator アプリで管理されたパスキー"></p><p>Microsoft Authenticator をさらに強化し、コンプライアンス要件を満たすために、Android 上の Authenticator アプリが FIPS-140 に準拠しました。</p><p>Microsoft Authenticator for Android は、バージョン 6.2310.7174 以降、デバイスに紐づくフィッシング耐性のあるパスキー、プッシュ型多要素認証 (MFA)、パスワードレス電話サインイン (PSI)、時間ベースのワンタイム パスコード (TOTP) を使用するすべての Microsoft Entra 認証において、連邦情報処理標準 (FIPS 140-3) に準拠しています。Intune Company Portal を使用している組織の場合は、FIPS 準拠のため、最新バージョンの Authenticator に加えて、Intune Company Portal のバージョン 5.0.6043.0 をインストールください。</p><p>iOS 向けの Microsoft Authenticator アプリは、2022 年 12 月に発表されたように、すでに FIPS-140 に準拠しています。Microsoft Authenticator アプリの FIPS 140 準拠の詳細については、<a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/concept-authentication-authenticator-app#fips-140-compliant-for-microsoft-entra-authentication">こちら</a> をご覧ください。</p><h2 id="PIV-CAC-を使用する組織のために設定項目を拡充"><a href="#PIV-CAC-を使用する組織のために設定項目を拡充" class="headerlink" title="PIV/CAC を使用する組織のために設定項目を拡充"></a>PIV/CAC を使用する組織のために設定項目を拡充</h2><p>証明書ベース認証 (CBA) の一般提供開始を発表してからこの 1 年間で、米国政府機関のお客様の Entra ID CBA の利用が 850% 以上増加しました。CBA を活用することで、AD FS などのオンプレミス IdP からの移行を図りながら、PIV/CAC を使用して使い慣れたエンドユーザー体験を提供し続けることができ、お客様はゼロ トラストへの対応をより迅速に進めることが可能となります。</p><p>弊社ではクラウド ベースの CBA への投資を継続し、直近で証明書やリソースの種類、ユーザー グループごとに認証ポリシーを調整できる機能を追加しました。ユーザごとに証明書の強度を選択したり、多要素認証やステップアップ認証のためにCBA を他の方法と併用したり、さらにはテナント全体またはユーザー グループごとに高いアフィニティで (強い) 証明書バインドを構成したりできるようになりました。</p><p><img src="/blog/azure-active-directory/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication/advancing-cybersecurity-the-latest-enhancement-in-phishing-resistant-authentication2.png" alt="図 2: 証明書ベースの認証におけるバインドのポリシー ルールの構成"></p><p>Microsoft Entra 証明書ベース認証の最新の機能強化の詳細については、<a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/enhancements-to-microsoft-entra-certificate-based-authentication/ba-p/1061417">こちら</a> をご覧ください。</p><h2 id="モバイル向けにフィッシング耐性のある認証オプションを追加-iOS-および-macOS-アプリケーション向けの-FIDO2-サポート"><a href="#モバイル向けにフィッシング耐性のある認証オプションを追加-iOS-および-macOS-アプリケーション向けの-FIDO2-サポート" class="headerlink" title="モバイル向けにフィッシング耐性のある認証オプションを追加: iOS および macOS アプリケーション向けの FIDO2 サポート"></a>モバイル向けにフィッシング耐性のある認証オプションを追加: iOS および macOS アプリケーション向けの FIDO2 サポート</h2><p>2023 年夏に、iOS と macOS の Web ブラウザにおける FIDO2 認証のサポートを発表 (<a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/advancing-modern-strong-authentication/ba-p/3773135">Advancing Modern Strong Authentication - Microsoft Community Hub</a>) しました。本日、iOS と macOS でのFIDO2 認証のパブリック プレビューを発表できることを嬉しく思います。このリリースにより、iOS に Microsoft Authenticator をインストールしているユーザー、または macOS に Microsoft Intune Company Portal をインストールしているユーザーは、FIDO2 セキュリティ キーを使用して Microsoft アプリケーションにサインインできるようになります。この機能は現在 iOS で利用可能で、macOS では 2024 年初頭に利用可能になる予定です。</p><p>FIDO2 の認証は、「開発するアプリで FIDO2 キーによるパスワードレス認証をサポートする」(<a href="https://learn.microsoft.com/ja-jp/entra/identity-platform/support-fido2-authentication">開発するアプリで FIDO2 キーを使用してパスワードレス認証をサポートする - Microsoft identity platform | Microsoft Learn</a>) に記載されている要件を満たす、iOS および macOS の MSAL 対応サードパーティ製アプリケーションでも利用できます。</p><p>対応プラットフォームについては<a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/fido2-compatibility">こちら</a>をご覧ください。</p><h2 id="CISA-に沿った「Secure-by-design-Secure-by-default」アプローチに基づき既定の状態で安全な構成を採用"><a href="#CISA-に沿った「Secure-by-design-Secure-by-default」アプローチに基づき既定の状態で安全な構成を採用" class="headerlink" title="CISA に沿った「Secure by design, Secure by default」アプローチに基づき既定の状態で安全な構成を採用"></a>CISA に沿った「Secure by design, Secure by default」アプローチに基づき既定の状態で安全な構成を採用</h2><p>今月初め、Microsoft は Secure Future Initiative (<a href="https://blogs.microsoft.com/on-the-issues/2023/11/02/secure-future-initiative-sfi-cybersecurity-cyberattacks/">A new world of security: Microsoft’s Secure Future Initiative - Microsoft On the Issues</a>) を発表しました。このイニシアティブの一環として、条件付きアクセス ポリシーの自動展開 (<a href="https://www.microsoft.com/en-us/security/blog/2023/11/06/automatic-conditional-access-policies-in-microsoft-entra-streamline-identity-protection/">Automatic Conditional Access policies in Microsoft Entra streamline identity protection | Microsoft Security Blog</a>) を開始します。このイニシアティブは Cybersecurity and Infrastructure Security Agency (CISA) が提唱する “Secure by design, Secure by default” というアプローチに沿ったもので、消費者が日々利用するテクノロジーの安全性と完全性を信頼できるものにすることを目的としています。</p><p>サイバー セキュリティの課題には社会として取り組む必要があります。弊社は、政府機関、セキュリティ専門家、およびより広範なコミュニティと緊密に協力しｔえサイバー脅威に対する対策強化に取り組んでいます。弊社の目標は、政府機関のお客様に、進化するリスクに先手を打つために必要なツールと知識を提供することです。</p><p>サイバー セキュリティの強化に向けた当社の最近のリリースと継続的なコミットメントにより、大統領令の遵守に取り組んでいる米国政府のお客様を含め、当社の幅広いお客様をサポートしてまいります。共に、より安全なデジタルの未来を築いていきましょう。</p><p>Alex Weinert</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 張替 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 12 月 15 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techc</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>データ流出への対応: トークンの窃取について</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/addressing-data-exfiltration-token-theft-talk/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/addressing-data-exfiltration-token-theft-talk/</id>
    <published>2024-01-07T00:30:00.000Z</published>
    <updated>2024-03-15T02:00:17.027Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 高田 です。</p><p>本記事は、2024 年 1 月 2 日に米国の Microsoft Entra Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/addressing-data-exfiltration-token-theft-talk/ba-p/3915337">Addressing Data Exfiltration: Token Theft Talk</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>データ流出の防止について前回に引き続きお話ししたいと思います。以前のブログでは、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-continuous-access-evaluation">継続的アクセス評価 (CAE)</a> を使用して <a href="https://techcommunity.microsoft.com/t5/security-compliance-and-identity/apply-zero-trust-principles-to-authentication-session-management/ba-p/3615343">認証セッションをセキュリティで保護するための Microsoft のアプローチ</a> をお話し、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/tenant-restrictions-v2#step-4-set-up-tenant-restrictions-v2-on-your-corporate-proxy">テナント制限 v2</a> を使用して <a href="https://jpazureid.github.io/blog/azure-active-directory/how-tenant-restrictions-v2-can-be-used-to-prevent-data/">テナント間アクセスを安全に行う</a> 方法について解説しました。本日のトピックは、認証アーティファクトの窃取についてです。</p><p>認証アーティファクト (トークンおよび Cookie) が窃取されると、攻撃者は被害者になりすまし、被害者がアクセスできるすべての情報にアクセス出来てしまいます。数年前までトークンの窃取はまれな攻撃であり、ほとんどの場合、企業内のレッド チーム (セキュリティの脆弱性を検証する部門) によって訓練的に行われていました。この理由としては、クッキーの窃取よりも、パスワードの窃取の方が容易だったからです。しかしながら、多要素認証 (MFA) の普及に伴い、アーティファクトの盗難やリプレイを含む実際の攻撃が増えてきています。</p><p>詳細に入る前に、<a href="https://www.microsoft.com/en-us/security/blog/2022/11/16/token-tactics-how-to-prevent-detect-and-respond-to-cloud-token-theft/">Token tactics: How to prevent, detect, and respond to cloud token theft</a> に記載されているとおり、Microsoft ではトークンの窃取に対する第一線の防御策として、エンドポイント保護やデバイス管理、フィッシング耐性のある MFA、ウィルス対策ソフトを用いてデバイスを保護することを推奨しています。</p><p>では次に、認証アーティファクトの種類と、窃取の影響を最小限に抑えるためにその種類ごとに推奨される対応手法について説明していきます。すべての認証アーティファクトは、大まかに 2 つの種類に分けることができます。</p><ul><li>サインイン セッション アーティファクト: クライアントと Entra ID の間でシングル サインオン (SSO) の状態を維持するためのもの。</li><li>アプリ セッション アーティファクト: クライアント アプリにデータ アクセスを許可するためのもの。</li></ul><p><img src="/blog/azure-active-directory/addressing-data-exfiltration-token-theft-talk/pic.png"></p><p>最も強力なデバイス SSO アーティファクトである <a href="https://learn.microsoft.com/ja-jp/entra/identity/devices/concept-primary-refresh-token">プライマリ更新トークン (PRT)</a> を保護することが一番重要になります。幸いなことに、PRT はすべての OS 上で窃取に対して防御策がとられています。保護のレベルは OS の機能によって異なりますが、<a href="https://learn.microsoft.com/ja-jp/entra/identity/devices/concept-primary-refresh-token#how-is-the-prt-protected">Windows が最も強力な保護機能を有しています</a>。<strong>PRT の保護はポリシーで制御できず、常に有効になっています。</strong></p><p>すべてのアーティファクトを今後同様に保護していくことは開発上のロードマップにありますが、これらの機能を提供するには数年かかると想定しています。トークンの窃取に対する包括的な保護を実現するためのさまざまな課題については、この <a href="https://www.rsaconference.com/library/presentation/usa/2022/token%20theft%20hip%20kids%20are%20doing%20it%20now%20what%20are%20we%20going%20to%20do%20about%20it">RSA のプレゼン資料</a> をご覧ください。当面のところは、Entra ID のセキュリティ製品を組み合わせて利用することで、トークンの窃取に対応が可能です。</p><h2 id="サインイン-セッション-アーティファクトの窃取への対処"><a href="#サインイン-セッション-アーティファクトの窃取への対処" class="headerlink" title="サインイン セッション アーティファクトの窃取への対処"></a>サインイン セッション アーティファクトの窃取への対処</h2><p><a href="https://jpazureid.github.io/blog/azure-active-directory/public-preview-token-protection-for-sign-in-sessions/">条件付きアクセスのトークン保護ポリシー</a> を用いることで、盗まれたトークンが再利用されないよう暗号技術に基づく仕組みを用いて保護することが可能です。この機能は、PRT に対する既存の保護に上乗せする形で構築されてます。トークン保護ポリシーが有効な場合、保護されていないサインイン セッションの使用はブロックされます。PRT の保護が常に有効となっていることと組み合わせることで、すべての再利用可能なアーティファクトにこのような暗号技術に基づく保護が適用されます。トークンの保護は、Windows 上の Office 製品と Outlook において現在パブリック プレビュー段階です。ご利用の際は、まずレポート専用モードで開始して、組織への影響を評価ください。</p><p>トークン保護のスコープにまだ含まれていないクライアント アプリについては、<a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/overview-what-is-global-secure-access">Entra Global Secure Access</a> の <a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/how-to-compliant-network">準拠ネットワークのチェック</a> を有効にすることで保護いただけます。このポリシーにより、認証アーティファクトが常に組織のネットワークから送信されていることを保証できます。つまり、盗まれたトークンが組織のネットワークからのみ利用可能となるため、攻撃の影響範囲を大幅に縮小することが可能です。</p><h2 id="アプリ-セッション-アーティファクトの窃取への対処"><a href="#アプリ-セッション-アーティファクトの窃取への対処" class="headerlink" title="アプリ セッション アーティファクトの窃取への対処"></a>アプリ セッション アーティファクトの窃取への対処</h2><p>ネットワーク構成によっては、<a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/howto-conditional-access-policy-location">条件付きアクセス: 場所によるアクセスのブロック機能</a> および <a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/concept-continuous-access-evaluation-strict-enforcement">継続的アクセス評価 (CAE): 場所ポリシーを厳密に適用する機能</a> を構成することで、窃取されたアクセス トークンとワークロード (アプリ) Cookie の企業ネットワーク外での利用をブロック可能です。この新しい CAE の強制機能は、許可された IP 範囲外からのアクセスをブロックしますので、盗まれたトークンのネットワーク外部からの使用がブロックされ、攻撃の影響範囲が大幅に縮小します。この機能を利用するには、ユーザーは事前に定義した IP アドレスの範囲から Entra ID とワークロードの両方にアクセスする必要があります。Entra Global Secure Access (GSA) ではユーザーのデバイスの IP アドレスを提示することができるため、Entra GSA を介してデータにアクセスする企業ネットワーク ユーザーに対しては、CAE の場所ポリシーを厳密に適用できます。条件付きアクセス (CA) で <a href="https://learn.microsoft.com/ja-jp/azure/architecture/guide/security/conditional-access-framework#named-locations">ネームド ロケーション</a> を構成する場合は、ユーザーが Entra ID とワークロード (SharePoint Online など) の両方にアクセスする IP アドレスの範囲をネームド ロケーションに必ず含めるよう対応ください。</p><h2 id="トークンの窃取の検出"><a href="#トークンの窃取の検出" class="headerlink" title="トークンの窃取の検出"></a>トークンの窃取の検出</h2><p>アーティファクトの窃取を検出するには、Microsoft Entra ID Protection のリスク検出機能を利用して、トークンの窃取が懸念される場合にユーザー リスクを上げるするという方法があります。<a href="https://learn.microsoft.com/ja-jp/entra/id-protection/concept-identity-protection-risks#anomalous-token">異常なトークン</a> や <a href="https://learn.microsoft.com/ja-jp/entra/id-protection/concept-identity-protection-risks#token-issuer-anomaly">トークン発行者の異常</a>、および中間者攻撃の検出が行われた場合は、トークン窃取の可能性があります。それぞれの検出はオフラインで評価されますが、”異常なトークン” の検出はサインイン時にリアルタイムに評価して脅威を捉えられもしますので、その場でサインインを侵害済みであるとしてアラートを上げることもできます。これらの検出を最大限に活用するには、<a href="https://learn.microsoft.com/ja-jp/entra/id-protection/concept-identity-protection-policies">リスクベースのアクセス ポリシー</a> を構成して、トークンの窃取が懸念される場合に、ユーザーに適切なポリシー制御が適用されるようにすることをお勧めします。リスクベースのアクセス ポリシーをトークン窃取の検出に対して適用すると、ユーザーには多要素認証が求められ、それが完了するとパスワードのリセットが求められます。必要であれば、管理者がユーザー トークンの取り消しを行うことも可能です。</p><p><a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/concept-continuous-access-evaluation">継続的アクセス評価</a> をリスクベースのアクセス ポリシーと組み合わせることで、窃取されたアーティファクトを用いたリソース アクセスをブロックすることが可能です。ユーザー リスクが上昇すると、CAE は CAE に対応したすべての対応ワークロードに通知を行い、リスクベースのアクセス ポリシーを直ちに適用します。</p><p>トークン窃取の攻撃が増えるにつれ、Microsoft もそのような攻撃に対する防御を常に強化しています。この分野における新しい更新情報を今後もぜひお楽しみにお待ちください。</p><p>Anna Barhudarian<br>Principal Product Manager, Identity Division</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 高田 です。&lt;/p&gt;
&lt;p&gt;本記事は、2024 年 1 月 2 日に米国の Microsoft Entra Blog で公開された &lt;a href=&quot;https://techcommunity.microsoft</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra  証明書ベース認証 (CBA) の機能強化</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/</id>
    <published>2024-01-06T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.267Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 五十嵐 です。</p><p>本記事は、2023 年 12 月 13 日に米国の Microsoft Entra (Azure AD) Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/enhancements-to-microsoft-entra-certificate-based-authentication/ba-p/1061417">Enhancements to Microsoft Entra certificate-based authentication</a> の抄訳です。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>Ignite 2022 では、<a href="https://www.whitehouse.gov/briefing-room/presidential-actions/2021/05/12/executive-order-on-improving-the-nations-cybersecurity/">大統領令 14028 「国家のサイバーセキュリティの向上」</a> に対する Microsoft のコミットメントの一環として、Microsoft Entra 証明書ベース認証 (CBA) の一般提供開始を発表しました。弊社はこれまで政府機関のお客様と協力してまいりましたが、PIV/CAC カードが連邦政府内で使用される最も一般的な認証方法であるという状況です。PIV/CAC カードを使用している連邦政府組織や、大統領令 14028 の要件に準拠したいとお考えのお客様、加えて Active Directory Federated Server のような連携サーバーから Entra ID の CBA に移行したいお客様にとって、直接 Entra ID に対して認証に X.509 証明書を使用できることは非常に重要です。</p><p>それ以来、弊社では多くの新機能を追加し、モバイルを含むすべてのプラットフォームで CBA を利用できるようにし、デバイス上の証明書だけでなく、YubiKey のような外部セキュリティ キーもサポートしました。お客様は、証明書やリソースの種類、ユーザーのグループごとに認証ポリシーをカスタマイズしたり、ユーザーごとに証明書の強度を選択したり、多要素認証やステップアップ認証のために CBA を他の方法と併用することも可能です。加えて、テナント全体またはユーザーのグループごとに証明書のバインドを構成したりするなど、より制御性と柔軟性を向上させることができるようになりました。</p><p>Microsoft Entra のプロダクト マネージャーである Vimala Ranganathan より、これらの新機能がフィッシングに強い MFA の実現にどのように活用いただけるかについてご説明します。</p><p>ぜひ皆様のご感想をお聞かせください！<br>Alex Weinert</p><p>–</p><p>皆さんこんにちは、</p><p>Microsoft Entra PM チームの Vimala です。CBA の新機能と機能強化について詳しく説明いたします。</p><p><strong>CBA のユーザー名のバインド</strong>: CBA は、追加で 3 つのユーザー名のバインドをサポートし、オンプレミスの Active Directory と同等の機能を提供するようになりました。追加された 3 つの証明書バインドは以下のとおりです:</p><ul><li>IssuerAndSerialNumber (発行者とシリアル番号)</li><li>IssuerAndSubject (発行者とサブジェクト)</li><li>サブジェクトのみ</li></ul><p>ユーザー名のバインド ポリシーは、Entra ID がユーザから提示された証明書を、Entra ID のユーザー アカウントとどのように一致させるかを管理者がカスタマイズできるようにするものです。既定では証明書の Subject Alternative Name (SAN) 属性の Principal Name をユーザー オブジェクトの UserPrincipalName にマッピングします。管理者は既定の設定をオーバーライドしてカスタムのマッピングを作成できます。</p><p>詳しくは <a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/how-to-certificate-based-authentication#step-4-configure-username-binding-policy">ユーザー名バインド ポリシーを構成する</a> をご覧ください。</p><p><img src="/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/enhancements-to-microsoft-entra-certificate-based-authentication1.png"></p><p><strong>CBA 認証ポリシー ルール</strong>: このルールは、認証の強度を単一要素または多要素のいずれとして扱うかを定めるものです。Entra ID で利用可能な他の認証方式は常に単一要素もしくは多要素のどちらか一方での扱いですが、CBA はどちらとしても扱うことができます。管理者は、認証ポリシー ルールを構成することで、Entra ID が証明書をいつ単一要素または多要素とみなすかを選び、保護のレベルを設定できます。複数のカスタム認証バインドのルールを作成し、証明書の属性 (発行者またはポリシー OID、または発行者と OID の組み合わせ) に基づいて、証明書に関する既定の保護レベルを割り当てることもできます。</p><p>詳しくは <a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/how-to-certificate-based-authentication#step-3-configure-authentication-binding-policy">認証バインド ポリシーを構成する</a> をご覧ください。</p><p><img src="/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/enhancements-to-microsoft-entra-certificate-based-authentication2.png"></p><p><strong>CBA アフィニティ バインド</strong> :  この設定は、ユーザー認証において証明書を検証する際に使用される証明書の属性に関するものです。先に紹介したように、証明書をユーザー オブジェクトとバインドまたは照合させるにはいくつかの方法かあります。その中には、簡単に再利用が可能なユーザー証明書のプロパティを使用しているものもあります。この再利用の容易さにより、特定のユーザー バインドの方法により高アフィニティ (強い関連付け) か低アフィニティ (弱い関連付け) かが決まります。例えば、SAN Principal Name に基づくユーザー バインド利用すると、これは低アフィニティになります。Issuer + SerialNumber に基づくユーザー バインドは高アフィニティです。Entra ID では、管理者がテナント レベルでアフィニティ バインドを設定したり、カスタム ルールを作成して高アフィニティまたは低アフィニティのマッピングを使用したりすることができ、お客様の多くの潜在的なシナリオをカバーすることが可能です。</p><p>詳しくは <a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/concept-certificate-based-authentication-technical-deep-dive#understanding-the-username-binding-policy">ユーザー名のバインド ポリシーについて</a> をご覧ください。</p><p><img src="/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/enhancements-to-microsoft-entra-certificate-based-authentication3.png"></p><p><strong>第 2 要素としての CBA</strong>: この機能により Entra リソースにアクセスするための多要素認証 (MFA) の一要素として CBA がサポートされるようになりました。詳しくは <a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/concept-certificate-based-authentication-technical-deep-dive#mfa-with-single-factor-certificate-based-authentication">CBA による MFA</a> をご覧ください。</p><table><thead><tr><th>第 1 要素</th><th>第 2 要素</th><th>MFA</th></tr></thead><tbody><tr><td>単一要素による CBA</td><td>パスワードレスの電話によるサインイン (PSI)</td><td>持っているもの + 持っている/知っているもの</td></tr><tr><td>単一要素による CBA</td><td>FIDO 2</td><td>持っているもの + 持っている/知っているもの</td></tr><tr><td>パスワード</td><td>CBA (単一要素または多要素)</td><td>知っているもの + 持っているもの</td></tr></tbody></table><p><img src="/blog/azure-active-directory/enhancements-to-microsoft-entra-certificate-based-authentication/enhancements-to-microsoft-entra-certificate-based-authentication4.png"></p><p><strong>最後に使用された方法 (MRU) としての CBA</strong>: ユーザーが CBA を使用して認証に成功すると、MRU (Most Recently Used: 最後に使用された) の方法として CBA が設定されます。それ以降、サインイン画面でユーザーが自身の UPN を入力して [<strong>次へ</strong>] をクリックすると、直接 CBA の認証に移動するため、[証明書またはスマート カードを使用する] を選択する必要がなくなります。MRU の方法をクリアするには、証明書の選択画面をキャンセルし、[その他のサインイン方法] をクリックします。ユーザーが利用できる別のメソッドを選択し、認証に成功すれば MRU の方法がクリアされます。詳しくは <a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/concept-certificate-based-authentication-technical-deep-dive#certificate-based-authentication-in-mostrecentlyused-mru-methods">MRU 方法での CBA</a> をご覧ください。</p><p>Windows 端末上で Entra ハイブリッド参加および Entra 参加済みデバイスをご利用のユーザーは、スマート カードで Windows にサインインし、プライマリ更新トークン (PRT) を取得して、Entra リソースにシングル サインオン (SSO) することも可能です。詳しくは <a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/concept-certificate-based-authentication-smartcard">Windows スマート カード サインイン</a> をご覧ください。</p><p>また、Microsoft Entra CBA の詳細については、<a href="http://aka.ms/aadcba">http://aka.ms/aadcba</a> および <a href="https://msus-sites.azurewebsites.net/en-us/federal/cybersecurity.aspx">Executive Order 14028</a> に対する Microsoft のコミットメントをご覧ください。</p><h2 id="今後の予定"><a href="#今後の予定" class="headerlink" title="今後の予定"></a>今後の予定</h2><p><a href="https://feedback.azure.com/d365community/forum/22920db1-ad25-ec11-b6e6-000d3a4f0789">Azure Active Directory Community</a> にフィードバックをお寄せください！弊社では、証明書失効リスト (CRL) の制限の撤廃、新しい認証局のトラスト ストア、B2B 外部ゲスト ユーザー用のリソース テナントでの CBA サポート、iOS UX の強化など、さらなる機能強化を実現するために鋭意取り組んでおります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 五十嵐 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 12 月 13 日に米国の Microsoft Entra (Azure AD) Blog で公開された &lt;a href=&quot;https://techcommu</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
    <category term="Microsoft Entra" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Entra/"/>
    
  </entry>
  
  <entry>
    <title>改めて知る Microsoft Entra 条件付きアクセス</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/review-ca/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/review-ca/</id>
    <published>2024-01-01T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.635Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの長谷川です。</p><p>Microsoft Entra 条件付きアクセスは、Microsoft Entra ID が提供する主要機能であり、非常に多くのお客様にご利用いただいています。一方で、条件付きアクセスについて誤解されている方が意外と多いと感じており、弊社サポートにはこの誤解により生じる問題や質問が多く寄せられます。</p><p>そこで本記事では、条件付きアクセスとはどういったものであるか、またどのようなコンセプトで提供されているかをイメージできるような情報をお届けします。後半では簡単なシナリオをベースに条件付きアクセスの動作を説明していきますので、本記事が条件付きアクセスへの理解の助けとなればうれしく思います。</p><h2 id="条件付きアクセスとはどんな機能か"><a href="#条件付きアクセスとはどんな機能か" class="headerlink" title="条件付きアクセスとはどんな機能か"></a>条件付きアクセスとはどんな機能か</h2><p>条件付きアクセスを一言でいうと、Microsoft 365 のサービスや Salesforce など、クラウド上で提供されているサービスへのアクセスを制御する機能です。条件付きアクセスのよくある利用例 (シナリオ) を以下にいくつか紹介します。</p><h3 id="ID-およびパスワードの認証だけでなく多要素認証でユーザーを保護する"><a href="#ID-およびパスワードの認証だけでなく多要素認証でユーザーを保護する" class="headerlink" title="ID およびパスワードの認証だけでなく多要素認証でユーザーを保護する"></a>ID およびパスワードの認証だけでなく多要素認証でユーザーを保護する</h3><p>ユーザーの資格情報 (ID/パスワードなど) が攻撃者により推測されたり外部に流出したりすると、それを入手した攻撃者は流出した資格情報を使用して Microsoft 365 などにサインインすることができます。これによりアカウントの乗っ取りが成功し、そのユーザーしか知りえない情報が漏洩したり、アカウントが悪用されたりします。</p><p>条件付きアクセスを利用している場合、Microsoft 365 や Salesforce などクラウド上のサービスへのアクセス時に、ID およびパスワードといった資格情報に加えて多要素認証を要求することができます。これにより、電話番号を用いた認証や Microsoft Authenticator を用いた認証、さらにはハードウェア トークンを用いた追加認証などパスワード以外の認証要素 (多要素認証) を求めることができるようになります。こうなることで、仮に ID およびパスワードが攻撃者の手に渡っても、多要素認証を突破できない場合は、条件付きアクセスが Microsoft 365 へのアクセスをブロックしてくれます。つまり、ID およびパスワードが窃取されただけではサインインできなくなるため、セキュリティの強化につながります。この多要素認証の要求が、条件付きアクセスのもっとも一般的な利用シナリオです。</p><h3 id="社外など特定の場所からのアクセスに制限を掛ける"><a href="#社外など特定の場所からのアクセスに制限を掛ける" class="headerlink" title="社外など特定の場所からのアクセスに制限を掛ける"></a>社外など特定の場所からのアクセスに制限を掛ける</h3><p>重要な機密情報へのアクセスは、多要素認証を要求するだけでなく、そのユーザーが社内ネットワークにいる場合のみアクセスさせたいというご要望もあると思います。多要素認証だけでなく、このような場所の制御も条件付きアクセスで実現が可能です。例えば、社内ネットワークの出口となるパブリック IP アドレスを Microsoft Entra ID に登録しておけば、その IP アドレスが送信元のアクセスだけを条件付きアクセスでブロックしないように構成できます。これにより、ユーザーが特定のネットワークからのみアクセスできる構成を取ることが可能です。このように場所によるアクセス制御も条件付きアクセスでよく利用されています。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>社外からのアクセスの場合は多要素認証を要求し、社内ネットワークからのアクセスの場合は多要素認証を要求しないというように、社内からのアクセスの場合は制限を緩めるような構成を取る例をよく見受けられます。しかしながら、このような構成はお勧めできません。というのも、攻撃者が社内ネットワークへの侵入に成功してしまうと、多要素認証が強制されず攻撃者がより行動しやすい状況となるためです。このため、多要素認証は最低限の保護として場所を選ばず強制することをお勧めします。</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>IP アドレスを利用した制御と聞くと、ファイアウォール製品のようなトラフィック制御をイメージされる方もいるかと思いますが、これは誤りです。条件付きアクセスはトラフィック自体は制御しません。</p></div><h3 id="会社に登録されたデバイスからのみ-Microsoft-365-へのアクセスを許可する"><a href="#会社に登録されたデバイスからのみ-Microsoft-365-へのアクセスを許可する" class="headerlink" title="会社に登録されたデバイスからのみ Microsoft 365 へのアクセスを許可する"></a>会社に登録されたデバイスからのみ Microsoft 365 へのアクセスを許可する</h3><p>お使いの Windows PC やモバイル デバイスを Microsoft Entra ID に登録および参加させることで組織で管理している扱いにして利用することが可能です。加えて、Intune などのモバイル デバイス管理サービスを組み合わせるとデバイスに対してポリシーを適用することもできます。条件付きアクセスでは、このようにして会社の管理下にあるデバイスのみアクセスを許可するなどの構成も可能です。</p><h3 id="危険な状態にあるユーザーに対して多要素認証を要求してパスワードリセットを行わせる"><a href="#危険な状態にあるユーザーに対して多要素認証を要求してパスワードリセットを行わせる" class="headerlink" title="危険な状態にあるユーザーに対して多要素認証を要求してパスワードリセットを行わせる"></a>危険な状態にあるユーザーに対して多要素認証を要求してパスワードリセットを行わせる</h3><p>Microsoft Entra には ID Protection という機能があり、ユーザーのパスワードの漏洩や、普段利用していない外国からのアクセス、短時間の間にあり得ない距離を移動してサインインが行われるなどの異常を検知して、アラートを上げることができます。条件付きアクセスではこのアラートを利用して、サービスへのアクセスを動的にブロックしたり、サインインに多要素認証を求めたうえでアカウントのパスワード リセットを要求したりということが可能です。</p><h2 id="条件付きアクセスの制御が具体的に適用される対象"><a href="#条件付きアクセスの制御が具体的に適用される対象" class="headerlink" title="条件付きアクセスの制御が具体的に適用される対象"></a>条件付きアクセスの制御が具体的に適用される対象</h2><p>これまで、条件付きアクセスは Microsoft 365 のサービスや Salesforce など、クラウド上で提供されているサービスへのアクセスを制御する機能であると繰り返し述べてきました。この「クラウド上で提供されているサービスへのアクセスを制御する」というのが重要なポイントであり、条件付きアクセスの制御はこの「クラウド上で提供されているサービスへのアクセス」に適用されます。</p><p>例えば 「条件付きアクセスでデスクトップ上の Outlook アプリを開けないようにしたい」 という要望は、条件付きアクセスでは完全に実現することができません。これは、このご要望では保護する対象 (制御の対象) がデスクトップ上の Outlook アプリであり、上述の 「クラウド上で提供されているサービスへのアクセス」 ではないためです。</p><p>とはいえこの説明ではイメージがわきにくいと思いますので、簡単ですが条件付きアクセスの制御についてユーザーが Outlook で E メール データを閲覧するシナリオを例に説明します。ユーザーが Outlook で E メールやカレンダーを閲覧しようとする場合、ダウンロード済みのデータを除いて Outlook 上には新着 E メールなどはありません。このためユーザーは Outlook を利用して E メール サーバーにアクセスし、新着 E メールやカレンダー情報を取得します。Office 365 ではこの E メール サーバーに該当するクラウド上のサービスが Office 365 Exchange Online です。</p><p>条件付きアクセスの用語としては、Outlook をクライアント アプリと呼び、Office 365 Exchange Online のことをターゲット リソース (単にリソースとも) と呼びます。リソースとはクラウド上にあるデータの保管場所のようなものをイメージいただくと良いと思います。</p><h3 id="条件付きアクセスが無い場合のアクセスの流れ"><a href="#条件付きアクセスが無い場合のアクセスの流れ" class="headerlink" title="条件付きアクセスが無い場合のアクセスの流れ"></a>条件付きアクセスが無い場合のアクセスの流れ</h3><ol><li>ユーザーが E メールを閲覧しようとして、デスクトップ上の Outlook を開きます。</li><li>Outlook はそのユーザーの E メールデータをクラウド上 (Exchange Online) から取得する必要があるため、Exchange Online にアクセスします。</li><li>Exchange Online は、E メールデータを提供するためには Microsoft Entra ID に認証する必要があると応答し、Outlook がユーザーに対して (画面上に) Microsoft Entra ID のサインイン画面を表示します。</li><li>ユーザーは、サインイン画面に自身の資格情報を入力します。</li><li>ユーザーの入力した資格情報が正しければ、Microsoft Entra ID は Outlook に対してアクセス トークンと呼ばれるものを発行します。</li><li>Outlook はそのアクセス トークンを Office 365 Exchange Online に提示することで E メールのデータをダウンロードします。</li><li>Outlook は取得したデータを画面に表示します。</li></ol><p><img src="/blog/azure-active-directory/review-ca/1%E6%9D%A1%E4%BB%B6%E4%BB%98%E3%81%8D%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%8C%E7%84%A1%E3%81%84%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AE%E6%B5%81%E3%82%8C.png"></p><h3 id="条件付きアクセスがある場合のアクセスの流れ"><a href="#条件付きアクセスがある場合のアクセスの流れ" class="headerlink" title="条件付きアクセスがある場合のアクセスの流れ"></a>条件付きアクセスがある場合のアクセスの流れ</h3><p>ここでは例として、Office 365 へのアクセスに対して多要素認証を要求するポリシーを構成している場合を考えます。</p><ol><li>ユーザーが E メールを閲覧しようとして、デスクトップ上の Outlook を開きます。 </li><li>Outlook はそのユーザーの E メールデータをクラウド上 (Exchange Online) から取得する必要があるため、Exchange Online にアクセスします。</li><li>Exchange Online は、E メールデータを提供するためには Microsoft Entra ID に認証する必要があると応答し、Outlook がユーザーに対して (画面上に) Microsoft Entra ID のサインイン画面を表示します。</li><li>ユーザーは、サインイン画面に自身の資格情報を入力します。 </li><li>ユーザーの入力した資格情報が正しければ、Microsoft Entra ID は条件付きアクセス ポリシーを確認し、Exchange Online へのアクセスに適用されるポリシーがあるかを確認します。</li><li>Exchange Online は Office 365 の一部であるため、多要素認証を要求するポリシーがみつかります。</li><li>この結果として、Microsoft Entra ID からユーザーに対して多要素認証が要求されます。</li><li>多要素認証に応えられない場合は処理を中断し、アクセス トークンは Outlook に発行されません。多要素認証に応えられればサインイン成功と判断し、Outlook に対してアクセス トークンを発行します。</li><li>Outlook はそのアクセス トークンを Office 365 Exchange Online に提示することで E メールのデータをダウンロードします。 </li><li>Outlook は取得したデータを画面に表示します。 </li></ol><p><img src="/blog/azure-active-directory/review-ca/2%E6%9D%A1%E4%BB%B6%E4%BB%98%E3%81%8D%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E9%81%A9%E7%94%A8%E6%99%82%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AE%E6%B5%81%E3%82%8C.png"></p><p>上述の流れのように、条件付きアクセスの処理の中では、クライアント アプリ (Outlook) ではなく、そのクライアント アプリがアクセスしようとしている先のクラウド上のサービス (Exchange Online) を意識することが重要です。</p><p>裏を返すと、条件付きアクセスを用いて、既に Outlook にダウンロードされた E メール データへのアクセスを制御するということはできません。Outlook にはオフライン アクセスという機能があり、インターネットに接続されていない環境でも、ダウンロード済みの E メールやカレンダーを閲覧可能です。「条件付きアクセスでデスクトップの Outlook アプリを開けないようにしたい」という要望を条件付きアクセスで完全に実現することができないのはこのためです。</p><p>なお、クラウド上のサービスである Exchange Online を対象にした条件付きアクセス ポリシーを構成すれば、どのクライアント アプリからのアクセスであっても、そのポリシーが適用されます。Outlook からのアクセスであっても、Teams からであっても、自作の E メール アプリからであっても、Exchange Online (E メールやカレンダー) へのアクセスにはその条件付きアクセス ポリシーが適用されます。これも、条件付きアクセスは、クライアント アプリ (Outlook や Teams) ではなく、そのクライアント アプリがアクセスしようとしている先のクラウド上のサービス (Exchange Online) へのアクセスを制御する機能であるとご理解いただければ納得しやすいかと思います。</p><h2 id="条件付きアクセスの適用のされ方とポリシーの構成に対する考え方"><a href="#条件付きアクセスの適用のされ方とポリシーの構成に対する考え方" class="headerlink" title="条件付きアクセスの適用のされ方とポリシーの構成に対する考え方"></a>条件付きアクセスの適用のされ方とポリシーの構成に対する考え方</h2><p>条件付きアクセスは上述のように様々なアクセス制御を構成できますが、具体的にポリシーを構成する際は、以下のような点を考慮することをお勧めします。</p><ul><li>条件付きアクセスでは、ポリシーを設定しない (既定の状態の) 場合、すべてのアクセスが許可されます (資格情報以外の制御がかかりません)。</li><li>条件付きアクセスではアクセスのブロックや MFA の要求のようにアクセスに制限を掛けることはことはできますが、許可を設定する概念がありません。  </li><li>条件付きアクセスには、ファイアウォールのルールのように、どのポリシーにも当てはまらないものを最終的に既定でブロックするようなポリシーはなく、構成もできません。 </li><li>条件付きアクセスではポリシーの適用順序 (優先順位) を構成することはできません。</li><li>複数の条件付きアクセス ポリシーに合致する場合、それらが組み合わされて最も厳しい制御が適用されます。</li></ul><p>以上から、ファイアウォールのルール作成のようなイメージで条件付きアクセス ポリシーの作成を行うことはできません。</p><p>条件付きアクセス ポリシーを構成する際は、社員の方々 (実際の人間) の「会社のビル」や「会社のビル内の特定のフロア」への入退出の管理をイメージいただくと良いと思います。例えば、ある人が会社のビルに入る場合、入り口のゲートに社員証をかざしたり、守衛の方に社員証を見せるなどすると思います。会社のビルにアクセスする際には基本的にすべての人がこのような最低限の認証を行うはずです。皆が社員証を提示して入館したら、ビル内を基本的に自由に移動できますが、個人情報を扱うフロアに入るには追加の認証 (暗証番号など) が必要となる場合や、機密情報を扱う部屋には数名の限られた人のみ入室できるという場合もあるはずです。社員証を紛失したと報告してきた社員については、既存の社員証を廃止して再度本人確認する必要も生じます。</p><p>上記のような例に基づくと以下のような条件付きアクセス ポリシーが導き出されます。</p><ul><li>ポリシー 1: すべてのユーザーに資格情報と多要素認証を要求する (ビルへの入館に社員証を呈示することに相当)</li><li>ポリシー 2: 重要なサービスへのアクセスにはより強度の高い多要素認証を要求 もしくは 会社が管理するデバイスを要求する (個人情報を扱うフロアに入るには追加の認証が必要に相当)</li><li>ポリシー 3: 特定のサービスへのアクセスはすべての人をブロックする (一部のユーザーのみブロックから除外する) (数名の限られた人のみ入室できるに相当)</li><li>ポリシー 4: リスク (資格情報の漏洩) が生じたユーザーにはパスワード リセットを強制する (社員証を紛失した際に相当)</li></ul><p>以上のように、まず広く全員をカバーするポリシーを作り、それに加えて、アクセス先の各リソースやシナリオごとに追加の認証や条件を設けるというのがお勧めするポリシーの構成です。会社のビルへの入館やその後の社員の移動、リスクの発生など現実世界の人の動きをイメージいただくとよいと思います。Microsoft Entra という製品名は Entrance (入り口) を模していることもあり、このようなサービスへの入り口とお考えいただければ幸いです。</p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>条件付きアクセスがどのような機能であるかを簡単に説明しました。こちらを参考のうえ、条件付きアクセスをさらに活用いただければと思います。製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供しますので、ぜひ弊社サポート サービスをご利用ください。</p><p>本記事と併せて以下の記事も是非ご参照ください。</p><ul><li><a href="/blog/azure-active-directory/qanda-conditional-access/">Azure AD の条件付きアクセスに関する Q&amp;A</a></li><li><a href="https://github.com/yusukekodama/PMActivities/blob/master/Webinar/Schedule.md#season-3-2019%E5%B9%B4-3%E6%9C%88---6%E6%9C%88%E5%AE%9F%E6%96%BD">詳説！Azure AD 条件付きアクセス - 設計のやり方編</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの長谷川です。&lt;/p&gt;
&lt;p&gt;Microsoft Entra 条件付きアクセスは、Microsoft Entra ID が提供する主要機能であり、非常に多くのお客様にご利用いただいています。一方で、条件付</summary>
      
    
    
    
    
    <category term="Conditional Access" scheme="https://jpazureid.github.io/blog/tags/Conditional-Access/"/>
    
    <category term="Microsoft Entra" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Entra/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra の更新情報 (2023 年 11 月)</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/what-s-new-in-microsoft-entra-2023-11/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/what-s-new-in-microsoft-entra-2023-11/</id>
    <published>2023-12-03T01:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.711Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 高田 です。</p><p>本記事は、2023 年 11 月 30 日に米国の Microsoft Entra (Azure AD) Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/what-s-new-in-microsoft-entra/ba-p/3796394">What’s new in Microsoft Entra</a> の抄訳です。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>Microsoft はこのほど、組織のセキュリティ態勢の改善を支援することを目的として、Microsoft Entra 製品ファミリーにさまざまな新しいセキュリティ ツールと機能を導入しました。サイバー攻撃がますます巧妙化し、クラウドベースのサービスやモバイル デバイスの利用が増加する中、組織には自らのセキュリティを管理するための効果的なツールの導入が不可欠となっています。</p><p>進化する脅威を先取りし、AI の時代に安全なアクセスを実現するために、今月の <a href="https://ignite.microsoft.com/en-US/home">Microsoft Ignite</a> では、いくつかの重要な発表を行いました:</p><ul><li>ID のリスクへの迅速な対応を支援する Microsoft Entra + Security Copilot。</li><li>Microsoft Defender for Cloud と Microsoft Entra Permissions Management を統合し、マルチクラウド基盤の ID とアクセス許可に関する情報を統合。</li><li>Microsoft マネージド条件付きアクセス ポリシーの自動展開によるお客様の保護</li><li>Microsoft の Security Service Edge (SSE) 製品 (Microsoft Entra Internet Access および Microsoft Entra Private Access) の進化。</li><li>Microsoft Entra 証明書ベース認証 (CBA)。</li></ul><p>詳細は、ブログ「<a href="https://jpazureid.github.io/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/">Microsoft Ignite における ID: AI 時代におけるアクセスのセキュリティ保護</a>」をご覧ください。</p><p>本日は、過去 2 ヶ月間 (2023 年 10 月～ 11 月) の新機能リリースと、2023 年 11 月の変更管理を発表いたします。また、これらの変更点は <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/whats-new">リリース ノート</a> や電子メールでもお知らせしています。弊社では、お客様が新しい <a href="https://entra.microsoft.com/">Entra 管理センター</a> 内でも、非推奨、廃止、およびサービスの破壊的変更を含むライフサイクルの変更を管理しやすくするため、継続して取り組んでおります。</p><p>これらの最近のアップデートは、Microsoft Entra の製品エリアごとに整理しておりますので、最新のアップデートをすばやく見つけてアクセスいただけると存じます。これらの新機能が、より良い ID およびアクセス ソリューションの提供につながれば幸いです。</p><h2 id="製品の更新情報のまとめ"><a href="#製品の更新情報のまとめ" class="headerlink" title="製品の更新情報のまとめ"></a>製品の更新情報のまとめ</h2><ul><li>Microsoft Entra ID</li><li>Microsoft Entra ID Governance</li><li>Microsoft Entra Workload ID</li><li>Microsoft Entra External ID</li><li>Microsoft Entra Permissions Management</li></ul><h2 id="Microsoft-Entra-ID"><a href="#Microsoft-Entra-ID" class="headerlink" title="Microsoft Entra ID"></a>Microsoft Entra ID</h2><p>新機能の発表は以下のとおりです。</p><ul><li><a href="https://jpazureid.github.io/blog/azure-active-directory/advancing-modern-strong-authentication/">macOS および iOS におけるネイティブアプリでの FIDO2 サポート</a></li><li><a href="https://techcommunity.microsoft.com/t5/windows-it-pro-blog/what-s-new-with-windows-at-microsoft-ignite-2023/ba-p/3980507#2">AVD と Windows 365 での SSO とパスワードレス認証</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/concept-conditional-access-cloud-apps#microsoft-admin-portals">Microsoft 管理ポータルでの条件付きアクセスのサポート</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/custom-security-attributes-overview">Microsoft Entra ID におけるカスタム セキュリティ属性</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/Windows-Local-Administrator-Password-Solution-with-Microsoft-Entra-ID-now-Generally-Available!/">Microsoft Entra ID を用いた Windows Local Administrator Password ソリューション</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/whats-new#general-availability---enhanced-devices-list-management-experience">デバイスを一覧して管理する機能の改善</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/how-to-app-protection-policy-windows">Windows MAM</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/whats-new#general-availability---users-cant-modify-gps-location-when-using-location-based-access-control">場所ベースのアクセス管理を利用している場合に GPS の場所の書き変え不可</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions">有料ライセンスを持つテナントのみ Microsoft Entra ID テナントを作成可能に</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/whats-new">Android 版 Authenticator が FIPS-140 に準拠</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/whats-new">Chrome の CloudAPAuthEnabled をデバイスベースの条件付きアクセスで利用可能に</a></li></ul><h3 id="変更のアナウンス"><a href="#変更のアナウンス" class="headerlink" title="変更のアナウンス"></a>変更のアナウンス</h3><h4 id="条件付きアクセス-ポリシーの自動展開"><a href="#条件付きアクセス-ポリシーの自動展開" class="headerlink" title="条件付きアクセス ポリシーの自動展開"></a>条件付きアクセス ポリシーの自動展開</h4><p>[お客様によっては対応が必要です]</p><p>2023 年 11 月初めに、リスク情報、ライセンス、および使用状況に基づいて、お客様のテナントを自動的に保護する条件付きアクセス ポリシーの展開を <a href="https://www.microsoft.com/en-us/security/blog/2023/11/06/automatic-conditional-access-policies-in-microsoft-entra-streamline-identity-protection/">発表</a> しました。これは、Microsoft マネージド条件付きアクセス ポリシーと呼ばれるもので、お客様を自動的に保護することをお知らせするものです。このポリシーは、Microsoft が作成し、お客様のテナントで有効になるポリシーです。以下のポリシーが対象となる一部のテナントに展開されます:</p><table><thead><tr><th align="left">ポリシー</th><th align="left">対象のユーザー</th><th align="left">生じる動作</th></tr></thead><tbody><tr><td align="left">Require multifactor authentication for admin portals</td><td align="left">管理者ユーザー</td><td align="left">このポリシーは、特権ロールを持つ管理者を対象とし、それら管理者が Microsoft 管理者ポータルにサインインするときに多要素認証を要求します。</td></tr><tr><td align="left">Require multifactor authentication for per-user multifactor authentication users</td><td align="left">“ユーザーごとの MFA” 機能を使用しているユーザー</td><td align="left">このポリシーは、”ユーザーごとの MFA” 機能を使用しているユーザーに適用され、すべてのクラウド アプリに多要素認証を要求します。これにより “ユーザーごとの MFA” 機能から条件付きアクセスへの移行を促進します。</td></tr><tr><td align="left">Require multifactor authentication for high-risk sign-ins</td><td align="left">Microsoft Entra ID Premium P2 を十分な数お持ちのお客様</td><td align="left">このポリシーはテナントのすべてのユーザーを対象とし、リスクの高いサインイン時に多要素認証と再認証を要求します。</td></tr></tbody></table><p>対象となるすべてのテナントに対して、事前に通知の上、これらのポリシーを段階的に展開していきます。テナントでポリシーが表示されるようになったら、90 日以内にポリシーを確認し、カスタマイズするか、無効にするようご対応ください。この 90 日間は、ポリシーはレポート専用モードとなります。つまり、条件付きアクセスはポリシーを適用することなく、ポリシーが仮に適用された場合の結果をログに記録します。詳細については、ブログ「<a href="https://www.microsoft.com/en-us/security/blog/2023/11/06/automatic-conditional-access-policies-in-microsoft-entra-streamline-identity-protection/">Automatic Conditional Access policies in Microsoft Entra streamline identity protection</a>」を参照ください。</p><div class="alert is-info"><p class="alert-title">Note</p><p>サポート チームによる訳注: Microsoft マネージド条件付きアクセス ポリシーの詳細については、サポート チームより日本語のブログ記事である <a href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-managed-conditional-access-policies/">Microsoft マネージド条件付きアクセス ポリシー</a> を公開しております。併せてご参照ください。</p></div><h4 id="Azure-AD-Graph-の廃止に関する更新情報"><a href="#Azure-AD-Graph-の廃止に関する更新情報" class="headerlink" title="Azure AD Graph の廃止に関する更新情報"></a>Azure AD Graph の廃止に関する更新情報</h4><p>[お客様によっては対応が必要です]</p><p>2023 年 6 月、弊社は Azure AD Graph API サービスの非推奨化に関する 3 年にわたる事前通知の期間が完了したことを <a href="https://jpazureid.github.io/blog/azure-active-directory/important-azure-ad-graph-retirement-and-powershell-module/">発表</a> しました。このサービスは現在、廃止サイクルに入っており、廃止 (シャットダウン) は段階的に行われる予定です。弊社は、この廃止とMicrosoft Graph への移行に際しお客様を可能な限りサポートするようお約束するとともに、この変更に取り組む中で高い透明性と対話の取り組みを進めて参ることをお約束します。</p><h5 id="Azure-AD-Graph-の廃止-第一段階"><a href="#Azure-AD-Graph-の廃止-第一段階" class="headerlink" title="Azure AD Graph の廃止: 第一段階"></a>Azure AD Graph の廃止: 第一段階</h5><p>Azure AD Graph の廃止の第一段階は、2024 年後半に開始される予定です。具体的な日付は、最低 3 ヶ月前に予告し、その後のアップデートで共有します。</p><p>この第一段階に入ると、特定の日付以降に作成されたアプリケーションは、Azure AD Graph API (<a href="https://graph.windows.net/">https://graph.windows.net</a>) へのリクエスト時にエラーが生じるようになります。弊社ではこの時点で Microsoft Graph への移行が完了していないアプリケーションがまだ存在する可能性があることも承知しておりますので、この時点以降に作成されたアプリケーションが Azure AD Graph API をしばらくの期間延長して利用できるようにするための <strong>オプション設定</strong> を提供する予定です。インストールやセットアップの一環としてアプリケーションを作成および登録するようなソフトウェアをお客様が開発または配布しており、さらにこれらのアプリケーションが Azure AD Graph API にアクセスする必要がある場合は、廃止の影響を避けるために、速やかに移行作業を開始ください。このオプション設定は、アプリケーションの作成後に設定することができ、構成の変更は <a href="https://learn.microsoft.com/ja-jp/graph/applications-authenticationbehaviors?tabs=http">AuthenticationBehaviors</a> のインターフェイスを通して行います。</p><p>この計画の実施時期とオプション設定の構成に関するより詳細なガイダンスは、次回の更新でお知らせする予定です。</p><h5 id="Azure-AD-Graph-API-を使用しているテナント内のアプリケーションを見つけるにはどうしたらよいか？"><a href="#Azure-AD-Graph-API-を使用しているテナント内のアプリケーションを見つけるにはどうしたらよいか？" class="headerlink" title="Azure AD Graph API を使用しているテナント内のアプリケーションを見つけるにはどうしたらよいか？"></a>Azure AD Graph API を使用しているテナント内のアプリケーションを見つけるにはどうしたらよいか？</h5><p>Azure AD Graph API を使用しているテナント内のアプリケーションを特定するための新しい機能の提供に取り組んでいます。この機能は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/monitoring-health/howto-use-recommendations">Microsoft Entra の推奨事項</a> の機能を通じて利用可能になる予定です。この機能は、2024 年初頭に利用可能になる予定です。</p><h5 id="その他に利用可能なツール"><a href="#その他に利用可能なツール" class="headerlink" title="その他に利用可能なツール"></a>その他に利用可能なツール</h5><ul><li><a href="https://learn.microsoft.com/ja-jp/graph/migrate-azure-ad-graph-overview">Azure AD Graph から Microsoft Graph にアプリを移行する</a></li><li><a href="https://learn.microsoft.com/ja-jp/graph/migrate-azure-ad-graph-planning-checklist">Azure AD Graph アプリ移行計画のチェックリスト</a></li><li><a href="https://github.com/microsoft/AzureADGraphApps">Azure AD Graph を使用している可能性のあるアプリを特定するためのスクリプト</a></li><li><a href="https://learn.microsoft.com/ja-jp/powershell/microsoftgraph/azuread-msoline-cmdlet-map?view=graph-powershell-1.0">Microsoft Graph PowerShell SDK の PowerShell コマンドレットへの対応表</a></li></ul><h4 id="カスタム-セキュリティ属性に関する監査ログの動作変更"><a href="#カスタム-セキュリティ属性に関する監査ログの動作変更" class="headerlink" title="カスタム セキュリティ属性に関する監査ログの動作変更"></a>カスタム セキュリティ属性に関する監査ログの動作変更</h4><p>[お客様によっては対応が必要です]</p><p>2023 年 10 月より、一般公開に際してカスタム セキュリティ属性の監査ログに変更が加えられます。これにより監査ログを確認しているお客様においては日常業務に影響が出る可能性があります。プレビュー中にカスタム セキュリティ属性の監査ログを参照していた場合、監査ログの確認に関わる運用作業が中断されないようにするため、<strong>2024 年 2 月まで</strong> に以下の対応を実行する必要があります:</p><ul><li>監査ログの新しい出力場所を使用する。</li><li>監査ログを確認するユーザーに「Attribute Log」のロールを割り当てる。</li><li>監査ログをエクスポートする場合は新しい診断設定を作成する。</li></ul><p>詳細については、<a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/custom-security-attributes-manage?tabs=admin-center#changes-to-audit-logs-behavior">監査ログの動作に対する変更</a> を参照ください。</p><h4 id="新規アプリケーションにおける-signInAudience-プロパティの既定値の変更"><a href="#新規アプリケーションにおける-signInAudience-プロパティの既定値の変更" class="headerlink" title="新規アプリケーションにおける signInAudience プロパティの既定値の変更"></a>新規アプリケーションにおける signInAudience プロパティの既定値の変更</h4><p>[お客様による対応は不要です]</p><p>2024 年 3 月以降、Microsoft Graph のアプリケーション API を使用して作成された新しいアプリケーションでは、アプリケーション登録時の「signInAudience」プロパティの既定値が「AzureADandPersonalMicrosoftAccount」から「AzureADMyOrg」に変更されます。弊社の分析によると、ほとんどの新規アプリケーションでは、アプリケーションがテナント外のユーザーに利用されることはありません。この対応により、アプリケーションの応答速度とセキュリティが向上します。アプリケーションの signInAudience についての詳細は、ドキュメント <a href="https://learn.microsoft.com/ja-jp/graph/api/resources/application?view=graph-rest-1.0#signinaudience-values">アプリケーション リソースの種類 - Microsoft Graph v1.0 | Microsoft Learn</a> を参照ください。</p><h4 id="アプリ-インスタンス-ロックが既定で有効になる"><a href="#アプリ-インスタンス-ロックが既定で有効になる" class="headerlink" title="アプリ インスタンス ロックが既定で有効になる"></a>アプリ インスタンス ロックが既定で有効になる</h4><p>[お客様による対応は不要です]</p><p>2024 年 3 月以降、Microsoft Graph のアプリケーション API を使用して作成された新しいアプリケーションでは、既定で「アプリ インスタンス ロック」が有効になります。2023 年 9 月よりワークロード ID 用にアプリ インスタンス ロックと呼ばれる機能が提供されました。この機能により、アプリ開発者は、重要なプロパティを改竄しようとする攻撃者からマルチテナント アプリを保護できます。Entra ID ポータルを使用して作成されたアプリケーションは、すでにこの設定が既定で有効になっておりますので、今後は、MS Graph、PowerShell、SDK などの他のアプリ作成機能でも有効になる予定です。詳細については、<a href="https://learn.microsoft.com/ja-jp/entra/identity-platform/howto-configure-app-instance-property-locks">アプリケーションでアプリ インスタンス プロパティ ロックを構成する方法 - Microsoft identity platform | Microsoft Learn</a> を参照ください。</p><h4 id="従来のプロフィール-ページがマイ-アカウントに置き換わる"><a href="#従来のプロフィール-ページがマイ-アカウントに置き換わる" class="headerlink" title="従来のプロフィール ページがマイ アカウントに置き換わる"></a>従来のプロフィール ページがマイ アカウントに置き換わる</h4><p>[お客様による対応は不要です]</p><p>本年 6 月に、従来のプロフィール ページが新しいページに置き換えられることを <a href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-new-feature-and-change-announcements/">発表</a> しました。今後、<strong>2024 年 1 月</strong> までに既存のプロフィール ページ (<a href="https://account.activedirectory.windowsazure.com/r#/profile">https://account.activedirectory.windowsazure.com/r#/profile</a>) がマイ アカウント (<a href="https://www.myaccount.microsoft.com/">https://www.myaccount.microsoft.com</a>) に置き換えられます。マイ アカウントでは、アカウントの詳細、言語、プライバシー設定、セキュリティ情報などを管理することが可能です。マイ アカウントは数年前から利用可能であり、従来のプロフィール ページのすべての機能を備えています。今回の廃止により、お客様はより良く、より先進的な体験に移行されます。自動的に新しいマイ アカウントに遷移するため、お客様による操作は必要ありません。</p><h2 id="Microsoft-Entra-ID-Governance"><a href="#Microsoft-Entra-ID-Governance" class="headerlink" title="Microsoft Entra ID Governance"></a>Microsoft Entra ID Governance</h2><p>新機能の発表は以下のとおりです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/app-provisioning/inbound-provisioning-api-concepts">API 駆動型のインバウンドプロビジョニング</a></li><li><a href="https://learn.microsoft.com/ja-jp/graph/api/resources/privilegedidentitymanagement-for-groups-api-overview?view=graph-rest-1.0">グループ用の PIM の API</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/hybrid/cloud-sync/exchange-hybrid">Microsoft Entra Cloud 同期が Exchange ハイブリッドの書き戻しをサポート</a></li></ul><h2 id="Microsoft-Entra-Workload-ID"><a href="#Microsoft-Entra-Workload-ID" class="headerlink" title="Microsoft Entra Workload ID"></a>Microsoft Entra Workload ID</h2><p>新機能の発表は以下のとおりです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/enterprise-apps/restore-application?tabs=http&pivots=aad-powershell">マネージド サービス ID のソフト デリート機能</a></li></ul><h2 id="Microsoft-Entra-External-ID"><a href="#Microsoft-Entra-External-ID" class="headerlink" title="Microsoft Entra External ID"></a>Microsoft Entra External ID</h2><p>新機能の発表は以下のとおりです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/users/clean-up-stale-guest-accounts#monitor-guest-accounts-at-scale-with-inactive-guest-insights-preview">ゲストに対するガバナンス - 利用されていないゲストのレビュー</a></li></ul><h2 id="Microsoft-Entra-Permissions-Management"><a href="#Microsoft-Entra-Permissions-Management" class="headerlink" title="Microsoft Entra Permissions Management"></a>Microsoft Entra Permissions Management</h2><p>新機能の発表は以下のとおりです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/entra/permissions-management/how-to-configure-servicenow-application">Microsoft Entra Permissions Management と ServiceNow の連携</a></li></ul><p>以上の内容が参考になれば幸いです。</p><p>Shobhit Sahay</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 高田 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 11 月 30 日に米国の Microsoft Entra (Azure AD) Blog で公開された &lt;a href=&quot;https://techcommun</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Ignite における ID: AI 時代におけるアクセスのセキュリティ保護</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/</id>
    <published>2023-12-03T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.395Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 五十嵐 です。</p><p>本記事は、2023 年 11 月 15 日に米国の Microsoft Entra (Azure AD) Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/ba-p/2747279">Identity at Microsoft Ignite: Securing access in the era of AI</a> の抄訳です。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>デジタルの世界が拡大し続けるにつれ、サイバーセキュリティのリスクと課題も拡大しています。サイバー攻撃のスペシャリストを抱える悪意ある組織が、国家や犯罪組織から資金提供を受ける一方、我々が守るべき ID、エンドポイント、アプリ、データは増え続けています。また、AI の新時代では、悪意のある攻撃者 (内部犯を含む) が組織に損害を与える方法は数えきれないぐらい存在するでしょう。</p><p>弊社が <a href="https://www.microsoft.com/ja-jp/security/business/microsoft-entra?rtc=1">Microsoft Entra</a> に追加する機能はすべて、進化する脅威の状況を先取りできるようにするためのものです。すべては、お客様が自身の環境をより容易に安全に保てるようにするという 1 つの原則に帰着します。攻撃からの防御を担当するチームを擁する大企業であれ、IT 部門をまったく持たない中小企業であれ、適切なツールを導入し、適切なポリシーを設定するお手伝いをしたいと考えています。<a href="https://ignite.microsoft.com/en-US/home">Microsoft Ignite 2023</a> では、Microsoft Entra の新機能と機能強化を発表しました:</p><p><strong>発表:</strong></p><ul><li>Microsoft Entra + Security Copilot</li><li>Security Service Edge - Microsoft Entra Internet Access および Microsoft Entra Private Access ですべてのアプリケーションとリソースへのアクセスを保護</li><li>Microsoft マネージド条件付きアクセス ポリシーの自動展開</li><li>より強固な権限管理のための機能の統合</li></ul><h2 id="Microsoft-Entra-Security-Copilot"><a href="#Microsoft-Entra-Security-Copilot" class="headerlink" title="Microsoft Entra + Security Copilot"></a>Microsoft Entra + Security Copilot</h2><p>アクセスを保護するには、テクノロジーだけでなく、ビジネス ポリシーや規制についても深く理解する必要があり、時にこれがセキュリティ専門家に過大な業務を負わせることにつながります。この度、<a href="https://www.microsoft.com/ja-jp/security/business/ai-machine-learning/microsoft-security-copilot?rtc=1">Microsoft Security Copilot</a> が Microsoft Entra に追加され、一般的なタスクの自動化、迅速なトラブルシューティング、複雑なポリシーの解釈、ワークフローの設計を支援できるようになりました。</p><p>Microsoft Entra 管理センターでは、Security Copilot に対し、その条件付きアクセス ポリシーが何を行うものなのか、なぜ MFA がトリガーされたのかを、簡単な会話形式で説明してもらうことができます。Security Copilot を使用して、ユーザーがサインインできなかった理由など、ID 関連のトラブルシューティングを行うこともできます。また、組み込みの Security Copilot エクスペリエンスでは、リスクのある各 ID について、リスクの概要、修復手順、推奨ガイダンスが表示され、ID のリスクに迅速に対応できます。ワークフローの作成支援機能を使用して、新入社員のオンボーディングなど、入社、異動、退職のシナリオで ID ガバナンスのライフサイクル ワークフローを構築する際に、より効率的に操作が可能となります。</p><p>セキュリティ インシデントを調査する場合、関連するサインイン ログと監査ログについて Security Copilot に尋ねることで、文脈に基づいた分析情報を得ることができます。そして、特定のユーザー、グループ、ワークロード、サインイン、ロール、セキュリティ アラートなどの詳細を取得することも可能です。Security Copilot の <a href="https://forms.office.com/pages/responsepage.aspx?id=v4j5cvGGr0GRqy180BHbR2sE-_D9S11Ir8rACvMiWdVUREM4TUg1TzNNS0MzNlNBOVQxVEdQV1VLRi4u">プライベート プレビュー</a> に今すぐ登録すると共に、今後のすべての開発に関する最新情報を入手するために、<a href="https://info.microsoft.com/ww-landing-security-ai-interest-form.html?LCID=EN-US">こちらにサインアップ</a> ください。さらに、Microsoft Security Copilot を自社のソリューションで使用したいと考えているセキュリティ パートナーの皆様は、<a href="https://forms.microsoft.com/pages/responsepage.aspx?id=v4j5cvGGr0GRqy180BHbR7GkZxmcvGdGql1aVgLqRR1UNEk0MTVPVjg1VjhPMUJHVTZETlRXSk1RQy4u">Security Copilot パートナー エコシステム</a> にご登録ください。</p><p><img src="/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai1.jpg" alt="Microsoft Entra 管理センターでは、Microsoft Security Copilot が、その条件付きアクセス ポリシーは何をするためのものなのか、なぜ MFA が要求されたのかなどを、簡単な会話形式で説明してくれます。"></p><h2 id="Security-Service-Edge-ですべてのアプリケーションとリソースへのアクセスを保護"><a href="#Security-Service-Edge-ですべてのアプリケーションとリソースへのアクセスを保護" class="headerlink" title="Security Service Edge ですべてのアプリケーションとリソースへのアクセスを保護"></a>Security Service Edge ですべてのアプリケーションとリソースへのアクセスを保護</h2><p>Microsoft の Security Service Edge (SSE) ソリューションは <a href="https://entra.microsoft.com/#view/Microsoft_Azure_Network_Access/Welcome.ReactView">現在プレビュー中</a> で、Microsoft Entra Internet Access と Microsoft Entra Private Access により、ユーザーとデバイスがどこにいようと、あらゆるアプリケーションやリソースへのアクセスを保護します。</p><p>Microsoft の SSE ソリューションと Microsoft Entra 製品群の統合により、あらゆるアプリケーションや Web サイトへのアクセスを許可する前に、ID、デバイス、アプリケーション、さらに今後はネットワークの条件を考慮した、統合された条件付きアクセス ポリシーを適用することが可能になります。これは、アプリケーションがどの ID プロバイダーを使用しているかに関係なく、さらにアプリケーションに変更を加えることなく機能します。</p><p><img src="/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai2.png"></p><p>皆様の多くが既にお試しの <a href="https://www.microsoft.com/ja-jp/security/business/identity-access/microsoft-entra-internet-access?rtc=2">Microsoft Entra Internet Access</a> は、Microsoft 365 トラフィックを安全に保つための ID 中心のセキュア Web ゲートウェイ (SWG) です。弊社は、2023 年末までにすべてのインターネット アプリとリソースを含むようにパブリック プレビューを拡張し、次のような新しいコア機能を追加する予定です:</p><ul><li><strong>アクセスの文脈を考慮した SWG</strong>: Web コンテンツフィルタリング機能を備えたもので、エンド ユーザーによる安全でないコンテンツやコンプライアンス違反のコンテンツへのアクセスを制限します。</li><li><strong>ユニバーサル条件付きアクセス</strong>: 外部 Web サイトやフェデレーション連携していない SaaS アプリケーションなど、あらゆるネットワークの宛先に適応型のアクセス制御を拡張します。</li><li><strong>準拠済みネットワークのチェック機能</strong>: これは条件付きアクセスにて利用できる、管理のしやすい追加機能です。この機能により、Microsoft Entra に統合された統合クラウド アプリケーションをトークンの盗難から保護し、ユーザーを重要なクラウド サービスにアクセスさせつつ、テナント固有のネットワーク セキュリティ ポリシーを確実に適用できるようにします。</li><li><strong>アクセス元 IP の復元機能</strong> が ID Protection と条件付きアクセスの場所のポリシーで利用可能となります。これにより、各ユーザーの本来のアクセス元 IP を維持し、信頼できる場所のチェックと継続的なアクセス評価、ID リスクの検出、およびログ記録の下位互換性が可能となります。</li></ul><p><a href="https://www.microsoft.com/ja-jp/security/business/identity-access/microsoft-entra-private-access?rtc=1">Microsoft Entra Private Access</a> は、あらゆる社内アプリケーションやリソースのための、ID を中心としたゼロ トラスト ネットワーク アクセス (ZTNA) です。プライベート プレビューの新機能は以下のとおりです:</p><ul><li>TCP に加えて、UDP やプライベート DNS などより多くのプロトコルをサポートします。これにより、従来の仮想プライベート ネットワーク (VPN) から最新の ZTNA ソリューションに移行が可能となります。</li><li>条件付きアクセス制御に加え、多要素認証 (MFA) などの最新の認証方式により、リモート ユーザーとオンプレミス ユーザーによるすべての社内アプリケーションおよびリソースへのアクセスを保護します。</li></ul><p>当社の SSE ソリューションは、Microsoft のセキュリティ スタックおよびオープン パートナー エコシステム全体にわたる統合を通じて、お客様の既存のセキュリティおよびネットワーク ソリューションと連携が可能です。弊社では、<a href="https://docs.netskope.com/en/netskope-help/integrations-439794/solution-guides/microsoft-security-and-netskope-integration-solution-guide/microsoft-and-netskope-sse-coexistence/">Netskope</a> を始めとするこの分野の他のベンダーと提携し、同じ環境でのシームレスな相互運用を実証中です。お客様の環境のネットワーク トラフィックに対し、最適な SSE ソリューションを柔軟に選択できるようにすることをお約束します。併せて、Internet Access と Private Access の両方について、Windows と Android に対するクロス OS のクライアントサポートが現在パブリックプレビューにあること、また MacOS と iOS のサポートもプライベート プレビューにあることも発表しました。SSE ソリューションは現在、中国とロシアを除く全世界で利用可能であり、将来的には SSE のエッジ ロケーションも提供される予定です。</p><p>近日開催予定の <a href="https://techcommunity.microsoft.com/t5/tech-community-live/microsoft-security-tech-accelerator/ec-p/3968748#M20">Tech Accelerator Ask Microsoft Anything (AMA) セッション</a> に是非参加し、Microsoft の SSE ソリューションに関するあらゆる疑問について製品のエキスパートにご相談ください。</p><h2 id="Microsoft-マネージド条件付きアクセス-ポリシーの自動ロールアウトなど"><a href="#Microsoft-マネージド条件付きアクセス-ポリシーの自動ロールアウトなど" class="headerlink" title="Microsoft マネージド条件付きアクセス ポリシーの自動ロールアウトなど"></a>Microsoft マネージド条件付きアクセス ポリシーの自動ロールアウトなど</h2><p>昨年、弊社では約 700 万の既存テナントに対して Microsoft Entra ID (旧 <a href="https://learn.microsoft.com/ja-jp/entra/fundamentals/new-name">Azure Active Directory</a>) のセキュリティの既定値群を有効にし、これらのテナントにおける侵害の件数を 80% 削減しました。お客様からの好意的なフィードバックに基づき、弊社ではさらに、お客様のリスク情報、現在の使用状況、およびライセンスに基づいて、対象となるテナントに条件付きアクセス ポリシーを自動的に作成することで、より多くの Microsoft Entra ID のお客様が自身を保護できるよう支援してまいります。<strong>Microsoft マネージド条件付きアクセス ポリシー</strong> が展開されると、リスクが高いと想定されるシナリオにて多要素認証 (MFA) を実施する 3 つのポリシーが作成されます。詳細については、Alex Weinert の最近のブログ記事 <a href="https://www.microsoft.com/en-us/security/blog/2023/11/06/automatic-conditional-access-policies-in-microsoft-entra-streamline-identity-protection/">Automatic Conditional Access policies in Microsoft Entra streamline identity protection</a> をご覧ください。</p><p><img src="/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai3.png" alt="こちらが Microsoft マネージド条件付きアクセス ポリシーが作成されたテナントです。ポリシーの詳細が右側のコンテキスト ウィンドウに表示されています。選択されているポリシーでは、特定の管理者ロールが Microsoft 管理ポータルにアクセスする際に多要素認証の実施を必須とすることが示されています。"></p><p>しかし、すべての MFA の方法が同等にユーザーを保護するわけではありません。FIDO2 セキュリティ キー、Windows Hello、**Microsoft Entra 証明書ベース認証 (CBA)**、パスキーなど、より効果的な MFA の方法では暗号技術が使用されており、認証にフィッシング耐性が付与されます。Microsoft Entra CBA のプレビューでは、証明書、リソースの種類、ユーザーおよびグループごとに認証ポリシーを調整することが可能です。これらのフィッシングに強い認証方式により、パスワードを完全に排除することが可能になり、パスワードの推測、傍受、フィッシングを防ぐことが可能となります。</p><p>Microsoft は、Windows 11 を皮切りに、エコシステム全体でパスキーのサポートに取り組んでいます。Windows Hello を使用して Web サイト、アプリケーション、またはサービスのパスキーを作成すると、顔、指紋、またはデバイスの PIN を使用してデバイスからサインイン可能となります。これにより、企業や政府機関のお客様は、物理的な FIDO2 セキュリティ キーに代わる、フィッシングに強い新たな選択肢を得ることができます。Microsoft Entra ID ユーザーは、まもなく <strong>Microsoft Authenticator アプリ</strong> にて管理されるパスキーを使用してサインインできるようになります。</p><p><img src="/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai4.png"></p><p>最後に、<a href="https://www.microsoft.com/ja-jp/security/business/identity-access/microsoft-entra-id-protection?rtc=1">Microsoft Entra ID Protection</a> では、トークンの有効期間が異常に長い場合や、なじみのない場所からトークンが再生された場合などの異常を検出するようになりました。アラートが上がると、条件付きアクセスを用いて直ちにトークンを失効させ、パスワードのリセットやステップアップ MFA などの他の対策とともに、管理者による手動での介入を必要とせずに再認証を強制することができます。また、ユーザーがオンプレミスでパスワードを変更した場合に、Entra ID Protection は <a href="https://jpazureid.github.io/blog/azure-active-directory/Remediate-User-Risks-in-Microsoft-Entra-ID-Protection-Through-On-premises-Password-Changes/">自動的にリスクを修復</a> できるようになりました。これにより、ハイブリッド組織はユーザー リスク ポリシーをより簡単に利用できるようになります。</p><h2 id="より強固な権限管理のための機能の統合"><a href="#より強固な権限管理のための機能の統合" class="headerlink" title="より強固な権限管理のための機能の統合"></a>より強固な権限管理のための機能の統合</h2><p><a href="https://www.microsoft.com/ja-jp/security/business/identity-access/microsoft-entra-permissions-management?rtc=1">Microsoft Entra Permissions Management</a> は、このたび権限リスクに関する分析情報を提供する 2 つの重要な統合機能を備えました。これにより、お客様はよりセキュリティ態勢を改善できるようになります。</p><p><a href="https://learn.microsoft.com/ja-jp/entra/permissions-management/permissions-management-for-defender-for-cloud">Microsoft Defender for Cloud (MDC) 統合</a> のプレビューは、ID とアクセス許可に関する分析情報を他のクラウド セキュリティ情報と統合し、単一のインターフェイスで表示します。このビューでは、権限リスクに対処するための実用的な推奨事項やアクセス許可のクリープ インデックスが表示され、Azure、Amazon Web Services (AWS)、Google Cloud のクラウド リソースに対して最小権限でのアクセスを簡単に実施できるようになります。</p><p><img src="/blog/azure-active-directory/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai/identity-at-microsoft-ignite-securing-access-in-the-era-of-ai5.png" alt="Microsoft Entra Permissions Management と Microsoft Defender for Cloud (MDC) (現在パブリック プレビュー中) の統合により、他のクラウドのセキュリティ態勢に関する分析情報を単一のインターフェイスに統合して効率的に確認できるようになります。"></p><p>このたび一般提供が開始された <a href="https://learn.microsoft.com/ja-jp/entra/permissions-management/how-to-configure-servicenow-application">2 つ目の統合</a> により、ServiceNow のお客様は、ServiceNow ポータルを介してマルチクラウド環境 (Azure、AWS、Google Cloud) に対し、期限付きのオンデマンド許可を要求できるようになりました。IT サービス管理 (ITSM) ソリューションは多くのお客様で利用されているため、ServiceNow の既存の承認ワークフローにアクセス許可要求を追加することで、ゼロ トラストの体制より強化することが可能となります。ユーザーがアクセス承認を要求すると、ServiceNow のプラグインが Permissions Management から最新のデータを取得し、要求されたユーザー権限を要求者のロールに基づく期限付きの承認とともに ServiceNow に送り返します。</p><h2 id="進化するセキュアな-ID-とネットワーク-アクセス"><a href="#進化するセキュアな-ID-とネットワーク-アクセス" class="headerlink" title="進化するセキュアな ID とネットワーク アクセス"></a>進化するセキュアな ID とネットワーク アクセス</h2><p>包括的な機能を備えた Microsoft Entra という単一の統合ソリューションを採用することで、管理者のアクセス セキュリティを簡素化し、エンドユーザにより良い体験を提供することができます。</p><p>Microsoft Entra の製品群は互いに連携し、お客様の ID、デバイス、ネットワーク、およびワークロードのセキュリティを保護してまいります。これは、特定のユーザーの種類に限らず、お客様、パートナー、デジタル ワークロードなど、あらゆる種類に対応が可能です。そして今、Microsoft Entra は SSE ソリューションによって、ID とネットワークのアクセス制御を単一のポリシー エンジンに統合させようと取り組んでいます。</p><p>Microsoft Entra の最新のイノベーションにより、すべての人のあらゆるものへのアクセスを簡単に保護できるようになることを願っています。</p><p>最近の発表の詳細については、Ignite 2023 での私のセッション <a href="https://ignite.microsoft.com/en-US/sessions/07952ef8-8603-4a94-8185-975ae95e53bb?source=sessions">Secure access in the AI era: What’s new in Microsoft Entra</a> をご覧ください。</p><h2 id="詳細はこちら"><a href="#詳細はこちら" class="headerlink" title="詳細はこちら"></a>詳細はこちら</h2><p>Microsoft のセキュリティ ソリューションの詳細については、<a href="https://www.microsoft.com/ja-jp/security/?rtc=1">当社の Web サイト</a> をご覧ください。<a href="https://www.microsoft.com/en-us/security/blog/">セキュリティ ブログ</a> をブックマークしておくと、セキュリティに関する最新情報をチェックできます。また、<a href="https://twitter.com/MSFTSecurity">@MSFTSecurity</a> でサイバーセキュリティに関する最新ニュースや最新情報をフォローください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 五十嵐 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 11 月 15 日に米国の Microsoft Entra (Azure AD) Blog で公開された &lt;a href=&quot;https://techcommu</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra ID に必要な通信先エンドポイントのまとめ</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-endpoints/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azure-ad-endpoints/</id>
    <published>2023-12-01T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.083Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの大庭です。</p><p>今回はよくご質問をいただく Microsoft Entra ID をご利用いただく際に必要となるエンドポイント (URL/IP アドレス) について案内します。Microsoft Entra ID においては認証からアカウント管理、アカウント同期に至るまで複数のサービスを提供しており、ご利用いただく機能によってアクセス先のエンドポイントが異なります。お客様によっては、ネットワーク プロキシにて厳密に接続可能なエンドポイント (URL) 先を制御されている場合があり、そういった制御を行われているお客様では、正常にサービスを利用するために個別にエンドポイント (URL/IP アドレス) への通信を許可する必要があります。</p><p>本記事においては、現時点で提供している Microsoft Entra ID の各サービスに関し、必要となるエンドポイントを記載した公開資料へのリンクをまとめます。これにより、「どのエンドポイントに対してアクセス許可をすればいいのかまとめて知りたい！」といったご要望にお応え出来たら幸いです。</p><div class="alert is-info"><p class="alert-title">Note</p><p>サポート チームにて可能な限り迅速かつ網羅的な情報の更新に努めておりますが、本記事にてすべての情報の網羅ができているわけではありません。サービスが利用するエンドポイントはドキュメントの更新とともに変化する可能性があります。正式な案内については各公開情報を参照いただくか、弊社サポート サービスまでお問い合わせください。</p></div><h2 id="Microsoft-Entra-ID-で基本的に利用されるエンドポイント"><a href="#Microsoft-Entra-ID-で基本的に利用されるエンドポイント" class="headerlink" title="Microsoft Entra ID で基本的に利用されるエンドポイント"></a>Microsoft Entra ID で基本的に利用されるエンドポイント</h2><p>まず初めに Microsoft Entra ID を利用いただく際に基本的に必要となるエンドポイントは、<a href="https://learn.microsoft.com/ja-jp/microsoft-365/enterprise/urls-and-ip-address-ranges?view=o365-worldwide#microsoft-365-common-and-office-online">Office 365 の URL と IP アドレスの範囲</a> に記載されている ID 56 , ID 59 そして ID 125 になります。こちらは Microsoft 365 を利用する際に Micorosft Entra ID を利用するシナリオで最低限必要となるエンドポイントをまとめたものです。Microsoft Entra ID をご利用いただく際は、認証を行うクライアントからこれらのエンドポイントについてネットワークの疎通を確保ください。</p><h2 id="Microsoft-Entra-ID-でデバイス管理に利用するエンドポイント"><a href="#Microsoft-Entra-ID-でデバイス管理に利用するエンドポイント" class="headerlink" title="Microsoft Entra ID でデバイス管理に利用するエンドポイント"></a>Microsoft Entra ID でデバイス管理に利用するエンドポイント</h2><p>Entra ID では Microsoft Entra ハイブリッド参加、Microsoft Entra 参加そして Microsoft Entra 登録、という 3 つの方法でデバイスを登録することができます。いずれの方法を利用する場合でも、<a href="https://learn.microsoft.com/ja-jp/entra/identity/devices/how-to-hybrid-join#network-connectivity-requirements">Microsoft Entra ハイブリッド参加を構成する</a> のページに記載されているエンドポイントを許可ください。</p><h2 id="Microsoft-Entra-ID-にて利用規約を利用するエンドポイント"><a href="#Microsoft-Entra-ID-にて利用規約を利用するエンドポイント" class="headerlink" title="Microsoft Entra ID にて利用規約を利用するエンドポイント"></a>Microsoft Entra ID にて利用規約を利用するエンドポイント</h2><p>Microsoft Entra ID にて利用規約を利用する場合は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/conditional-access/terms-of-use#frequently-asked-questions">Microsoft Entra の利用規約のよく寄せられる質問</a> のページにある “Q: 利用規約サービスにはどのエンドポイントが認証に使用されますか？” に記載されているエンドポイントを許可ください。</p><h2 id="Microsoft-Entra-Connect-に関連するエンドポイント"><a href="#Microsoft-Entra-Connect-に関連するエンドポイント" class="headerlink" title="Microsoft Entra Connect に関連するエンドポイント"></a>Microsoft Entra Connect に関連するエンドポイント</h2><p>Microsoft Entra Connect を利用して、ハイブリッド ID ソリューション (オンプレミスからのアカウントの同期) を利用される際に必要な URL と IP アドレスの一覧については上記の「Microsoft Entra ID で基本的に利用されるエンドポイント」の節をご覧ください。また併せて、<a href="https://learn.microsoft.com/ja-jp/entra/identity/hybrid/connect/tshoot-connect-connectivity">Microsoft Entra Connect の接続に関する問題のトラブルシューティング</a> のページも参照をお勧めします。開放が必要なネットワーク ポートとプロトコルについては、<a href="https://learn.microsoft.com/ja-jp/entra/identity/hybrid/connect/reference-connect-ports">ハイブリッド ID で必要なポートとプロトコル</a> のページにも説明がありますのでご覧ください。</p><h2 id="Microsoft-Entra-Connect-Health-Service-に利用するエンドポイント"><a href="#Microsoft-Entra-Connect-Health-Service-に利用するエンドポイント" class="headerlink" title="Microsoft Entra Connect Health Service に利用するエンドポイント"></a>Microsoft Entra Connect Health Service に利用するエンドポイント</h2><p>Microsoft Entra Connect Health Service を利用する場合は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/hybrid/connect/how-to-connect-health-agent-install#outbound-connectivity-to-azure-service-endpoints">Microsoft Entra Connect Health エージェントのインストール</a> ページに記載されているエンドポイントを許可ください。</p><h2 id="Microsoft-Entra-アプリケーション-プロキシ-コネクタにて利用されるエンドポイント"><a href="#Microsoft-Entra-アプリケーション-プロキシ-コネクタにて利用されるエンドポイント" class="headerlink" title="Microsoft Entra アプリケーション プロキシ コネクタにて利用されるエンドポイント"></a>Microsoft Entra アプリケーション プロキシ コネクタにて利用されるエンドポイント</h2><p>Microsoft Entra アプリケーション プロキシ コネクタを利用される際は、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/app-proxy/application-proxy-add-on-premises-application#prepare-your-on-premises-environment">アプリケーション プロキシを使用してオンプレミス アプリを追加する</a> ページに記載されているエンドポイントを許可ください。</p><h2 id="Microsoft-Entra-プロビジョニング-サービスを利用する-IP-アドレスの範囲"><a href="#Microsoft-Entra-プロビジョニング-サービスを利用する-IP-アドレスの範囲" class="headerlink" title="Microsoft Entra プロビジョニング サービスを利用する IP アドレスの範囲"></a>Microsoft Entra プロビジョニング サービスを利用する IP アドレスの範囲</h2><p>Microsoft Entra プロビジョニング サービスを利用する場合は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/app-provisioning/use-scim-to-provision-users-and-groups#ip-ranges">チュートリアル: Microsoft Entra ID の SCIM エンドポイントのプロビジョニング</a> に記載されている IP アドレスの範囲を参照ください。</p><h2 id="オンプレミスにある-Multi-Factor-Authentication-Server-が利用するエンドポイント"><a href="#オンプレミスにある-Multi-Factor-Authentication-Server-が利用するエンドポイント" class="headerlink" title="オンプレミスにある Multi-Factor Authentication Server が利用するエンドポイント"></a>オンプレミスにある Multi-Factor Authentication Server が利用するエンドポイント</h2><p>2024 年 9 月 30 日にサービスの提供終了がアナウンスがされていますが、オンプレミスの MFA サーバーを利用する場合は、<a href="https://learn.microsoft.com/ja-jp/entra/identity/authentication/howto-mfaserver-deploy#azure-multi-factor-authentication-server-firewall-requirements">Azure Multi-Factor Authentication Server のファイアウォールの要件</a> に記載されているエンドポイントを許可ください。</p><h2 id="Microsoft-Private-Access-用にアプリケーション-プロキシ-コネクタにて利用されるエンドポイント"><a href="#Microsoft-Private-Access-用にアプリケーション-プロキシ-コネクタにて利用されるエンドポイント" class="headerlink" title="Microsoft Private Access 用にアプリケーション プロキシ コネクタにて利用されるエンドポイント"></a>Microsoft Private Access 用にアプリケーション プロキシ コネクタにて利用されるエンドポイント</h2><p>Microsoft Entra Private Access 用にアプリ プロキシ コネクタについては、<a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/how-to-configure-connectors#allow-access-to-urls">Microsoft Entra Private Access 用にアプリ プロキシ コネクタを構成する方法</a> に記載されているエンドポイントを許可ください。</p><h2 id="Microsoft-Azure-管理センターおよび一般的なサービスに利用されるエンドポイント"><a href="#Microsoft-Azure-管理センターおよび一般的なサービスに利用されるエンドポイント" class="headerlink" title="Microsoft Azure 管理センターおよび一般的なサービスに利用されるエンドポイント"></a>Microsoft Azure 管理センターおよび一般的なサービスに利用されるエンドポイント</h2><p>Microsoft Entra ID の認証ではないですが、Azure ポータルや一般的なアカウント サービスに必要となるエンドポイントは、<a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/azure-portal-safelist-urls?tabs=public-cloud">ファイアウォールまたはプロキシ サーバーで Azure portal の URL を許可する</a> のページに記載されているエンドポイントを許可ください。</p><p>今後、Entra ID をご利用いただく際に本ブログの内容が少しでも参考となりますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの大庭です。&lt;/p&gt;
&lt;p&gt;今回はよくご質問をいただく Microsoft Entra ID をご利用いただく際に必要となるエンドポイント (URL/IP アドレス) について案内します。Microsof</summary>
      
    
    
    
    
    <category term="Entra ID" scheme="https://jpazureid.github.io/blog/tags/Entra-ID/"/>
    
    <category term="Network" scheme="https://jpazureid.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>エンタイトルメント管理におけるカスタム拡張機能の利用方法</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/access-package-with-custom-extension/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/access-package-with-custom-extension/</id>
    <published>2023-11-26T01:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.007Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure ID チームの小出です。</p><p>今回は、Microsoft Entra ID のエンタイトルメント管理 (アクセス パッケージ) の機能をより活用できる、カスタム拡張機能について紹介します。</p><p>今回の記事は、アクセス パッケージを既にご利用いただいており、基本的な操作を理解いただいている方をターゲットとした、中級者向けの案内です。アクセス パッケージを初めて触るお客様や、これから導入を検討されているお客様などで基本的な概要を確認されたい場合、以前公開いたしました以下の記事を先にご覧ください。</p><p><a href="https://jpazureid.github.io/blog/azure-active-directory/access-management-with-access-package/">アクセス パッケージを利用した一括でのアクセス権の管理</a></p><p>今回は、カスタム拡張機能を利用した操作の例を紹介します。次回の記事にて、ライフサイクル ワークフローとこのアクセス パッケージのカスタム拡張機能を利用した上級編シナリオのご紹介を予定しております。まずは本記事にて基本的な手順や利用方法を確認いただければと思います。</p><h2 id="カスタム拡張機能とは"><a href="#カスタム拡張機能とは" class="headerlink" title="カスタム拡張機能とは"></a>カスタム拡張機能とは</h2><p>アクセス パッケージに対する要求や割り当て期限が迫っている時など特定のイベントについて、事前に設定したカスタム タスクを実行する機能です。アクセス パッケージを作成するときに、任意項目なのでスキップしてしまいがちですが、以下のように「カスタム拡張機能」を指定するよう構成することができます。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension1.png"></p><p>たとえば上記スクリーンショットでは、アクセス パッケージの割り当てが行われたことを E メールで通知するようにカスタム拡張機能を構成しています。その他にもカスタム拡張機能の実行のタイミングとして以下を選択可能です。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension2.png"></p><p>カスタム拡張機能自体は「カタログ」内に項目があり、以下から新しい拡張機能を作成することができます。また、以下の例では PackageTask1 というロジック アプリにカスタム拡張機能を紐づけ、カスタム拡張機能が呼び出されるとこのロジック アプリが実行される仕組みになっています。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension3.png"></p><p>ロジック アプリを呼び出した後、具体的にどんな処理を行わせたいかは、お客様側で自由に記載することができます。また、プログラミング スキルがなくても、以下のようなデザイナーを使って、どのような処理を行いたいかを GUI 上で構成することが可能です。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension4.png"></p><h2 id="事前に理解いただきたいこと"><a href="#事前に理解いただきたいこと" class="headerlink" title="事前に理解いただきたいこと"></a>事前に理解いただきたいこと</h2><ul><li>ロジック アプリと連携するためには、事前に Azure サブスクリプションの用意が必要です。</li><li>ロジック アプリ側で課金が発生します。<strong>コスト面も必ず評価のうえご利用ください。</strong></li><li>アクセス パッケージの機能については、 Microsoft Entra ID Premium P2 ライセンスが必要ですが、カスタム拡張属性も利用したい場合、<strong>新しい Microsoft Entra ID Governance ライセンスが必要です。</strong></li><li>スクリプト作成支援と同様、<strong>ロジック アプリの具体的な記載方法などについてはサポートでは支援が難しい場合があります。</strong> ロジック アプリの作成方法などはロジック アプリの観点で支援が可能ですが、具体的にデザイナーにどのような処理を記載すればよいのか、コードとしてどのような記載を行えばよいのかといった支援は、スクリプト代行と同等となりますため、ロジックアプリ観点、アクセス パッケージ観点の双方でも案内が難しいことが考えられます。「ユーザーを取得したいが、利用する Microsoft Graph API はどれか？」といったご質問であれば対応可能です。</li></ul><p>可能な限り本ブログで機能については解説いたしておりますが、基本的には <a href="https://learn.microsoft.com/ja-jp/entra/id-governance/entitlement-management-logic-apps-integration">エンタイトルメント管理でカスタム拡張機能を使用して Logic Apps をトリガーする</a> を参考いただき、まずはお客様側で実装いただけますと幸いです。</p><h2 id="実際の構成例"><a href="#実際の構成例" class="headerlink" title="実際の構成例"></a>実際の構成例</h2><p>アクセス パッケージを割り当てた時に追加で実施したいタスクとして、「割り当てられたユーザーのプロパティ変更」や「割り当てられたユーザーへの E メール送信」などが挙げられます。今回は、アクセス パッケージが割り当てられたら「割り当てられたユーザーの部署 (department 属性) および ExtenrionAttribute1 属性を変更する」、「変更された旨と、パッケージ内のリソース リンクをユーザーに E メール通知する」といった拡張機能を実装してみたいと思います。手順は大きく分けて 4 つあります。</p><ol><li>カタログにカスタム拡張機能を追加し、ロジック アプリを作成する</li><li>カスタム拡張機能をアクセス パッケージに紐づける</li><li>マネージド ID を用意し、権限を付与する</li><li>ロジック アプリ内でどのような操作をするか記載する</li></ol><p>順に以下に案内しておりますが、手順は下記公開情報と同様になりますので、併せて参考となれば幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/entra/id-governance/entitlement-management-logic-apps-integration">エンタイトルメント管理でカスタム拡張機能を使用して Logic Apps をトリガーする</a></p><h3 id="1-カタログにカスタム拡張機能を追加しロジック-アプリを作成する"><a href="#1-カタログにカスタム拡張機能を追加しロジック-アプリを作成する" class="headerlink" title="1. カタログにカスタム拡張機能を追加しロジック アプリを作成する"></a>1. カタログにカスタム拡張機能を追加しロジック アプリを作成する</h3><ol><li><p>Azure ポータルにサインインし、[Azure Active Directory] - [Identity Governance] - [カタログ] - [新しいカタログ] よりカタログを作成します。名前と説明を入力し、作成ください。カタログはアクセス パッケージに含めることが出来るリソース (グループ、アプリケーション、SPO サイト) を纏めるために利用します。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension5.png"></p></li><li><p>作成したカタログについて、メニューから [カスタム拡張機能] を選択し [カスタム拡張機能の追加] をクリックします。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension6.png"></p></li><li><p>カスタム拡張機能に名前と説明を付けます。どのようなカスタム タスクが実行されるかを説明に記載しておくと分かりやすいです。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension7.png"></p></li><li><p>アクセス パッケージにこの拡張機能を紐づける時、どのようなタイミングでトリガーされるかを指定します。今回は「要求ワークフロー」を指定します。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension8.png"></p></li><li><p>ロジック アプリの実行中に、アクセス パッケージの割り当て処理などを一時停止するかを指定します。今回は department 属性を正しく変更し E メールが送信できたら処理を再度開始したいので、「起動して待機」を指定します。待機時間などは既定値のままですが、任意に変更できます。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension9.png"></p></li><li><p>このカスタム拡張機能に紐づけるロジック アプリを作成します。サブスクリプションとリソース グループを選択し、ロジック アプリの名前を指定して、「ロジック アプリの作成」をクリックします。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension10.png"></p></li><li><p>ロジック アプリのデプロイが完了するのを待機します。以下のように成功メッセージが表示されれば次へ進みます。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension11.png"></p></li><li><p>最終確認画面で作成をクリックすれば完了です。</p></li><li><p>下記のように、一覧に表示されていることを確認します。</p><p> <img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension12.png"></p></li></ol><h3 id="2-カスタム拡張機能をアクセス-パッケージに紐づける"><a href="#2-カスタム拡張機能をアクセス-パッケージに紐づける" class="headerlink" title="2. カスタム拡張機能をアクセス パッケージに紐づける"></a>2. カスタム拡張機能をアクセス パッケージに紐づける</h3><p>既存のパッケージ ポリシーを開き、上記で作成したカスタム拡張機能を紐づけます。具体的には、ポリシーの作成/編集画面において、ステージ (いつ実行するか) とカスタム拡張機能 (何を実行するか) を指定します。今回は、「割り当てが付与されたときに customextension1 というタスクを実行する」ようにしました。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension13.png"></p><h3 id="3-マネージド-ID-を用意し権限を付与する"><a href="#3-マネージド-ID-を用意し権限を付与する" class="headerlink" title="3. マネージド ID を用意し権限を付与する"></a>3. マネージド ID を用意し権限を付与する</h3><p>今回のロジック アプリでは「割り当てられたユーザーの部署 (department 属性) および ExtenrionAttribute1 属性を変更する」、「変更された旨と、パッケージ内のリソース リンクをユーザーに E メール通知する」という 2 つのタスクを Microsoft Graph API を利用して実現します。呼び出されたロジック アプリで Graph API クエリを実行するためには、ロジック アプリ内で認証を構成する必要があります。Microsoft Entra ID にアプリを作成してクライアント シークレットなどを利用して認証を行うこともできますが、今回はマネージド ID を利用する方法を紹介します。</p><p>上記で作成されたロジック アプリにアクセスし、 ID を開くと、マネージド ID の状態が表示されます。既定ではオフになっています。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension14.png"></p><p>オンに変更すると、以下のメッセージが表示されるので「はい」を選択します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension15.png"></p><p>システム割り当てマネージド ID が有効化されたことを確認します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension16.png"></p><p>有効になると、マネージド ID のオブジェクト ID が表示されるので確認し、ID を控えます。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension17.png"></p><p>Microsoft Entra ID - [エンタープライズ アプリケーション] を開き、「アプリケーションの種類」フィルターを “マネージド ID” にしたうえで先ほどの ID を入力し、アプリがあることを確認します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension18.png"></p><p>グローバル管理者の権限で PowerShell を開き、以下のコマンドを実行して マネージド ID に Graph API の権限を付与します。実際にこのマネージド ID でどのような操作を行わせたいかによって、付与する権限は変わりますが、今回はユーザーのプロパティ更新と E メールの送付をしたいので、ここではそれぞれ必要となる権限である Directory.ReadWrite.All と Mail.Send を付与します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># グローバル管理者でサインインします。</span></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scopes</span> <span class="string">&quot;Application.Read.All&quot;</span>,<span class="string">&quot;AppRoleAssignment.ReadWrite.All&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$graph</span>= <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-Filter</span> <span class="string">&quot;AppId eq &#x27;00000003-0000-0000-c000-000000000000&#x27;&quot;</span></span><br><span class="line"><span class="variable">$directoryReadWritePermission</span>= <span class="variable">$graph</span>.AppRoles | <span class="built_in">Where-Object</span> Value <span class="operator">-eq</span> <span class="string">&quot;Directory.ReadWrite.All&quot;</span>| <span class="built_in">Where-Object</span> AllowedMemberTypes <span class="operator">-contains</span> <span class="string">&#x27;Application&#x27;</span> | <span class="built_in">Select-Object</span> <span class="literal">-First</span> <span class="number">1</span></span><br><span class="line"><span class="variable">$mailSendPermission</span> = <span class="variable">$graph</span>.AppRoles | <span class="built_in">Where-Object</span> Value <span class="operator">-eq</span> <span class="string">&quot;Mail.Send&quot;</span> | <span class="built_in">Where-Object</span> AllowedMemberTypes <span class="operator">-contains</span> <span class="string">&#x27;Application&#x27;</span> | <span class="built_in">Select-Object</span> <span class="literal">-First</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上の手順で確認したマネージド ID の Object ID を以下の &lt;ObjectID&gt; 部分に代入します。</span></span><br><span class="line"><span class="variable">$msi</span>= <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-ServicePrincipalId</span> &lt;ObjectID&gt; </span><br><span class="line"></span><br><span class="line"><span class="built_in">New-MgServicePrincipalAppRoleAssignedTo</span> <span class="literal">-ServicePrincipalId</span> <span class="variable">$graph</span>.Id <span class="literal">-AppRoleId</span> <span class="variable">$directoryReadWritePermission</span>.Id <span class="literal">-ResourceId</span> <span class="variable">$graph</span>.Id <span class="literal">-PrincipalId</span> <span class="variable">$msi</span>.Id</span><br><span class="line"><span class="built_in">New-MgServicePrincipalAppRoleAssignedTo</span> <span class="literal">-ServicePrincipalId</span> <span class="variable">$graph</span>.Id <span class="literal">-AppRoleId</span> <span class="variable">$mailSendPermission</span>.Id <span class="literal">-ResourceId</span> <span class="variable">$graph</span>.Id <span class="literal">-PrincipalId</span> <span class="variable">$msi</span>.Id</span><br></pre></td></tr></table></figure><p>マネージド ID に権限が割り当てられると、以下のように [アクセス許可] タブに権限が表示されますので確認します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension19.png"></p><p>次に、ユーザー管理者ロールをマネージド ID に付与しておきます。Microsoft Entra ID の [ロールと管理者] から「ユーザー管理者」ロールを検索します (ユーザーの属性を編集するために本ロールが必要なためです)。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension20.png"></p><p>メンバーの選択の項目をクリックし、マネージド ID と同じ名前のアプリケーションを選択します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension21.png"></p><p>アプリケーションのロール割り当てに関しては、アクティブな割り当てのみがサポートされています。この警告は気にせずに先に進んで問題ありません。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension22.png"></p><p>アクティブが選択されていることを確認のうえ、ロールを付与します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension23.png"></p><h3 id="4-ロジック-アプリ内でどのような操作をするか記載する"><a href="#4-ロジック-アプリ内でどのような操作をするか記載する" class="headerlink" title="4. ロジック アプリ内でどのような操作をするか記載する"></a>4. ロジック アプリ内でどのような操作をするか記載する</h3><p>上記までできたら、実際にロジック アプリで、カスタム拡張機能が呼び出されたときにどうするかを記載していきます。</p><ol><li>Identity Governance - カタログ - 該当のカタログを選択 - カスタム拡張機能より、以下の画面を開きます。</li><li>以下のように「ロジック アプリ」列がリンクになっているので、以下の例では Governance_ExtensionApp1 のリンクをクリックします。</li></ol><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension24.png"></p><ol start="3"><li>以下のような画面が開きます。既定の設定はそのままにします。</li></ol><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension25.png"></p><ol start="4"><li>表示されているステップの間の矢印の上にあるプラス ボタンをクリックし、[アクションの追加] をクリックします。</li></ol><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension26.png"></p><ol start="5"><li>追加できるアクションの数々が表示されるので各処理を記述していきます。</li></ol><p>今回は以下のようなアクションを追加していきます。</p><ol><li>アクセス パッケージから渡された情報をもとに変数に格納</li><li>ユーザーの情報を取得</li><li>ユーザーの部署 (department) 属性と ExtensionAttribute1 の属性を更新する</li><li>メールの送付先となるアドレスを準備する</li><li>パッケージ内のリソース リンクをユーザーにメール通知する</li></ol><h4 id="1-アクセス-パッケージから渡された情報をもとに変数に格納"><a href="#1-アクセス-パッケージから渡された情報をもとに変数に格納" class="headerlink" title="1. アクセス パッケージから渡された情報をもとに変数に格納"></a>1. アクセス パッケージから渡された情報をもとに変数に格納</h4><p>アクセス パッケージから渡された情報が triggerBody の中に含まれています。渡された情報の中の、「パッケージが割り当てられたターゲットの ObjectID」を取得すると、割り当てられたユーザーを特定することができます。そこで、ここではまず $userID という変数に「パッケージが割り当てられたターゲットの ObjectID」を代入しています。アクセス パッケージの割り当て情報の中の Target 内 ObjectID に記載されているという点を示すために、値にあたる部分は動的なコンテンツとして記載します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension28.png"></p><p>動的なコンテンツの追加は、値のボックスをクリックしたときに表示される選択肢の中から以下を選ぶと、上のように埋め込むことができます。式としては、triggerBody()?[‘Assignment’]?[‘Target’]?[‘ObjectId’] となります。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension29.png"></p><h4 id="2-ユーザーの情報を取得"><a href="#2-ユーザーの情報を取得" class="headerlink" title="2. ユーザーの情報を取得"></a>2. ユーザーの情報を取得</h4><p>ユーザーの情報を取得するためには、 <a href="https://learn.microsoft.com/ja-jp/graph/api/user-get?view=graph-rest-1.0&tabs=http">ユーザーの取得 - Microsoft Graph v1.0</a> を使用します。アクセス パッケージが割り当てられたユーザーの情報は、先ほど $userID 属性に格納したので、以下のように記載します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension30.png"></p><p>また、 Add new parameter を開き、認証のチェックをオンにします。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension31.png"></p><p>先ほど事前にマネージド ID を構成し権限を割り当てたので、以下のように、システム割り当てマネージド ID を選択します。対象ユーザーの項目には、<a href="https://graph.microsoft.com/">https://graph.microsoft.com</a> を入力してください。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension32.png"></p><h4 id="3-ユーザーの部署-department-属性と-ExtensionAttribute1-の属性を更新する"><a href="#3-ユーザーの部署-department-属性と-ExtensionAttribute1-の属性を更新する" class="headerlink" title="3. ユーザーの部署 (department) 属性と ExtensionAttribute1 の属性を更新する"></a>3. ユーザーの部署 (department) 属性と ExtensionAttribute1 の属性を更新する</h4><p>次に、もう一つ HTTP アクションを追加し、ユーザーを更新するための API を記載します。更新するユーザー情報は、 $userID の変数から利用します。具体的な更新 API は <a href="https://learn.microsoft.com/ja-jp/graph/api/user-update?view=graph-rest-1.0&tabs=http">ユーザーを更新する - Microsoft Graph v1.0</a> に記載がありますので、こちらをもとに必要な情報を埋めていきます。例えば本文内に、「どの部署名に更新したいのか」部署の名前を指定しておきます。今回は、IT という部署に移動したいので以下のように記載します。なお、上記と同様に「認証」のチェックを有効化し、マネージド ID を指定ください。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension33.png"></p><h4 id="4-メールの送付先となるアドレスを準備する"><a href="#4-メールの送付先となるアドレスを準備する" class="headerlink" title="4. メールの送付先となるアドレスを準備する"></a>4. メールの送付先となるアドレスを準備する</h4><p>最後に、E メールをユーザー本人に送付したいので、$mail という変数を作り、事前に取得したユーザー情報の中から Mail 属性の値を取得して格納します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension34.png"></p><p>アクセス パッケージの割り当てによって初めて E メールボックスが作成される場合、アクセス パッケージ割り当て直後にメールを送付するとエラーになる可能性が考えられるため、10 分ほど待機するフローを挿入します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension35.png"></p><p>E メールの送付元となるユーザーを $MailSender という変数に定義します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension36.png"></p><h4 id="5-パッケージ内のリソース-リンクをユーザーにメール通知する"><a href="#5-パッケージ内のリソース-リンクをユーザーにメール通知する" class="headerlink" title="5. パッケージ内のリソース リンクをユーザーにメール通知する"></a>5. パッケージ内のリソース リンクをユーザーにメール通知する</h4><p>E メールの送付は <a href="https://learn.microsoft.com/ja-jp/graph/api/user-sendmail?view=graph-rest-1.0&tabs=http">user: sendMail - Microsoft Graph v1.0</a> の API で実行できますので、以下のように実行します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension37.png"></p><p>本文は以下のように記載し、受信者 (toRecipients) のアドレスに送信先となる $mail を指定します。ここでアクセス パッケージで割り当てたリソース (グループ、アプリケーション、SPO サイト) のリンク先も記載しておきます。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension38.png"></p><p>先に記載した HTTP と同様に、認証のチェックをオンに変更し、マネージド ID を指定します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension39.png"></p><p>本文の記載が少々見にくいかと思いますので、以下が参考となりますと幸いです。</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;message&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;content&quot;</span>: <span class="string">&quot;IT 部門へようこそ！\n 異動処理と権限の付与が完了しましたので、メールでお知らせします。\n IT 部門用のチームやSPO サイトが用意されていますので、下記リンクよりアクセスできるか確認してください。\n\n ▼ IT 部門のページ\n SPO サイト\n &#x27;SPO サイトのリンク&#x27; \n\n  チーム\n &#x27;チームのリンク&#x27; \n\n もしアクセスできない場合は、CC に記載されているアドレス宛にメールにてご連絡ください。\n&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;contentType&quot;</span>: <span class="string">&quot;Text&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;ccRecipients&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;emailAddress&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;admin@contoso.onmicrosoft.com&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;subject&quot;</span>: <span class="string">&quot;IT 部門へようこそ！&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;toRecipients&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;emailAddress&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;user@contoso.onmicrosoft.com&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;saveToSentItems&quot;</span>: <span class="string">&quot;false&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ちなみに、ロジック アプリの記載においては、デバッグやトラブル シューティングをしながら進めることが多いと思います。ロジック アプリの概要画面を確認すると、成功もしくは失敗の一覧が表示されているので、処理状況の確認が可能です。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension40.png"></p><p>失敗のログをクリックすると、処理のどこでエラーになったのかも分かります。そのため、たとえば以下の場合だと、 HTTP 3 のアクションを見直せばよいことが分かります。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension41.png"></p><p>必要に応じて、<a href="https://jpazinteg.github.io/blog/LogicApps/Integration-graphApi/">Logic Apps 観点のブログ</a> もご確認ください。</p><h3 id="実際の動作"><a href="#実際の動作" class="headerlink" title="実際の動作"></a>実際の動作</h3><p>ユーザーにアクセス パッケージのリンクへアクセスしてもらいます。要求ポリシーが複数ある場合はどちらか選択します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension42.png"></p><p>必要に応じて、期間や理由を記載のうえパッケージを要求します。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension43.png"></p><p>ポリシーの内容にもよりますが、承認などを経てパッケージが割り当てられます。割り当てられると「割り当て」画面にユーザーが表示されます。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension44.png"></p><p>パッケージが割り当てられたので、カスタム タスクが発動します。ユーザーの属性が変更されるなどし、最後に以下のような E メールが送付されます。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension45.png"></p><p>実行履歴を確認すると、すべて成功しているかどうかなどを確認いただけます。</p><p><img src="/blog/azure-active-directory/access-package-with-custom-extension/access-package-with-custom-extension46.png"></p><p>今回は、アクセス パッケージとカスタム拡張機能を利用したサンプルについて紹介しました。上記内容を参考とし、お客様側のご要件およびご要望に合うカスタム拡張機能を実装いただければ幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは！ Azure ID チームの小出です。&lt;/p&gt;
&lt;p&gt;今回は、Microsoft Entra ID のエンタイトルメント管理 (アクセス パッケージ) の機能をより活用できる、カスタム拡張機能について紹介します。&lt;/p&gt;
&lt;p&gt;今回の記事は、アクセス パッケージ</summary>
      
    
    
    
    
    <category term="Entitlement Management" scheme="https://jpazureid.github.io/blog/tags/Entitlement-Management/"/>
    
    <category term="Access Package" scheme="https://jpazureid.github.io/blog/tags/Access-Package/"/>
    
  </entry>
  
  <entry>
    <title>条件を利用した Azure RBAC のロール割り当て</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/rbac-role-assignment-using-conditions/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/rbac-role-assignment-using-conditions/</id>
    <published>2023-11-26T00:00:00.000Z</published>
    <updated>2024-03-15T02:00:17.615Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure ID チームの小出です。</p><p>本記事は、2023 年 10 月 25 日に公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/delegate-azure-role-assignment-management-using-conditions/ba-p/3954216">Delegate Azure role assignment management using conditions</a> をもとに、日本語に分かりやすくおまとめした記事となります。ご不明点などございましたら、お気軽にサポートまでお問い合わせください。</p><hr><p>今回、 Azure ロールを割り当てる時に条件を指定する機能がパブリック プレビューとして公開されました。</p><p>これまでは、他の人にロールを割り当て可能な権限を委譲する際は、所有者もしくはユーザー アクセス管理者のロールを割り当てる必要がありました。具体的には、例えばこの記事を読んでいらっしゃる皆様がサブスクリプションの所有者を持っていると仮定して、社内の開発者から「開発で利用したいのでサブスクリプションのロールを他の人に割り当てる権限が欲しい」という要望をいただいたとします。このとき、これまでサブスクリプションの所有者として社内の開発者にできることとしては、「開発者に、所有者もしくはユーザー アクセス管理者を付与する」という操作でした。</p><p>しかし、開発者に所有者もしくはユーザー アクセス管理者を付与をしてしまうと、開発者が以下のようなこともできてしまいます。これは開発者に付与するには大きすぎる権限です。</p><ul><li>所有者となった場合、サブスクリプションを削除したり、開発に関係のないリソースを変更したりできる</li><li>いずれのロールの場合も、自身に追加でロールを割り当てて権限を昇格することができる</li></ul><p>一方で、開発者から依頼があったときだけロールを付与する形にすると、スムーズな開発を妨げたり、承認フローで余計な時間がかかったりということとなります。</p><p>今回のパブリック プレビューでは、特定の条件を指定してロールの割り当てを作成する権限を付与できるようになりました。具体的には以下の 2 つの方法がありますので、それぞれ案内します。 </p><ul><li>条件を利用して制約されたロールを割り当てる</li><li>条件を組み込んだ新しい組み込みロールを作成する</li></ul><h2 id="条件を使用してロールの割り当て管理を委任する方法"><a href="#条件を使用してロールの割り当て管理を委任する方法" class="headerlink" title="条件を使用してロールの割り当て管理を委任する方法"></a>条件を使用してロールの割り当て管理を委任する方法</h2><p>この方法は、アクセス許可を委任するユーザーに対し、ロールが利用できる条件を細かく指定するものです。例えば、以下の Alice という管理者は、ユーザー アクセス管理者を持っていますので、誰に対してもロールを割り当てられます。今回、Dara というユーザーに、ロール割り当て操作を委任することにしましたが、Alice が持っているユーザー アクセス管理者ロールのように、誰にでも自由にロールを割り当てられる構成にはしたくありません。</p><p>この時に今回の「条件を利用した Azure RBAC のロール割り当て」が活用できます。今回 Alice は Dara に対し、以下の条件を付けて「Role Based Access Control Administrator (Preview)」というロールを付与しました。</p><ul><li>AcrPull と AcrPush ロールは付与してもよいが、その他のロールは他のユーザーに付与できない</li><li>ユーザーやグループに対してはロールを付与できないが、サービス プリンシパルになら付与できる</li></ul><p>すると、Dara は ① のようにサービス プリンシパルに対して、 AcrPull や AcrPush のロールを付与することができます。一方、② や ③ では、ユーザーに対してロールを付与しようとしているため、条件に合わず割り当てができません。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions1.png"></p><p>Role Based Access Control Administrator (Preview) の付与方法は下記のとおりです。この操作を行うのは上記画面例ですと Alice になります。</p><ol><li><p>サブスクリプション - アクセス制御（IAM） - 役割の画面を開き、ロール名を検索します。ポータルが日本語の場合でも、現時点ではロール名は英語のため、英語で検索ください。下記のように、ロールが表示されていることを確認します。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions2.png"></p></li><li><p>上記画面の [追加] - [ロールの割り当ての追加] をクリックし、割り当ての追加画面を開きます。</p></li><li><p>下記の画面が表示されるので、 [特権管理者ロール] のメニューを選択のうえロール名を検索し、クリックします。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions3.png"></p></li><li><p>このロールを割り当てたいユーザー（上記画面例ですと Dara にあたるユーザー）を指定します。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions4.png"></p></li><li><p>次の画面に進み、委任の種類が “制約あり (おすすめ)” となっていることを確認します。さらに、その下にある「条件を追加する」をクリックします。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions5.png"></p></li><li><p>下記の画面が表示されるので、追加したい条件によって選択します。今回は、ロールとプリンシパルのタイプを指定したいので、真ん中を指定します。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions6.png"></p></li><li><p>右側に下記のような画面が表示されるので、許可してもよいロールやプリンシパルを指定します。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions7.png"></p></li><li><p>選択が完了すると、下記のように「構成済み」となる点を確認します。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions8.png"></p></li><li><p>下記画面にて最終確認を行い、ロールの割り当てを実施すれば完了です。</p><p> <img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions9.png"></p></li></ol><h2 id="条件を組み込んだ新しい組み込みロールを使用してロールの割り当て管理を委任する方法"><a href="#条件を組み込んだ新しい組み込みロールを使用してロールの割り当て管理を委任する方法" class="headerlink" title="条件を組み込んだ新しい組み込みロールを使用してロールの割り当て管理を委任する方法"></a>条件を組み込んだ新しい組み込みロールを使用してロールの割り当て管理を委任する方法</h2><p>この方法は、新しく利用できるようになった組み込みロールを使う方法です。具体的には、Virtual Machine Data Access Administrator (preview) というロールや、Key Vault Data Access Administrator (preview) というロールが利用できるようになりました。こちらのロールを利用することで、関連するロールのみをユーザーに割り当てることができるようになります。</p><p>具体的に以下の図のとおりに説明いたしますと、Virtual Machine Data Access Administrator (preview) が割り当てられたユーザー Dara は、② や ③ のように、仮想マシンの管理者ログイン ロールや、仮想マシンのユーザー ログイン ロールを付与することができます。一方、① のように仮想マシンのアクセスに関連のないロールについては付与できないため、① の割り当ては失敗します。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions10.png"></p><p>割り当て方法は通常のロール割り当てと同様で、ロール割り当て画面で上記 2 つのロールのいずれかを指定する形になります。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions11.png"></p><p>ロールを割り当てるユーザー（上記例ですと Dara にあたるユーザー）を指定してロールを割り当てます。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions12.png"></p><p>もし、割り当て可能なプリンシパルを制限したい場合は、先の例と同様に条件を指定することも可能です。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions13.png"></p><p>条件を使用した場合は、下記のように構成済みと表示されているかを確認し、割り当てを完了します。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions14.png"></p><p>Data Access Administrator という文字列が含まれているロールには、既定で条件が組み込まれています。下記のように、ロールのアクセス許可を確認する画面で JSON タブを開き、condition と記載されている部分を確認すれば条件を確認可能です。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions15.png"></p><p>今後、一般的なシナリオを想定して、条件を組み込んだロールを追加していく予定です。簡単なロールの割り当てでリソースの管理ができるようになりますので、今後のアップデートをお待ちください。詳細につきましては、 <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/delegate-role-assignments-examples?tabs=template">条件 (プレビュー) を使用して Azure ロールの割り当てを委任する例</a> の公開情報も参考となりますと幸いです。</p><p>本機能に関するフィードバックにつきましては、下記画面の右上にございます「フィードバック」から承っております。お客様のご意見・ご要望をお待ちいたしております。</p><p><img src="/blog/azure-active-directory/rbac-role-assignment-using-conditions/rbac-role-assignment-using-conditions16.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは！ Azure ID チームの小出です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 10 月 25 日に公開された &lt;a href=&quot;https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blo</summary>
      
    
    
    
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
</feed>
