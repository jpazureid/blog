---
title: Web アプリケーションの SSO の解説とよくある質問
date: 2023-10-11
tags:
  - Azure AD
  - SSO
---

こんにちは、Azure Identity サポートの沓澤です。

今回は、Web アプリケーションのシングル サインオン (SSO) の解説と SSO に関してよくある質問をまとめました。

SSO の仕組みの理解は、条件付きアクセスの重要性の理解や OpenID Connect や SAML などの属性連携のためのプロトコルの概観の理解にも役立ちますため、条件付きアクセス ポリシーの作成や OpenID Connect/SAML での SSO の構成等をされる方はご一読をいただけますと幸いです。

## シングル サインオン (SSO) とは

SSO とは、 "Microsoft Entra ID とのセッションの確立のために資格情報を 1 度入力するだけで複数の Web アプリケーションともセッションを確立できるようになる仕組み"です。

プライマリ更新トークンが使用される場合や、パスワードレス認証を使用される場合は資格情報の入力自体が発生しませんが、本記事ではシンプルに UPN とパスワードを使って Microsoft Entra 認証をすることを想定します。


SSO を平たく言うと、"Microsoft Entra ID アカウントで Microsoft Entra 認証が完了していれば複数の Web アプリケーションにサインインできる仕組み"ではありますが、本記事では平たく理解していた読者が上述の理解に進むまでの手助けができればと思います。

## はじめに: Web アプリケーションにサインインした状態になるには

まずは Microsoft Entra ID を使用せず、独自にサインイン機能を実装している Web アプリケーションへのサインインについて説明します。

一般的に、Web アプリケーションにアクセスし、ユーザー名およびパスワードを入力し、その組み合わせが正しい場合に、Web アプリケーションから Cookie が発行されます。

その Cookie がユーザーのブラウザーに保存されることで、Web アプリケーションにサインイン済みの状態として扱われます (下図参照)。

![1](./web_sso/1.png)

## IdP と SSO を構成済みの Web アプリケーションにサインインした状態になるには

次に IdP (Microsoft Entra ID) と SSO を構成し Web アプリケーションにサインインをする場合について説明します。

おおよその流れを下図に示します。
![2](./web_sso/2.png)

上図にて、`Web App 1` でサインイン ボタンなどを押して以降の SSO の流れは以下です。
1. `Web App 1` が認証要求を `User's Browser` を介して `Microsoft Entra ID` に送ります。
1. `User's Browser` に資格情報を入力する画面が表示されユーザーは資格情報を入力します。資格情報が正しければ `Microsoft Entra ID` での認証が完了したことを示す Cookie が発行されます。この Cookie 群は Microsoft Entra ID ではセッション トークンと呼ばれます。
1. `Microsoft Entra ID` から `Web App 1` にトークンが発行されます。このトークンの形式は SSO の方式 (OpenID Connect, SAML) に依存します。
1. トークンを受け取った `Web App 1` が認証完了を示す Cookie を発行します。

これにより、前項と同様に Web アプリケーションから認証完了を示す Cookie が発行されたため、Web アプリケーションにサインインが完了した状況となります。

## 他の SSO 構成済みの Web アプリケーションにサインインした状態になるには

前項では、`Web App 1` にサインインする場合について説明しましたが、他の Web アプリケーション (`Web App 2`) にもサインインする場合はどうなるでしょうか。

おおよその流れを下図に示します。
![3](./web_sso/3.png)

`Web App 2` にサインインをする前の状態では、`User's Browser` には以下 2 つの Cookie 群が存在します。
- `Microsoft Entra ID` から発行された認証完了を示す Cookie 群 (セッション トークン)
- `Web App 1` から発行された Cookie 群

セッション トークンを所持しているため、今回は `Microsoft Entra ID` に対して資格情報の入力は要求されません。

上記を踏まえ、流れを説明します。
1. `Web App 2` が認証要求を `User's Browser` を介して `Microsoft Entra ID` に送ります。
1. `Microsoft Entra ID` から資格情報の入力は要求されず、`Web App 2` にトークンが発行されます。
1. トークンを受け取った `Web App 2` が認証完了を示す Cookie を発行します。
上述のように、`Microsoft Entra ID` が発行したセッション トークンを所持していることで、資格情報を入力することなく、`Web App 2` へのサインインが完了します。

## SSO の動作のまとめ

`Web App 1` と `Web App 2` との両方に言えますが、`Microsoft Entra ID` が発行したセッション トークンを所持していれば、認証済みを示す Cookie の発行がされる動作をします。

仮に `Web App 3` へサインインをする場合も、`Microsoft Entra ID` が発行したセッション トークンを所持していれば、資格情報を入力することなくサインインに成功することが想定されます。

このように Microsoft Entra ID とのセッションの確立のために資格情報を 1 度入力しさえすれば、複数の Web アプリケーションともセッションを確立できます (サインインできます)。

## よくある質問

これまでの説明を踏まえよくある質問とその回答をまとめます。

### Q1. Microsoft Entra ID との SSO を構成済みの Web アプリケーション (Web App 1) にサインインできるのは MFA を完了したユーザーに限定したいですが可能ですか?

可能です。

Microsoft Entra ID が Web App 1 へのトークンを発行する際にはセッション トークンの中身を確認します。

セッション トークンには MFA の完了状況が含まれているため、MFA を完了していないユーザーにはトークンを発行しません。

MFA を完了している場合にはセッション トークンに MFA の完了状況が含まれているため、Microsoft Entra ID が Web App 1 へのトークンを発行します。

条件付きアクセスでトークン発行のための条件を厳しくする (より信頼度の高いセッション トークンを必要とする) ことで、Web App 1 のセキュリティ強度を高めることに繋がります。

### Q2. OpenID Connect に対応したアプリケーション (OIDC アプリ) にサインインしたあとに、SAML に対応したアプリケーション (SAML アプリ) にサインインする場合も資格情報の入力は求められないですか?

基本的には求められません。
例外としては、SAML アプリでは SAML リクエストに [ForceAuthn](https://learn.microsoft.com/ja-jp/azure/active-directory/develop/single-sign-on-saml-protocol#authnrequest) 要素を true として含めた場合や、OIDC アプリで認可コード要求時に [prompt=login](https://learn.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-auth-code-flow#request-an-authorization-code) を指定した場合には資格情報の入力が求められます。

OIDC アプリと SAML アプリとのどちらにサインインするときにも、Microsoft Entra ID が発行したセッション トークンを所持していれば、資格情報を入力することなくサインインに成功することが想定されます。

### Q3. ブラウザーから Web アプリケーションにサインインするときには資格情報の入力は求められないですが、デスクトップ アプリケーションにサインインするときには資格情報の入力が求められます。これはなぜですか?

ブラウザーとデスクトップ アプリケーションで Cookie を共有していないため、ブラウザー上でセッション トークンを所持しているものの、デスクトップ アプリケーション上ではセッション トークンを所持していないことなどが原因として考えられます。

Cookie はブラウザーのプロファイルごとに保存されますため、例えばブラウザー A で 1 度資格情報を入力したにも関わらず、ブラウザー B で再度資格情報の入力を要求されるという場合も同様の原因が考えられます。

### Q4. Microsoft Entra ID 上の操作で、SSO 構成済みの Web アプリケーション (Web App 1) からサインアウトさせることは可能ですか?

出来ません。

Microsoft Entra ID からセッション トークンの失効はできますが、あくまで Web App 1 にサインイン済みという状態は Web App 1 が発行する認証済みを示す Cookie により管理されます ("はじめに: Web アプリケーションにサインインした状態になるには" を参照)。

セッション トークンを失効した場合には、Microsoft Entra ID が発行した認証済みを示す Cookie 群 (セッション トークン) は失効されますが、Web App 1 が発行した Cookie 群には特に影響を及ぼしません (イメージとして下図参照)。
![4](./web_sso/4.png)

ただ、セッション トークンが失効するため、次に Web App 1 が Microsoft Entra ID に認証要求を送った際には、資格情報の再入力が要求されることが想定されます。

セッション トークンの失効後、どのタイミングで Web App 1 が Microsoft Entra ID に認証要求を送るかは Web App 1 の実装に依存しますので、Microsoft Entra ID 観点では回答が難しいことをご了承ください。

### Q5. 特定の Web アプリケーション (Web App 1) からサインアウトすることで、他の Web アプリケーション (Web App 2) からもサインアウトさせることは可能ですか (SSO の逆は可能ですか)?

Web App 1 および Web App 2 がシングル サインアウトに対応していれば可能です。

シングル サインアウトの方法は SSO の方式 (OpenID Connect, SAML) に依存します。

Microsoft Entra ID 観点では各アプリケーションのシングル サインアウトへの対応状況は把握できないため、Web App 1 および Web App 2 がサードパーティのアプリケーションである場合には、アプリケーション ベンダーにシングル サインアウトの対応状況をご確認ください。

自社開発されているアプリケーションをシングル サインアウトに対応させたいという場合には以下公開情報をご確認くださいませ。
- [OpenID Connect のシングル サインアウト](https://learn.microsoft.com/ja-jp/azure/active-directory/develop/v2-protocols-oidc#single-sign-out)
- [SAML のシングルサインアウト](https://learn.microsoft.com/ja-jp/azure/active-directory/develop/single-sign-out-saml-protocol)

SAML のシングル サインアウトについては、OpenID Connect のシングルサインアウトよりも難しいこともあり、OpenID Connect のシングル サインアウトに比べ多くのお問い合わせをいただいております。

しかし、大変恐縮ではございますが、上記公開情報以上の情報のご案内が難しく、具体的な実装方法や公開情報以上の内容についてはお客様でのご調査をお願いしております。

また、弊社のファーストパーティ アプリがシングル サインアウトに対応しているかというご質問も稀にいただきます。
正確な回答にはご質問の対象のファーストパーティ アプリ観点での調査を必要とし、時間を要することが見込まれます。

そのため、まずは [Microsoft Entra 管理ポータル](https://entra.microsoft.com/) からのサインアウトをお試しいただけますと幸いです。
Microsoft Entra 管理ポータルは OpenID Connect のシングル サインアウトに則ってサインアウトをしますため、もし調査対象のファーストパーティ アプリがシングル サインアウトに対応している場合には、ファーストパーティ アプリからもサインアウトされることが想定されます。

## おわりに

本記事では SSO 構成済みの Web アプリケーションへのサインインの動作を説明しました。
作図に時間を要しましたが、読者の皆様の SSO への理解が少しでも深まりましたら幸いです。
